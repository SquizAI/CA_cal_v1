<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - AI Academy @ Centner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Side Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 280px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(0);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 1.2em;
            font-weight: 700;
        }

        .sidebar-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .sidebar-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .sidebar-section {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-section-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .course-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .course-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .course-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .course-item.active {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
        }

        .course-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .course-icon {
            font-size: 1.3em;
        }

        .course-name {
            flex: 1;
            font-weight: 600;
            font-size: 0.95em;
        }

        .course-progress {
            margin-top: 8px;
        }

        .course-progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .course-progress-fill {
            height: 100%;
            background: #4ade80;
            transition: width 0.3s ease;
        }

        .course-progress-text {
            font-size: 0.75em;
            opacity: 0.8;
            margin-top: 4px;
        }

        .nav-menu {
            padding: 0;
        }

        .nav-menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            color: white;
            text-decoration: none;
        }

        .nav-menu-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: white;
        }

        .nav-menu-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: white;
            font-weight: 600;
        }

        .nav-menu-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .nav-menu-text {
            flex: 1;
        }

        .nav-badge {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        /* Mobile Hamburger */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 1.5em;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Main Layout Adjustments */
        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
            flex: 1;
        }

        /* Controls */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }

        select:hover {
            border-color: #667eea;
        }

        /* Calendar Navigation */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .calendar-nav h2 {
            color: #495057;
            font-size: 1.5em;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* Calendar Grid */
        .calendar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-header {
            text-align: center;
            font-weight: 700;
            color: #6c757d;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-transform: uppercase;
            font-size: 0.85em;
        }

        .calendar-day {
            min-height: 180px;
            padding: 12px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .calendar-day.other-month {
            opacity: 0.3;
            pointer-events: none;
        }

        .calendar-day.no-school {
            background: #ffe5e5;
            border-color: #ff6b6b;
        }

        .calendar-day.half-day {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .day-number {
            font-weight: 700;
            font-size: 1.2em;
            color: #495057;
            margin-bottom: 8px;
        }

        .day-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .day-type.a-day {
            background: #d4edff;
            color: #0066cc;
        }

        .day-type.b-day {
            background: #ffe5d4;
            color: #cc6600;
        }

        /* Period Sections with Separators */
        .period-sections {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .period-section {
            border-left: 3px solid #dee2e6;
            padding-left: 8px;
        }

        .lesson-override {
            border-left-color: #10b981 !important;
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
        }

        .period-label {
            font-size: 0.7em;
            font-weight: 700;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .lesson-item {
            padding: 6px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            color: white;
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Subject Colors */
        .subject-civics { background: #3B82F6; }
        .subject-ela { background: #8B5CF6; }
        .subject-math { background: #10B981; }
        .subject-science { background: #F59E0B; }
        .subject-history { background: #EF4444; }
        .subject-government { background: #3B82F6; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 35px;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #dc3545;
        }

        .modal-header {
            margin-bottom: 25px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 20px;
        }

        .modal-header h2 {
            color: #495057;
            margin-bottom: 10px;
        }

        .modal-header .day-info {
            color: #6c757d;
            font-size: 1.1em;
        }

        .period-detail {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .period-detail h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .lesson-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .lesson-card h4 {
            margin-bottom: 10px;
        }

        .lesson-card p {
            color: #6c757d;
            line-height: 1.6;
        }

        .lesson-meta {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .meta-badge {
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Beautiful Markdown Content Styling */
        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.7;
            color: #2d3748;
        }

        .markdown-content h1 {
            font-size: 2em;
            font-weight: 700;
            color: #1a202c;
            margin: 1.5em 0 0.75em 0;
            padding-bottom: 0.3em;
            border-bottom: 3px solid #4f46e5;
        }

        .markdown-content h2 {
            font-size: 1.6em;
            font-weight: 600;
            color: #2d3748;
            margin: 1.25em 0 0.6em 0;
            padding-bottom: 0.25em;
            border-bottom: 2px solid #e2e8f0;
        }

        .markdown-content h3 {
            font-size: 1.3em;
            font-weight: 600;
            color: #4a5568;
            margin: 1em 0 0.5em 0;
        }

        .markdown-content h4 {
            font-size: 1.1em;
            font-weight: 600;
            color: #718096;
            margin: 0.8em 0 0.4em 0;
        }

        .markdown-content p {
            margin: 0.75em 0;
            line-height: 1.75;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 0.75em 0;
            padding-left: 2em;
        }

        .markdown-content li {
            margin: 0.5em 0;
            line-height: 1.6;
        }

        .markdown-content ul li {
            list-style-type: disc;
        }

        .markdown-content ul ul li {
            list-style-type: circle;
        }

        .markdown-content strong {
            font-weight: 600;
            color: #1a202c;
        }

        .markdown-content em {
            font-style: italic;
            color: #4a5568;
        }

        .markdown-content code {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #d63384;
        }

        .markdown-content pre {
            background: #2d3748;
            color: #f7fafc;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .markdown-content pre code {
            background: transparent;
            border: none;
            color: #f7fafc;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #4f46e5;
            padding-left: 1em;
            margin: 1em 0;
            color: #4a5568;
            font-style: italic;
            background: #f8f9fa;
            padding: 0.75em 1em;
            border-radius: 0 4px 4px 0;
        }

        .markdown-content hr {
            border: none;
            border-top: 2px solid #e2e8f0;
            margin: 2em 0;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .markdown-content th {
            background: #4f46e5;
            color: white;
            padding: 0.75em;
            text-align: left;
            font-weight: 600;
        }

        .markdown-content td {
            padding: 0.75em;
            border: 1px solid #e2e8f0;
        }

        .markdown-content tr:nth-child(even) {
            background: #f8f9fa;
        }

        /* Progress Header */
        .progress-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .progress-stats {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .progress-bar-container {
            flex: 1;
            min-width: 200px;
            background: rgba(255,255,255,0.2);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
        }

        /* View Mode Toggle */
        .view-toggle {
            display: flex;
            gap: 10px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .view-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Completion Checkbox */
        .completion-checkbox {
            position: sticky;
            top: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }

        .completion-checkbox:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .completion-checkbox.completed {
            background: #d1fae5;
            border-color: #10b981;
        }

        .completion-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .completion-checkbox label {
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            flex: 1;
        }

        /* Day View */
        .day-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .day-view-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .day-view-header h2 {
            color: #495057;
            margin-bottom: 10px;
        }

        .day-view-periods {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .day-view-period {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .day-view-period h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .day-view-lesson {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .day-view-lesson:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .day-view-lesson.completed {
            opacity: 0.7;
            background: #f0fdf4;
            border-left: 4px solid #10b981;
        }

        /* Week View */
        .week-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .week-day {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            min-height: 300px;
        }

        .week-day-header {
            font-weight: 700;
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        /* List View */
        .list-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .list-view-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .list-view-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .list-view-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 5px solid #667eea;
        }

        .list-view-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .list-view-item.completed {
            opacity: 0.7;
            background: #f0fdf4;
            border-left-color: #10b981;
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .list-item-title {
            font-weight: 700;
            color: #495057;
            font-size: 1.1em;
        }

        .list-item-date {
            color: #6c757d;
            font-size: 0.9em;
        }

        .list-item-meta {
            display: flex;
            gap: 15px;
            color: #6c757d;
            font-size: 0.9em;
        }

        .completion-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .completion-badge.complete {
            background: #d1fae5;
            color: #047857;
        }

        .completion-badge.incomplete {
            background: #fee2e2;
            color: #991b1b;
        }

        /* New Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .dashboard-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .dashboard-card-header h3 {
            margin: 0;
            font-size: 1.3em;
            color: #2d3748;
            flex: 1;
        }

        .dashboard-card-icon {
            font-size: 2em;
        }

        /* Today's Lessons */
        .today-lesson-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .today-lesson-card:hover {
            transform: scale(1.02);
        }

        .today-lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .today-lesson-period {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .today-lesson-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .today-lesson-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }

        .today-lesson-progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .today-lesson-progress-fill {
            height: 100%;
            background: #10b981;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .lesson-objectives {
            margin: 12px 0;
            font-size: 0.9em;
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
        }

        .lesson-objectives strong {
            display: block;
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .lesson-objectives ul {
            margin: 0;
            padding-left: 20px;
        }

        .lesson-objectives li {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .lesson-assignment-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 8px 0;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .lesson-assignment-badge.assigned {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .lesson-assignment-badge.overdue {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .lesson-assignment-badge.graded {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
        }

        /* Upcoming Assignments */
        .assignment-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .assignment-item:hover {
            background: #e9ecef;
            border-left-width: 6px;
        }

        .assignment-item.due-today {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .assignment-item.due-tomorrow {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .assignment-title {
            font-weight: 600;
            color: #2d3748;
            flex: 1;
        }

        .assignment-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .assignment-badge.due-today {
            background: #dc3545;
            color: white;
        }

        .assignment-badge.due-tomorrow {
            background: #ffc107;
            color: #000;
        }

        .assignment-badge.due-week {
            background: #0ea5e9;
            color: white;
        }

        .assignment-meta {
            font-size: 0.85em;
            color: #6c757d;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Progress Cards */
        .subject-progress-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .subject-progress-name {
            flex: 1;
            font-weight: 600;
            color: #2d3748;
        }

        .subject-progress-bar-container {
            flex: 2;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .subject-progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 5px;
            transition: width 0.5s;
        }

        .subject-progress-percent {
            font-weight: 600;
            color: #10b981;
            min-width: 45px;
            text-align: right;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* My Assignments Section - New Styles */
        .assignments-section {
            margin-bottom: 30px;
        }

        .assignment-card {
            background: white;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 12px;
            border-left: 4px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .assignment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .assignment-card.status-assigned {
            border-left-color: #3b82f6;
        }

        .assignment-card.status-overdue {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .assignment-card.status-submitted {
            border-left-color: #f59e0b;
        }

        .assignment-card.status-graded {
            border-left-color: #10b981;
        }

        .assignment-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .assignment-title-group {
            flex: 1;
        }

        .assignment-card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .assignment-type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .assignment-type-badge.quiz {
            background: #dbeafe;
            color: #1e40af;
        }

        .assignment-type-badge.homework {
            background: #fef3c7;
            color: #92400e;
        }

        .assignment-type-badge.test {
            background: #fee2e2;
            color: #991b1b;
        }

        .assignment-type-badge.project {
            background: #e0e7ff;
            color: #3730a3;
        }

        .assignment-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            white-space: nowrap;
        }

        .assignment-status-badge.not-started {
            background: #eff6ff;
            color: #1e40af;
        }

        .assignment-status-badge.in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .assignment-status-badge.overdue {
            background: #fee2e2;
            color: #991b1b;
        }

        .assignment-status-badge.submitted {
            background: #fef3c7;
            color: #78350f;
        }

        .assignment-status-badge.graded {
            background: #d1fae5;
            color: #065f46;
        }

        .assignment-card-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .assignment-card-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .assignment-due-date {
            font-weight: 600;
            color: #374151;
        }

        .assignment-due-date.urgent {
            color: #dc2626;
        }

        .assignment-points {
            font-weight: 600;
        }

        .assignment-points.graded {
            color: #059669;
        }

        .assignment-action-btn {
            margin-top: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .assignment-action-btn.start {
            background: #3b82f6;
            color: white;
        }

        .assignment-action-btn.start:hover {
            background: #2563eb;
        }

        .assignment-action-btn.view {
            background: #10b981;
            color: white;
        }

        .assignment-action-btn.view:hover {
            background: #059669;
        }

        .assignment-action-btn.continue {
            background: #f59e0b;
            color: white;
        }

        .assignment-action-btn.continue:hover {
            background: #d97706;
        }

        .assignment-action-btn.secondary {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .assignment-action-btn.secondary:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .assignments-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0;
        }

        .assignments-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .assignments-tab:hover {
            color: #374151;
        }

        .assignments-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .assignments-tab .count {
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            margin-left: 6px;
        }

        .assignments-tab.active .count {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Assignment Type Filter Buttons */
        .type-filter-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #374151;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .type-filter-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .type-filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .type-filter-btn .count {
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            margin-left: 6px;
            font-weight: 700;
        }

        .type-filter-btn.active .count {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Homework Submission Modal Styles */
        .hw-modal-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .hw-modal-title {
            font-size: 1.8em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .hw-modal-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .hw-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f0f9ff;
            border-radius: 6px;
            font-size: 0.9em;
            color: #0369a1;
        }

        .hw-meta-item.due-soon {
            background: #fef3c7;
            color: #92400e;
        }

        .hw-meta-item.past-due {
            background: #fee2e2;
            color: #991b1b;
        }

        .hw-instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 25px;
        }

        .hw-instructions h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .hw-instructions p {
            color: #4a5568;
            line-height: 1.6;
            margin: 0;
        }

        .hw-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e9ecef;
        }

        .hw-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }

        .hw-tab:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .hw-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .hw-tab-content {
            display: none;
        }

        .hw-tab-content.active {
            display: block;
        }

        .hw-dropzone {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .hw-dropzone:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .hw-dropzone.dragging {
            border-color: #667eea;
            background: #e0e7ff;
            border-style: solid;
        }

        .hw-dropzone-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #a0aec0;
        }

        .hw-dropzone-text {
            font-size: 1.1em;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .hw-dropzone-hint {
            font-size: 0.9em;
            color: #718096;
        }

        .hw-file-list {
            margin-top: 20px;
        }

        .hw-file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .hw-file-icon {
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f9ff;
            border-radius: 6px;
            color: #0ea5e9;
        }

        .hw-file-info {
            flex: 1;
        }

        .hw-file-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .hw-file-size {
            font-size: 0.85em;
            color: #718096;
        }

        .hw-file-remove {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .hw-file-remove:hover {
            background: #fecaca;
            transform: scale(1.1);
        }

        .hw-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
        }

        .hw-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .hw-char-counter {
            text-align: right;
            margin-top: 8px;
            font-size: 0.9em;
            color: #718096;
        }

        .hw-url-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .hw-url-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .hw-link-preview {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }

        .hw-progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .hw-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .hw-progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
        }

        .hw-form-section {
            margin-bottom: 25px;
        }

        .hw-form-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .hw-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .hw-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .hw-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .hw-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .hw-btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .hw-btn-secondary {
            background: #e9ecef;
            color: #4a5568;
        }

        .hw-btn-secondary:hover {
            background: #cbd5e0;
        }

        .hw-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .hw-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e9ecef;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hw-loading-text {
            color: white;
            font-size: 1.2em;
            margin-top: 20px;
        }

        .hw-success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            margin-bottom: 20px;
        }

        .hw-error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
            margin-bottom: 20px;
        }

        .hw-warning {
            background: #fef3c7;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar {
                transform: translateX(-280px);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding-left: 80px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Side Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>ðŸ“š My Courses</h2>
            <button class="sidebar-toggle" onclick="toggleSidebar()">âœ•</button>
        </div>

        <!-- Course List Section -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Enrolled Courses</div>
            <div class="course-list" id="courseList">
                <!-- Courses will be populated dynamically -->
            </div>
        </div>

        <!-- Course Navigation Menu (shown when course selected) -->
        <div class="nav-menu" id="courseNavMenu" style="display: none;">
            <div class="nav-menu-item active" onclick="navigateTo('lessons')">
                <span class="nav-menu-icon">ðŸ“š</span>
                <span class="nav-menu-text">Lessons</span>
            </div>
            <div class="nav-menu-item" onclick="navigateTo('assignments')">
                <span class="nav-menu-icon">ðŸ“</span>
                <span class="nav-menu-text">Assignments</span>
                <span class="nav-badge" id="assignmentBadge">0</span>
            </div>
            <div class="nav-menu-item" onclick="navigateTo('quizzes')">
                <span class="nav-menu-icon">ðŸŽ¯</span>
                <span class="nav-menu-text">Quizzes</span>
            </div>
            <div class="nav-menu-item" onclick="navigateTo('grades')">
                <span class="nav-menu-icon">ðŸ“Š</span>
                <span class="nav-menu-text">Grades & Progress</span>
            </div>
            <div class="nav-menu-item" onclick="navigateTo('resources')">
                <span class="nav-menu-icon">ðŸ“–</span>
                <span class="nav-menu-text">Resources</span>
            </div>
        </div>

        <!-- Quick Links Section -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">Quick Links</div>
            <div class="nav-menu">
                <div class="nav-menu-item" onclick="showAllCourses()">
                    <span class="nav-menu-icon">ðŸ </span>
                    <span class="nav-menu-text">Dashboard Home</span>
                </div>
                <div class="nav-menu-item" onclick="showCalendar()">
                    <span class="nav-menu-icon">ðŸ“…</span>
                    <span class="nav-menu-text">Calendar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-content" id="mainContent">
        <div class="header">
            <h1>ðŸ‘¨â€ðŸŽ“ Student Dashboard</h1>
            <div class="user-info">
                <span id="studentName">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="container">
        <!-- Progress Header -->
        <div class="progress-header">
            <div class="progress-stats">
                <div class="stat-item">
                    <div class="stat-value" id="completedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total Lessons</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%;">
                        <span id="progressPercent">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Assignments Section -->
        <div class="dashboard-card assignments-section">
            <div class="dashboard-card-header">
                <span class="dashboard-card-icon">ðŸ“</span>
                <h3>My Assignments</h3>
            </div>

            <!-- Assignment Type Filters -->
            <div class="assignment-type-filters" style="padding: 15px 20px; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
                <div style="font-size: 0.9em; font-weight: 600; color: #6b7280; margin-bottom: 10px;">Filter by Type:</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button class="type-filter-btn active" data-type="all" onclick="switchAssignmentType('all')">
                        All <span class="count" id="typeCountAll">0</span>
                    </button>
                    <button class="type-filter-btn" data-type="homework" onclick="switchAssignmentType('homework')">
                        ðŸ“š Homework <span class="count" id="typeCountHomework">0</span>
                    </button>
                    <button class="type-filter-btn" data-type="quiz" onclick="switchAssignmentType('quiz')">
                        ðŸ“ Quizzes <span class="count" id="typeCountQuiz">0</span>
                    </button>
                    <button class="type-filter-btn" data-type="test" onclick="switchAssignmentType('test')">
                        ðŸ“‹ Tests <span class="count" id="typeCountTest">0</span>
                    </button>
                    <button class="type-filter-btn" data-type="project" onclick="switchAssignmentType('project')">
                        ðŸŽ¨ Projects <span class="count" id="typeCountProject">0</span>
                    </button>
                    <button class="type-filter-btn" data-type="essay" onclick="switchAssignmentType('essay')">
                        âœï¸ Essays <span class="count" id="typeCountEssay">0</span>
                    </button>
                    <button class="type-filter-btn" data-type="reading" onclick="switchAssignmentType('reading')">
                        ðŸ“– Reading <span class="count" id="typeCountReading">0</span>
                    </button>
                    <button class="type-filter-btn" data-type="activity" onclick="switchAssignmentType('activity')">
                        ðŸŽ¯ Activities <span class="count" id="typeCountActivity">0</span>
                    </button>
                </div>
            </div>

            <!-- Assignment Tabs -->
            <div class="assignments-tabs">
                <button class="assignments-tab active" data-tab="upcoming" onclick="switchAssignmentTab('upcoming')">
                    Upcoming <span class="count" id="upcomingCount">0</span>
                </button>
                <button class="assignments-tab" data-tab="overdue" onclick="switchAssignmentTab('overdue')">
                    Overdue <span class="count" id="overdueCount">0</span>
                </button>
                <button class="assignments-tab" data-tab="submitted" onclick="switchAssignmentTab('submitted')">
                    Submitted <span class="count" id="submittedCount">0</span>
                </button>
                <button class="assignments-tab" data-tab="graded" onclick="switchAssignmentTab('graded')">
                    Graded <span class="count" id="gradedCount">0</span>
                </button>
            </div>

            <!-- Assignment Content -->
            <div id="myAssignmentsContent">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“š</div>
                    <p>Loading your assignments...</p>
                </div>
            </div>
        </div>

        <!-- New Dashboard Sections -->
        <div class="dashboard-grid">
            <!-- Today's Lessons Card -->
            <div class="dashboard-card">
                <div class="dashboard-card-header">
                    <span class="dashboard-card-icon">ðŸ“…</span>
                    <h3>Today's Lessons</h3>
                    <span id="todayDate" style="font-size: 0.85em; color: #6c757d;"></span>
                </div>
                <div id="todayLessonsContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <p>Loading today's lessons...</p>
                    </div>
                </div>
            </div>

            <!-- Upcoming Assignments Card -->
            <div class="dashboard-card">
                <div class="dashboard-card-header">
                    <span class="dashboard-card-icon">ðŸ“‹</span>
                    <h3>Upcoming Assignments</h3>
                </div>
                <div id="upcomingAssignmentsContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ…</div>
                        <p>Loading assignments...</p>
                    </div>
                </div>
            </div>

            <!-- Subject Progress Card -->
            <div class="dashboard-card">
                <div class="dashboard-card-header">
                    <span class="dashboard-card-icon">ðŸ“Š</span>
                    <h3>Subject Progress</h3>
                </div>
                <div id="subjectProgressContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“ˆ</div>
                        <p>Calculating progress...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label>View:</label>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="calendar">ðŸ“… Calendar</button>
                    <button class="view-btn" data-view="day">ðŸ“‹ Today</button>
                    <button class="view-btn" data-view="week">ðŸ“Š Week</button>
                    <button class="view-btn" data-view="list">ðŸ“ List</button>
                </div>
            </div>
            <div class="control-group">
                <label for="subjectFilter">Subject:</label>
                <select id="subjectFilter">
                    <option value="all">All Subjects</option>
                </select>
            </div>
            <div class="control-group">
                <label for="periodFilter">Period:</label>
                <select id="periodFilter">
                    <option value="all">All Periods</option>
                    <option value="1">Period 1</option>
                    <option value="2">Period 2</option>
                    <option value="3">Period 3</option>
                    <option value="4">Period 4</option>
                </select>
            </div>
        </div>

        <!-- Calendar Navigation -->
        <div class="calendar-nav" id="calendarNav">
            <button class="nav-btn" id="prevMonth">â† Previous</button>
            <h2 id="currentMonth"></h2>
            <button class="nav-btn" id="nextMonth">Next â†’</button>
        </div>

        <!-- Calendar View -->
        <div class="calendar" id="calendarView">
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- Day View -->
        <div class="day-view" id="dayView" style="display: none;"></div>

        <!-- Week View -->
        <div class="week-view" id="weekView" style="display: none;"></div>

        <!-- List View -->
        <div class="list-view" id="listView" style="display: none;"></div>
    </div>

    <!-- Modal -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Homework Submission Modal -->
    <div id="homeworkModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="modal-close" onclick="closeHomeworkModal()">&times;</span>
            <div id="homeworkModalBody"></div>
        </div>
    </div>

    <!-- Assignment Details Modal -->
    <div id="assignmentDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="modal-close" onclick="closeAssignmentDetailsModal()">&times;</span>
            <div id="assignmentDetailsBody"></div>
        </div>
    </div>

    <!-- Grade View Modal -->
    <div id="gradeModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <span class="modal-close" onclick="closeGradeModal()">&times;</span>
            <div id="gradeModalBody"></div>
        </div>
    </div>

    <!-- Quiz Submission Modal -->
    <div id="quizModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeQuizModal()">&times;</span>
            <div id="quizModalBody"></div>
        </div>
    </div>

    <!-- Homework Submission Modal -->
    <div id="hwSubmissionModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="modal-close" onclick="closeHwSubmissionModal()">&times;</span>
            <div id="hwSubmissionBody"></div>
        </div>
    </div>

    <script src="dist/schedule-data.js"></script>
    <script src="curriculum-api.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Homework Submission Module -->
    <script src="homework-submission.js"></script>
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://qypmfilbkvxwyznnenge.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5cG1maWxia3Z4d3l6bm5lbmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNDY3NTIsImV4cCI6MjA3NTcyMjc1Mn0.3uC16cqBUjjFrAz103yws-E5W45HUh6rexbLBI3KCII';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Store lesson enhancements from database
        let lessonEnhancements = {};

        // Store student assignments from database
        let studentAssignments = [];
        let currentAssignmentTab = 'upcoming';
        let currentAssignmentType = 'all';

        // Load student assignments from serverless function
        async function loadStudentAssignments() {
            if (!currentStudent || !currentStudent.student_id) {
                console.error('No student logged in');
                return;
            }

            try {
                const response = await fetch(`/.netlify/functions/get-student-assignments?student_id=${currentStudent.student_id}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.assignments) {
                    studentAssignments = result.assignments;
                    console.log(`Loaded ${studentAssignments.length} assignments for student`);
                    renderMyAssignments();
                    updateAssignmentCounts();
                } else {
                    console.error('Failed to load assignments:', result);
                    studentAssignments = [];
                }
            } catch (error) {
                console.error('Error loading student assignments:', error);
                studentAssignments = [];
                renderMyAssignments();
            }
        }

        // Update assignment counts in tabs
        function updateAssignmentCounts() {
            const now = new Date();

            // Filter by current assignment type for status counts
            let typeFilteredAssignments = studentAssignments;
            if (currentAssignmentType !== 'all') {
                typeFilteredAssignments = studentAssignments.filter(a =>
                    a.assignment_type === currentAssignmentType || a.type === currentAssignmentType
                );
            }

            const upcoming = typeFilteredAssignments.filter(a => {
                const dueDate = new Date(a.due_date);
                return a.status === 'assigned' && dueDate >= now;
            });

            const overdue = typeFilteredAssignments.filter(a => {
                const dueDate = new Date(a.due_date);
                return a.status === 'assigned' && dueDate < now;
            });

            const submitted = typeFilteredAssignments.filter(a => a.status === 'submitted');
            const graded = typeFilteredAssignments.filter(a => a.status === 'graded');

            // Update status tab counts
            document.getElementById('upcomingCount').textContent = upcoming.length;
            document.getElementById('overdueCount').textContent = overdue.length;
            document.getElementById('submittedCount').textContent = submitted.length;
            document.getElementById('gradedCount').textContent = graded.length;

            // Update type filter counts
            document.getElementById('typeCountAll').textContent = studentAssignments.length;
            document.getElementById('typeCountHomework').textContent =
                studentAssignments.filter(a => a.assignment_type === 'homework' || a.type === 'homework').length;
            document.getElementById('typeCountQuiz').textContent =
                studentAssignments.filter(a => a.assignment_type === 'quiz' || a.type === 'quiz').length;
            document.getElementById('typeCountTest').textContent =
                studentAssignments.filter(a => a.assignment_type === 'test' || a.type === 'test').length;
            document.getElementById('typeCountProject').textContent =
                studentAssignments.filter(a => a.assignment_type === 'project' || a.type === 'project').length;
            document.getElementById('typeCountEssay').textContent =
                studentAssignments.filter(a => a.assignment_type === 'essay' || a.type === 'essay').length;
            document.getElementById('typeCountReading').textContent =
                studentAssignments.filter(a => a.assignment_type === 'reading' || a.type === 'reading').length;
            document.getElementById('typeCountActivity').textContent =
                studentAssignments.filter(a => a.assignment_type === 'activity' || a.type === 'activity').length;
        }

        // Switch assignment tab
        function switchAssignmentTab(tab) {
            currentAssignmentTab = tab;

            // Update tab styles
            document.querySelectorAll('.assignments-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });

            renderMyAssignments();
        }

        // Switch assignment type filter
        function switchAssignmentType(type) {
            currentAssignmentType = type;

            // Update type filter button styles
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });

            // Update status tab counts based on selected type
            updateAssignmentCounts();

            // Re-render assignments with new filters
            renderMyAssignments();
        }

        // Render My Assignments section
        function renderMyAssignments() {
            const container = document.getElementById('myAssignmentsContent');
            const now = new Date();

            // First filter by assignment type
            let assignmentsToFilter = studentAssignments;
            if (currentAssignmentType !== 'all') {
                assignmentsToFilter = studentAssignments.filter(a =>
                    a.assignment_type === currentAssignmentType || a.type === currentAssignmentType
                );
            }

            // Then filter by status/tab
            let filteredAssignments = [];

            if (currentAssignmentTab === 'upcoming') {
                filteredAssignments = assignmentsToFilter.filter(a => {
                    const dueDate = new Date(a.due_date);
                    return a.status === 'assigned' && dueDate >= now;
                }).sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
            } else if (currentAssignmentTab === 'overdue') {
                filteredAssignments = assignmentsToFilter.filter(a => {
                    const dueDate = new Date(a.due_date);
                    return a.status === 'assigned' && dueDate < now;
                }).sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
            } else if (currentAssignmentTab === 'submitted') {
                filteredAssignments = assignmentsToFilter.filter(a => a.status === 'submitted')
                    .sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at));
            } else if (currentAssignmentTab === 'graded') {
                filteredAssignments = assignmentsToFilter.filter(a => a.status === 'graded')
                    .sort((a, b) => new Date(b.due_date) - new Date(a.due_date));
            }

            if (filteredAssignments.length === 0) {
                const emptyMessages = {
                    upcoming: 'No upcoming assignments. You\'re all caught up!',
                    overdue: 'No overdue assignments. Great job staying on track!',
                    submitted: 'No submitted assignments yet.',
                    graded: 'No graded assignments yet.'
                };

                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <p>${emptyMessages[currentAssignmentTab]}</p>
                    </div>
                `;
                return;
            }

            const html = filteredAssignments.map(assignment => createAssignmentCard(assignment)).join('');
            container.innerHTML = html;
        }

        // Create assignment card HTML
        function createAssignmentCard(assignment) {
            const now = new Date();
            const dueDate = new Date(assignment.due_date);
            const isOverdue = dueDate < now && assignment.status === 'assigned';

            // Get subject info
            const subjectInfo = getSubjectInfo(assignment.subject_key) || { subject: assignment.subject_key, emoji: 'ðŸ“š' };

            // Format due date
            let dueDateText = '';
            if (assignment.days_until_due === 0) {
                dueDateText = `<span class="assignment-due-date urgent">Due Today</span>`;
            } else if (assignment.days_until_due === 1) {
                dueDateText = `<span class="assignment-due-date urgent">Due Tomorrow</span>`;
            } else if (isOverdue) {
                const daysOverdue = Math.abs(assignment.days_until_due);
                dueDateText = `<span class="assignment-due-date urgent">${daysOverdue} day${daysOverdue > 1 ? 's' : ''} overdue</span>`;
            } else {
                dueDateText = `<span class="assignment-due-date">Due in ${assignment.days_until_due} days</span>`;
            }

            // Determine status badge
            let statusBadge = '';
            let statusClass = '';
            if (assignment.status === 'graded') {
                statusBadge = `<span class="assignment-status-badge graded">Graded</span>`;
                statusClass = 'status-graded';
            } else if (assignment.status === 'submitted') {
                statusBadge = `<span class="assignment-status-badge submitted">Submitted</span>`;
                statusClass = 'status-submitted';
            } else if (isOverdue) {
                statusBadge = `<span class="assignment-status-badge overdue">Overdue</span>`;
                statusClass = 'status-overdue';
            } else {
                statusBadge = `<span class="assignment-status-badge not-started">Not Started</span>`;
                statusClass = 'status-assigned';
            }

            // Determine type badge class
            const typeLower = assignment.type.toLowerCase();
            const typeClass = typeLower === 'quiz' ? 'quiz' :
                             typeLower === 'homework' ? 'homework' :
                             typeLower === 'test' ? 'test' : 'project';

            // Points and grade display
            let pointsText = '';
            let letterGrade = '';
            if (assignment.status === 'graded' && (assignment.points_earned !== null || assignment.grade !== null)) {
                const pointsEarned = assignment.points_earned || assignment.grade || 0;
                const percentage = Math.round((pointsEarned / assignment.points_possible) * 100);

                // Calculate letter grade
                if (percentage >= 90) letterGrade = 'A';
                else if (percentage >= 80) letterGrade = 'B';
                else if (percentage >= 70) letterGrade = 'C';
                else if (percentage >= 60) letterGrade = 'D';
                else letterGrade = 'F';

                pointsText = `<span class="assignment-points graded" style="font-weight: 700; color: #10b981;">${pointsEarned}/${assignment.points_possible} pts (${percentage}% - ${letterGrade})</span>`;
            } else {
                pointsText = `<span class="assignment-points">ðŸŽ¯ ${assignment.points_possible} pts possible</span>`;
            }

            // Instructions preview (first 150 chars)
            let instructionsPreview = '';
            if (assignment.instructions) {
                const plainText = assignment.instructions.replace(/<[^>]*>/g, '').substring(0, 150);
                instructionsPreview = `<p style="margin-top: 8px; color: #6b7280; font-size: 0.9em; line-height: 1.5;">ðŸ“‹ ${plainText}${assignment.instructions.length > 150 ? '...' : ''}</p>`;
            } else if (assignment.description) {
                const plainText = assignment.description.substring(0, 150);
                instructionsPreview = `<p style="margin-top: 8px; color: #6b7280; font-size: 0.9em; line-height: 1.5;">ðŸ“‹ ${plainText}${assignment.description.length > 150 ? '...' : ''}</p>`;
            }

            // Submission status
            let submissionInfo = '';
            if (assignment.status === 'submitted' && assignment.submitted_at) {
                const submittedDate = new Date(assignment.submitted_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                submissionInfo = `<p style="margin-top: 8px; padding: 8px 12px; background: #dbeafe; border-radius: 6px; font-size: 0.85em; color: #1e40af;"><strong>âœ… Submitted:</strong> ${submittedDate}</p>`;
            }

            // Action buttons
            let actionButtons = '';
            if (assignment.status === 'graded') {
                actionButtons = `
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="assignment-action-btn view" onclick="event.stopPropagation(); viewGrade('${assignment.id}')" style="flex: 1;">
                            ðŸ‘ï¸ View Grade & Feedback
                        </button>
                        <button class="assignment-action-btn secondary" onclick="event.stopPropagation(); viewAssignmentDetails('${assignment.id}')" style="flex: 0 0 auto;">
                            ðŸ“„ Details
                        </button>
                    </div>
                `;
            } else if (assignment.status === 'submitted') {
                actionButtons = `
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="assignment-action-btn view" onclick="event.stopPropagation(); viewSubmission('${assignment.id}')" style="flex: 1;">
                            ðŸ‘ï¸ View Submission
                        </button>
                        <button class="assignment-action-btn secondary" onclick="event.stopPropagation(); viewAssignmentDetails('${assignment.id}')" style="flex: 0 0 auto;">
                            ðŸ“„ Details
                        </button>
                    </div>
                `;
            } else {
                actionButtons = `
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="assignment-action-btn start" onclick="event.stopPropagation(); startAssignment('${assignment.id}')" style="flex: 1;">
                            ðŸš€ Start Assignment
                        </button>
                        <button class="assignment-action-btn secondary" onclick="event.stopPropagation(); viewAssignmentDetails('${assignment.id}')" style="flex: 0 0 auto;">
                            ðŸ“„ Details
                        </button>
                    </div>
                `;
            }

            return `
                <div class="assignment-card ${statusClass}">
                    <div class="assignment-card-header">
                        <div class="assignment-title-group">
                            <div>
                                <span class="assignment-type-badge ${typeClass}">${assignment.type || assignment.assignment_type || 'Assignment'}</span>
                            </div>
                            <div class="assignment-card-title">${assignment.title || assignment.assignment_title || 'Untitled Assignment'}</div>
                        </div>
                        ${statusBadge}
                    </div>
                    <div class="assignment-card-meta">
                        <span>${subjectInfo.emoji} ${subjectInfo.subject}</span>
                        <span>ðŸ“… ${dueDateText}</span>
                        <span>${pointsText}</span>
                    </div>
                    ${instructionsPreview}
                    ${submissionInfo}
                    ${assignment.feedback && assignment.status === 'graded' ? `<p style="margin-top: 8px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px; font-size: 0.9em; line-height: 1.5;"><strong>ðŸ’¬ Teacher Feedback:</strong> ${assignment.feedback}</p>` : ''}
                    ${actionButtons}
                </div>
            `;
        }

        // Assignment Details Modal
        function viewAssignmentDetails(assignmentId) {
            const assignment = studentAssignments.find(a => a.id === assignmentId);
            if (!assignment) {
                alert('Assignment not found');
                return;
            }

            const subjectInfo = getSubjectInfo(assignment.subject_key) || { subject: assignment.subject_key, emoji: 'ðŸ“š' };
            const dueDate = new Date(assignment.due_date).toLocaleString('en-US', {
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit'
            });

            const modal = document.getElementById('assignmentDetailsModal');
            const body = document.getElementById('assignmentDetailsBody');

            body.innerHTML = `
                <div style="padding: 20px;">
                    <h2 style="margin: 0 0 20px 0; color: #1f2937; font-size: 1.8em;">
                        ${assignment.type || assignment.assignment_type || 'Assignment'} - ${assignment.title || assignment.assignment_title}
                    </h2>

                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong style="color: #6b7280;">Subject:</strong><br>
                                ${subjectInfo.emoji} ${subjectInfo.subject}
                            </div>
                            <div>
                                <strong style="color: #6b7280;">Type:</strong><br>
                                ${assignment.type || assignment.assignment_type || 'Assignment'}
                            </div>
                            <div>
                                <strong style="color: #6b7280;">Status:</strong><br>
                                <span style="text-transform: capitalize;">${assignment.status}</span>
                            </div>
                            <div>
                                <strong style="color: #6b7280;">Points:</strong><br>
                                ${assignment.points_possible} points
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <strong style="color: #6b7280;">Due Date:</strong><br>
                            ðŸ“… ${dueDate}
                        </div>
                    </div>

                    ${assignment.description ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #374151; margin-bottom: 10px;">Description:</h3>
                            <p style="color: #6b7280; line-height: 1.6;">${assignment.description}</p>
                        </div>
                    ` : ''}

                    ${assignment.instructions ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #374151; margin-bottom: 10px;">Instructions:</h3>
                            <div style="color: #6b7280; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${assignment.instructions}
                            </div>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button onclick="closeAssignmentDetailsModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Close
                        </button>
                        ${assignment.status !== 'graded' && assignment.status !== 'submitted' ? `
                            <button onclick="closeAssignmentDetailsModal(); startAssignment('${assignment.id}')" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ðŸš€ Start Assignment
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeAssignmentDetailsModal() {
            document.getElementById('assignmentDetailsModal').classList.remove('active');
        }

        // Grade Viewing Modal
        function viewGrade(assignmentId) {
            const assignment = studentAssignments.find(a => a.id === assignmentId);
            if (!assignment) {
                alert('Assignment not found');
                return;
            }

            const pointsEarned = assignment.points_earned || assignment.grade || 0;
            const percentage = Math.round((pointsEarned / assignment.points_possible) * 100);

            let letterGrade = '';
            if (percentage >= 90) letterGrade = 'A';
            else if (percentage >= 80) letterGrade = 'B';
            else if (percentage >= 70) letterGrade = 'C';
            else if (percentage >= 60) letterGrade = 'D';
            else letterGrade = 'F';

            const submittedDate = assignment.submitted_at ? new Date(assignment.submitted_at).toLocaleString() : 'N/A';
            const gradedDate = assignment.graded_at ? new Date(assignment.graded_at).toLocaleString() : 'N/A';

            const modal = document.getElementById('gradeModal');
            const body = document.getElementById('gradeModalBody');

            body.innerHTML = `
                <div style="padding: 20px;">
                    <h2 style="margin: 0 0 20px 0; color: #1f2937; text-align: center;">
                        ðŸŽ¯ ${assignment.title || assignment.assignment_title} - Grade Report
                    </h2>

                    <div style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 3em; font-weight: 700; margin-bottom: 10px;">
                            ${pointsEarned}/${assignment.points_possible}
                        </div>
                        <div style="font-size: 2em; font-weight: 600; margin-bottom: 5px;">
                            ${percentage}%
                        </div>
                        <div style="font-size: 1.5em; font-weight: 600; background: rgba(255,255,255,0.2); display: inline-block; padding: 8px 20px; border-radius: 20px;">
                            Letter Grade: ${letterGrade}
                        </div>
                    </div>

                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong style="color: #6b7280;">Submitted:</strong><br>
                                ${submittedDate}
                            </div>
                            <div>
                                <strong style="color: #6b7280;">Graded:</strong><br>
                                ${gradedDate}
                            </div>
                        </div>
                    </div>

                    ${assignment.feedback ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #374151; margin-bottom: 10px;">ðŸ“ Teacher Feedback:</h3>
                            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; line-height: 1.6;">
                                ${assignment.feedback}
                            </div>
                        </div>
                    ` : ''}

                    ${assignment.rubric_scores ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #374151; margin-bottom: 10px;">Rubric Breakdown:</h3>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${Object.entries(JSON.parse(assignment.rubric_scores)).map(([key, value]) => `
                                    <div style="margin-bottom: 8px;">
                                        <strong>${key}:</strong> ${value} pts
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button onclick="closeGradeModal()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeGradeModal() {
            document.getElementById('gradeModal').classList.remove('active');
        }

        // View Submission
        function viewSubmission(assignmentId) {
            const assignment = studentAssignments.find(a => a.id === assignmentId);
            if (!assignment) {
                alert('Assignment not found');
                return;
            }

            const submittedDate = assignment.submitted_at ? new Date(assignment.submitted_at).toLocaleString() : 'N/A';

            const modal = document.getElementById('assignmentDetailsModal');
            const body = document.getElementById('assignmentDetailsBody');

            body.innerHTML = `
                <div style="padding: 20px;">
                    <h2 style="margin: 0 0 20px 0; color: #1f2937;">
                        ðŸ“„ Submission - ${assignment.title || assignment.assignment_title}
                    </h2>

                    <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <strong style="color: #1e40af;">âœ… Submitted on ${submittedDate}</strong>
                    </div>

                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #374151;">Your Submission:</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            ${assignment.submission_text || 'Your submission has been recorded.'}
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeAssignmentDetailsModal()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        // Start Assignment - Route to appropriate submission interface
        function startAssignment(assignmentId) {
            const assignment = studentAssignments.find(a => a.id === assignmentId);
            if (!assignment) {
                alert('Assignment not found');
                return;
            }

            const assignmentType = (assignment.type || assignment.assignment_type || '').toLowerCase();

            if (assignmentType === 'quiz') {
                openQuizSubmission(assignment);
            } else if (assignmentType === 'homework' || assignmentType === 'essay' || assignmentType === 'project') {
                openHomeworkSubmission(assignment);
            } else {
                openHomeworkSubmission(assignment); // Default to homework submission
            }
        }

        // Quiz Submission Modal - Full Implementation
        let currentQuizAssignment = null;
        let quizAnswers = {};
        let quizAutoSaveInterval = null;

        function openQuizSubmission(assignment) {
            currentQuizAssignment = assignment;
            quizAnswers = {};

            // Parse quiz questions from metadata or instructions
            let quizQuestions = [];

            try {
                // Try to get quiz questions from metadata JSONB field
                if (assignment.metadata && typeof assignment.metadata === 'object') {
                    quizQuestions = assignment.metadata.quiz_questions || [];
                } else if (assignment.metadata && typeof assignment.metadata === 'string') {
                    const metadata = JSON.parse(assignment.metadata);
                    quizQuestions = metadata.quiz_questions || [];
                }
            } catch (e) {
                console.error('Error parsing quiz questions from metadata:', e);
            }

            // If no questions found, show error
            if (!quizQuestions || quizQuestions.length === 0) {
                alert('This quiz does not have any questions configured yet. Please contact your teacher.');
                return;
            }

            const modal = document.getElementById('quizModal');
            const body = document.getElementById('quizModalBody');

            const dueDate = new Date(assignment.due_date).toLocaleString('en-US', {
                month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit'
            });

            body.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                        <div>
                            <h2 style="margin: 0 0 8px 0; color: #1f2937;">ðŸ“ ${assignment.title || assignment.assignment_title}</h2>
                            <p style="margin: 0; color: #6b7280; font-size: 0.95em;">
                                ${quizQuestions.length} question${quizQuestions.length !== 1 ? 's' : ''} â€¢
                                ${assignment.points_possible} points â€¢
                                Due: ${dueDate}
                            </p>
                        </div>
                        <div id="quizAutoSaveStatus" style="padding: 8px 12px; background: #f3f4f6; border-radius: 6px; font-size: 0.85em; color: #6b7280;">
                            Not saved
                        </div>
                    </div>

                    ${assignment.instructions ? `
                        <div style="margin-bottom: 20px; padding: 15px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 6px;">
                            <strong style="color: #1e40af;">ðŸ“‹ Instructions:</strong>
                            <div style="margin-top: 8px; color: #374151; line-height: 1.5;">
                                ${assignment.instructions}
                            </div>
                        </div>
                    ` : ''}

                    <div id="quizQuestionsContainer" style="margin-bottom: 20px;">
                        ${quizQuestions.map((q, index) => renderQuizQuestion(q, index)).join('')}
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: space-between; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <button onclick="saveQuizDraft()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ðŸ’¾ Save Draft
                        </button>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="closeQuizModal()" style="padding: 10px 20px; background: white; color: #374151; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Cancel
                            </button>
                            <button onclick="submitQuiz()" style="padding: 10px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                âœ… Submit Quiz
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('active');

            // Start auto-save every 30 seconds
            quizAutoSaveInterval = setInterval(() => {
                saveQuizDraft(true); // true = silent save
            }, 30000);
        }

        function renderQuizQuestion(question, index) {
            const questionNumber = index + 1;
            const questionType = question.type || 'short_answer';
            const points = question.points || 0;

            let inputHtml = '';

            if (questionType === 'multiple_choice') {
                inputHtml = `
                    <div style="margin-top: 12px;">
                        ${(question.options || []).map((option, optIndex) => `
                            <label style="display: block; padding: 12px; margin-bottom: 8px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                                   onmouseover="this.style.background='#f9fafb'"
                                   onmouseout="this.style.background='white'">
                                <input type="radio"
                                       name="quiz_q${index}"
                                       value="${option}"
                                       onchange="updateQuizAnswer('${question.id}', this.value)"
                                       style="margin-right: 10px;">
                                <span style="color: #374151; font-size: 0.95em;">${option}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
            } else if (questionType === 'true_false') {
                inputHtml = `
                    <div style="margin-top: 12px; display: flex; gap: 12px;">
                        <label style="flex: 1; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.2s;"
                               onmouseover="this.style.background='#f9fafb'"
                               onmouseout="this.style.background='white'">
                            <input type="radio"
                                   name="quiz_q${index}"
                                   value="True"
                                   onchange="updateQuizAnswer('${question.id}', this.value)"
                                   style="margin-right: 8px;">
                            <span style="color: #374151; font-weight: 600;">True</span>
                        </label>
                        <label style="flex: 1; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.2s;"
                               onmouseover="this.style.background='#f9fafb'"
                               onmouseout="this.style.background='white'">
                            <input type="radio"
                                   name="quiz_q${index}"
                                   value="False"
                                   onchange="updateQuizAnswer('${question.id}', this.value)"
                                   style="margin-right: 8px;">
                            <span style="color: #374151; font-weight: 600;">False</span>
                        </label>
                    </div>
                `;
            } else {
                // Short answer / essay
                inputHtml = `
                    <textarea id="quiz_answer_${question.id}"
                              onchange="updateQuizAnswer('${question.id}', this.value)"
                              placeholder="Type your answer here..."
                              style="width: 100%; min-height: 100px; margin-top: 12px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.95em; resize: vertical;"
                    ></textarea>
                `;
            }

            return `
                <div style="margin-bottom: 24px; padding: 20px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <h3 style="margin: 0; color: #374151; font-size: 1.05em;">
                            Question ${questionNumber}
                        </h3>
                        <span style="padding: 4px 10px; background: #667eea; color: white; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                            ${points} pt${points !== 1 ? 's' : ''}
                        </span>
                    </div>
                    <p style="margin: 0 0 4px 0; color: #1f2937; line-height: 1.6; font-size: 0.95em;">
                        ${question.question}
                    </p>
                    <p style="margin: 0 0 12px 0; color: #9ca3af; font-size: 0.85em; font-style: italic;">
                        ${questionType === 'multiple_choice' ? 'Select one answer' :
                          questionType === 'true_false' ? 'Select True or False' :
                          'Type your answer in the box below'}
                    </p>
                    ${inputHtml}
                </div>
            `;
        }

        function updateQuizAnswer(questionId, answer) {
            quizAnswers[questionId] = answer;

            // Update save status
            const status = document.getElementById('quizAutoSaveStatus');
            if (status) {
                status.textContent = 'Unsaved changes';
                status.style.background = '#fef3c7';
                status.style.color = '#92400e';
            }
        }

        async function saveQuizDraft(silent = false) {
            if (!currentQuizAssignment) return;

            try {
                const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
                if (!currentStudent || !currentStudent.student_id) {
                    if (!silent) alert('Please log in to save your quiz draft.');
                    return;
                }

                const response = await fetch('/.netlify/functions/submit-assignment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignment_id: currentQuizAssignment.id,
                        student_id: currentStudent.student_id,
                        submission_type: 'quiz_answers',
                        quiz_answers: quizAnswers,
                        status: 'draft'
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    const status = document.getElementById('quizAutoSaveStatus');
                    if (status) {
                        status.textContent = `ðŸ’¾ Saved at ${new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
                        status.style.background = '#d1fae5';
                        status.style.color = '#065f46';
                    }
                    if (!silent) {
                        alert('âœ… Draft saved successfully!');
                    }
                } else {
                    throw new Error(result.error || 'Failed to save draft');
                }
            } catch (error) {
                console.error('Error saving quiz draft:', error);
                if (!silent) {
                    alert('âŒ Failed to save draft: ' + error.message);
                }
            }
        }

        async function submitQuiz() {
            if (!currentQuizAssignment) return;

            // Check if all questions are answered
            const metadata = currentQuizAssignment.metadata;
            let quizQuestions = [];

            try {
                if (metadata && typeof metadata === 'object') {
                    quizQuestions = metadata.quiz_questions || [];
                } else if (metadata && typeof metadata === 'string') {
                    const parsed = JSON.parse(metadata);
                    quizQuestions = parsed.quiz_questions || [];
                }
            } catch (e) {
                console.error('Error parsing quiz questions:', e);
            }

            const unansweredQuestions = quizQuestions.filter(q => !quizAnswers[q.id]);

            if (unansweredQuestions.length > 0) {
                const proceed = confirm(`âš ï¸ You have ${unansweredQuestions.length} unanswered question(s). Submit anyway?`);
                if (!proceed) return;
            }

            const confirmSubmit = confirm('ðŸš€ Are you ready to submit your quiz? You cannot change your answers after submission.');
            if (!confirmSubmit) return;

            try {
                const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
                if (!currentStudent || !currentStudent.student_id) {
                    alert('Please log in to submit your quiz.');
                    return;
                }

                const response = await fetch('/.netlify/functions/submit-assignment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignment_id: currentQuizAssignment.id,
                        student_id: currentStudent.student_id,
                        submission_type: 'quiz_answers',
                        quiz_answers: quizAnswers,
                        status: 'submitted',
                        submitted_at: new Date().toISOString()
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('âœ… Quiz submitted successfully!');
                    closeQuizModal();

                    // Reload assignments to show updated status
                    await loadStudentAssignments();
                } else {
                    throw new Error(result.error || 'Failed to submit quiz');
                }
            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('âŒ Failed to submit quiz: ' + error.message);
            }
        }

        function closeQuizModal() {
            // Clear auto-save interval
            if (quizAutoSaveInterval) {
                clearInterval(quizAutoSaveInterval);
                quizAutoSaveInterval = null;
            }

            // Clear state
            currentQuizAssignment = null;
            quizAnswers = {};

            document.getElementById('quizModal').classList.remove('active');
        }

        // Homework Submission Modal - Full Implementation
        let currentHomeworkAssignment = null;
        let uploadedFiles = [];

        async function openHomeworkSubmission(assignment) {
            currentHomeworkAssignment = assignment;
            uploadedFiles = [];

            const modal = document.getElementById('hwSubmissionModal');
            const body = document.getElementById('hwSubmissionBody');

            const assignmentType = (assignment.type || assignment.assignment_type || 'homework').toLowerCase();
            const dueDate = new Date(assignment.due_date).toLocaleString('en-US', {
                month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit'
            });

            let submissionTypeLabel = 'Homework';
            let submissionIcon = 'ðŸ“š';
            if (assignmentType === 'essay') {
                submissionTypeLabel = 'Essay';
                submissionIcon = 'âœï¸';
            } else if (assignmentType === 'project') {
                submissionTypeLabel = 'Project';
                submissionIcon = 'ðŸŽ¨';
            }

            body.innerHTML = `
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                        <h2 style="margin: 0 0 8px 0; color: #1f2937;">
                            ${submissionIcon} ${assignment.title || assignment.assignment_title}
                        </h2>
                        <p style="margin: 0; color: #6b7280; font-size: 0.95em;">
                            ${submissionTypeLabel} â€¢ ${assignment.points_possible} points â€¢ Due: ${dueDate}
                        </p>
                    </div>

                    ${assignment.instructions ? `
                        <div style="margin-bottom: 20px; padding: 15px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 6px;">
                            <strong style="color: #1e40af;">ðŸ“‹ Instructions:</strong>
                            <div style="margin-top: 8px; color: #374151; line-height: 1.5;">
                                ${assignment.instructions}
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            Written Response:
                        </label>
                        <textarea id="hwSubmissionText"
                                  placeholder="Type your response here (optional if uploading files)..."
                                  style="width: 100%; min-height: 150px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.95em; resize: vertical;"
                        ></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            Upload Files (Optional):
                        </label>
                        <div style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; background: #f9fafb;">
                            <input type="file"
                                   id="hwFileInput"
                                   multiple
                                   onchange="handleFileSelection(event)"
                                   style="display: none;">
                            <button onclick="document.getElementById('hwFileInput').click()"
                                    style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                ðŸ“Ž Choose Files
                            </button>
                            <p style="margin: 10px 0 0 0; color: #6b7280; font-size: 0.85em;">
                                Accepted formats: PDF, DOC, DOCX, TXT, JPG, PNG (Max 10MB per file)
                            </p>
                        </div>
                        <div id="selectedFilesList" style="margin-top: 12px;"></div>
                    </div>

                    <div id="uploadProgress" style="display: none; margin-bottom: 20px; padding: 15px; background: #eff6ff; border-radius: 8px;">
                        <div style="margin-bottom: 8px; font-weight: 600; color: #1e40af;">
                            Uploading files...
                        </div>
                        <div style="background: white; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="uploadProgressBar"
                                 style="height: 100%; background: #3b82f6; width: 0%; transition: width 0.3s;">
                            </div>
                        </div>
                        <div id="uploadProgressText" style="margin-top: 8px; font-size: 0.85em; color: #6b7280;"></div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <button onclick="closeHwSubmissionModal()" style="padding: 10px 20px; background: white; color: #374151; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                        <button onclick="submitHomework()" style="padding: 10px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            âœ… Submit ${submissionTypeLabel}
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain',
                'image/jpeg',
                'image/png'
            ];

            const validFiles = files.filter(file => {
                if (file.size > maxSize) {
                    alert(`âŒ File "${file.name}" is too large. Maximum size is 10MB.`);
                    return false;
                }
                if (!allowedTypes.includes(file.type)) {
                    alert(`âŒ File "${file.name}" has an unsupported format.`);
                    return false;
                }
                return true;
            });

            uploadedFiles = validFiles;
            displaySelectedFiles();
        }

        function displaySelectedFiles() {
            const container = document.getElementById('selectedFilesList');
            if (!container) return;

            if (uploadedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 10px;">
                        Selected Files (${uploadedFiles.length}):
                    </div>
                    ${uploadedFiles.map((file, index) => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: #f9fafb; border-radius: 4px; margin-bottom: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>ðŸ“„</span>
                                <span style="color: #374151; font-size: 0.9em;">${file.name}</span>
                                <span style="color: #9ca3af; font-size: 0.8em;">(${(file.size / 1024).toFixed(1)} KB)</span>
                            </div>
                            <button onclick="removeFile(${index})"
                                    style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                Remove
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displaySelectedFiles();
        }

        async function submitHomework() {
            if (!currentHomeworkAssignment) return;

            const submissionText = document.getElementById('hwSubmissionText').value.trim();

            // Validate that there's either text or files
            if (!submissionText && uploadedFiles.length === 0) {
                alert('âš ï¸ Please provide a written response or upload at least one file.');
                return;
            }

            const confirmSubmit = confirm('ðŸš€ Are you ready to submit your work? You cannot change your submission after submitting.');
            if (!confirmSubmit) return;

            try {
                const currentStudent = JSON.parse(localStorage.getItem('currentStudent'));
                if (!currentStudent || !currentStudent.student_id) {
                    alert('Please log in to submit your assignment.');
                    return;
                }

                let fileUrls = [];

                // Upload files to Supabase Storage if there are any
                if (uploadedFiles.length > 0) {
                    const progress = document.getElementById('uploadProgress');
                    const progressBar = document.getElementById('uploadProgressBar');
                    const progressText = document.getElementById('uploadProgressText');

                    progress.style.display = 'block';

                    for (let i = 0; i < uploadedFiles.length; i++) {
                        const file = uploadedFiles[i];
                        const percentage = Math.round(((i + 1) / uploadedFiles.length) * 100);

                        progressText.textContent = `Uploading ${i + 1} of ${uploadedFiles.length}: ${file.name}`;
                        progressBar.style.width = percentage + '%';

                        // Upload to Supabase Storage
                        const fileUrl = await uploadFileToStorage(file, currentStudent.student_id, currentHomeworkAssignment.id);
                        if (fileUrl) {
                            fileUrls.push({
                                name: file.name,
                                url: fileUrl,
                                size: file.size,
                                type: file.type
                            });
                        }
                    }

                    progress.style.display = 'none';
                }

                // Submit to serverless function
                const response = await fetch('/.netlify/functions/submit-assignment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignment_id: currentHomeworkAssignment.id,
                        student_id: currentStudent.student_id,
                        submission_type: 'file_upload',
                        submission_text: submissionText || null,
                        file_urls: fileUrls,
                        status: 'submitted',
                        submitted_at: new Date().toISOString()
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('âœ… Assignment submitted successfully!');
                    closeHwSubmissionModal();

                    // Reload assignments to show updated status
                    await loadStudentAssignments();
                } else {
                    throw new Error(result.error || 'Failed to submit assignment');
                }
            } catch (error) {
                console.error('Error submitting homework:', error);
                alert('âŒ Failed to submit assignment: ' + error.message);
            }
        }

        async function uploadFileToStorage(file, studentId, assignmentId) {
            try {
                // Create a unique file name
                const timestamp = new Date().getTime();
                const safeFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const filePath = `student-submissions/${studentId}/${assignmentId}/${timestamp}_${safeFileName}`;

                // For now, we'll use a base64 upload approach
                // In production, you'd want to use Supabase Storage SDK directly
                const formData = new FormData();
                formData.append('file', file);
                formData.append('filePath', filePath);
                formData.append('studentId', studentId);
                formData.append('assignmentId', assignmentId);

                // This is a simplified approach - you'd typically have a dedicated upload endpoint
                // For now, return a placeholder URL
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = function(e) {
                        // In a real implementation, this would upload to Supabase Storage
                        // For now, we'll just return a mock URL
                        resolve(`/uploads/${filePath}`);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error('Error uploading file:', error);
                alert(`Failed to upload ${file.name}: ${error.message}`);
                return null;
            }
        }

        function closeHwSubmissionModal() {
            currentHomeworkAssignment = null;
            uploadedFiles = [];
            document.getElementById('hwSubmissionModal').classList.remove('active');
        }

        // Load all lesson enhancements from Supabase
        async function loadLessonEnhancements() {
            try {
                const { data, error } = await supabase
                    .from('lesson_enhancements')
                    .select('*');

                if (error) {
                    console.error('Error loading lesson enhancements:', error);
                    return;
                }

                // Convert array to object keyed by lesson_key
                lessonEnhancements = {};
                (data || []).forEach(enhancement => {
                    lessonEnhancements[enhancement.lesson_key] = {
                        notes: enhancement.notes,
                        quiz: enhancement.quiz,
                        activities: enhancement.activities,
                        rubric: enhancement.rubric,
                        videos: enhancement.videos,
                        docs: enhancement.docs,
                        links: enhancement.links,
                        aiExpand: enhancement.ai_expand,
                        aiSimplify: enhancement.ai_simplify,
                        aiQuestions: enhancement.ai_questions,
                        aiActivities: enhancement.ai_activities,
                        aiAssessment: enhancement.ai_assessment,
                        aiDifferentiate: enhancement.ai_differentiate
                    };
                });

                console.log(`Loaded ${data.length} lesson enhancements from database`);
            } catch (error) {
                console.error('Failed to load lesson enhancements:', error);
            }
        }

        // Load student data from localStorage
        let currentStudent = null;
        let studentGrade = 7;
        let enrolledSubjects = {
            1: { A: [], B: [] },
            2: { A: [], B: [] },
            3: { A: [], B: [] },
            4: { A: [], B: [] }
        };
        let currentMonth = new Date('2025-09-01');
        let periodFilter = 'all';
        let subjectFilter = 'all';
        let currentView = 'calendar';
        let listFilter = 'all'; // 'all', 'completed', 'incomplete'

        // Load lesson completions from localStorage
        let lessonCompletions = JSON.parse(localStorage.getItem('lessonCompletions') || '{}');

        // Save completions to localStorage
        function saveCompletions() {
            localStorage.setItem('lessonCompletions', JSON.stringify(lessonCompletions));
            updateProgressStats();
            populateCourseList(); // Update sidebar progress bars
        }

        // Legacy function - removed in favor of assignment tracking
        // Students now complete individual assignments, not just toggle a lesson complete

        // Check if lesson is completed (all assignments done)
        function isLessonCompleted(lessonKey) {
            const completion = lessonCompletions[lessonKey];
            if (!completion || !completion.assignments) return false;

            // Lesson is complete only if all assignments are checked
            return Object.values(completion.assignments).every(done => done === true);
        }

        // Generate assignment checklist for a lesson
        function getAssignmentChecklist(lessonKey, enhancement) {
            const completion = lessonCompletions[lessonKey] || { assignments: {} };
            let html = '';
            let assignmentCount = 0;

            // Assignment 1: Read lesson content
            const readKey = 'read_content';
            const isRead = completion.assignments?.[readKey] || false;
            html += `
                <div style="background: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleAssignment('${lessonKey}', '${readKey}')">
                    <input type="checkbox" ${isRead ? 'checked' : ''} onclick="event.stopPropagation(); toggleAssignment('${lessonKey}', '${readKey}')" style="width: 20px; height: 20px; cursor: pointer;">
                    <label style="flex: 1; cursor: pointer; margin: 0;">ðŸ“– Read lesson content and materials</label>
                </div>
            `;
            assignmentCount++;

            // Assignment 2: Complete quiz (if exists)
            if (enhancement.quiz && enhancement.quiz.questions && enhancement.quiz.questions.length > 0) {
                const quizKey = 'complete_quiz';
                const isQuizDone = completion.assignments?.[quizKey] || false;
                html += `
                    <div style="background: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleAssignment('${lessonKey}', '${quizKey}')">
                        <input type="checkbox" ${isQuizDone ? 'checked' : ''} onclick="event.stopPropagation(); toggleAssignment('${lessonKey}', '${quizKey}')" style="width: 20px; height: 20px; cursor: pointer;">
                        <label style="flex: 1; cursor: pointer; margin: 0;">ðŸ“ Complete quiz (${enhancement.quiz.questions.length} questions)</label>
                    </div>
                `;
                assignmentCount++;
            }

            // Assignment 3: Complete activities (if exists)
            if (enhancement.activities && enhancement.activities.activities && enhancement.activities.activities.length > 0) {
                const actKey = 'complete_activities';
                const isActDone = completion.assignments?.[actKey] || false;
                html += `
                    <div style="background: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleAssignment('${lessonKey}', '${actKey}')">
                        <input type="checkbox" ${isActDone ? 'checked' : ''} onclick="event.stopPropagation(); toggleAssignment('${lessonKey}', '${actKey}')" style="width: 20px; height: 20px; cursor: pointer;">
                        <label style="flex: 1; cursor: pointer; margin: 0;">ðŸŽ¯ Complete class activities (${enhancement.activities.activities.length} activities)</label>
                    </div>
                `;
                assignmentCount++;
            }

            // Assignment 4: Review videos (if exists)
            if (enhancement.videos && enhancement.videos.length > 0) {
                const vidKey = 'watch_videos';
                const isVidDone = completion.assignments?.[vidKey] || false;
                html += `
                    <div style="background: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleAssignment('${lessonKey}', '${vidKey}')">
                        <input type="checkbox" ${isVidDone ? 'checked' : ''} onclick="event.stopPropagation(); toggleAssignment('${lessonKey}', '${vidKey}')" style="width: 20px; height: 20px; cursor: pointer;">
                        <label style="flex: 1; cursor: pointer; margin: 0;">ðŸŽ¥ Watch all videos (${enhancement.videos.length} videos)</label>
                    </div>
                `;
                assignmentCount++;
            }

            // Assignment 5: Review documents (if exists)
            if (enhancement.docs && enhancement.docs.length > 0) {
                const docKey = 'review_docs';
                const isDocDone = completion.assignments?.[docKey] || false;
                html += `
                    <div style="background: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleAssignment('${lessonKey}', '${docKey}')">
                        <input type="checkbox" ${isDocDone ? 'checked' : ''} onclick="event.stopPropagation(); toggleAssignment('${lessonKey}', '${docKey}')" style="width: 20px; height: 20px; cursor: pointer;">
                        <label style="flex: 1; cursor: pointer; margin: 0;">ðŸ“„ Review all documents (${enhancement.docs.length} documents)</label>
                    </div>
                `;
                assignmentCount++;
            }

            // Show completion status
            const completedCount = Object.values(completion.assignments || {}).filter(v => v === true).length;
            const isFullyComplete = isLessonCompleted(lessonKey);

            // Add homework submission button (if homework is available)
            // Extract date and subject info from lessonKey: YYYY-MM-DD_subjectKey_period
            const keyParts = lessonKey.split('_');
            const dateKey = keyParts[0];
            const subjectKey = keyParts.slice(1, -1).join('_');
            const period = keyParts[keyParts.length - 1];

            // Check if there's homework to submit (if rubric or quiz exists, or teacher notes)
            const hasHomework = enhancement.quiz || enhancement.rubric || enhancement.notes;

            if (hasHomework) {
                const subjectInfo = getSubjectInfo(subjectKey);
                const homeworkKey = 'submit_homework';
                const isHomeworkDone = completion.assignments?.[homeworkKey] || false;

                html += `
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="checkbox" ${isHomeworkDone ? 'checked' : ''} onclick="event.stopPropagation(); toggleAssignment('${lessonKey}', '${homeworkKey}')" style="width: 20px; height: 20px; cursor: pointer;">
                            <label style="color: white; font-weight: 600; margin: 0;">ðŸ“ Submit Homework Assignment</label>
                        </div>
                        <button
                            onclick="event.stopPropagation(); openHomeworkModal({
                                id: '${lessonKey}_homework',
                                title: '${enhancement.quiz?.title || 'Homework Assignment'}',
                                subject: '${subjectInfo.subject}',
                                dueDate: '${dateKey}',
                                period: ${period},
                                points: ${enhancement.quiz?.totalPoints || 100},
                                instructions: \`${(enhancement.notes || 'Complete the assigned work').replace(/`/g, '').replace(/"/g, '&quot;')}\`
                            })"
                            style="width: 100%; padding: 10px; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                        >
                            ðŸ“¤ ${isHomeworkDone ? 'View Submission' : 'Start Assignment'}
                        </button>
                    </div>
                `;
                assignmentCount++;
            }

            if (isFullyComplete) {
                html += `
                    <div style="background: #d1fae5; border: 2px solid #10b981; padding: 12px; border-radius: 6px; text-align: center; margin-top: 10px;">
                        <span style="color: #047857; font-weight: 700; font-size: 1.1em;">âœ“ Lesson Complete!</span>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 12px; border-radius: 6px; text-align: center; margin-top: 10px;">
                        <span style="color: #92400e; font-weight: 600;">Progress: ${completedCount}/${assignmentCount} assignments completed</span>
                    </div>
                `;
            }

            return html;
        }

        // Toggle assignment completion
        function toggleAssignment(lessonKey, assignmentKey) {
            if (!lessonCompletions[lessonKey]) {
                lessonCompletions[lessonKey] = {
                    assignments: {},
                    studentId: currentStudent.student_id
                };
            }

            if (!lessonCompletions[lessonKey].assignments) {
                lessonCompletions[lessonKey].assignments = {};
            }

            // Toggle the assignment
            const currentValue = lessonCompletions[lessonKey].assignments[assignmentKey] || false;
            lessonCompletions[lessonKey].assignments[assignmentKey] = !currentValue;

            // Check if all assignments are now complete
            if (isLessonCompleted(lessonKey)) {
                lessonCompletions[lessonKey].completedAt = new Date().toISOString();
            } else {
                delete lessonCompletions[lessonKey].completedAt;
            }

            saveCompletions();

            // Update progress stats and refresh dashboard
            updateProgressStats();
            refreshDashboard();

            // Refresh the assignment checklist
            const container = document.getElementById(`assignments_${lessonKey}`);
            if (container) {
                // Get enhancement data from Supabase-loaded data
                const enhancement = lessonEnhancements[lessonKey] || {};
                container.innerHTML = getAssignmentChecklist(lessonKey, enhancement);
            }
        }

        // Get all lessons for student
        function getAllLessons() {
            const lessons = [];
            const startDate = new Date('2025-09-01');
            const endDate = new Date('2026-06-30');

            for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) continue; // Skip weekends

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;

                if (schoolCalendar.noSchoolDays.has(dateStr)) continue;

                const dayType = getABDay(dateStr);
                if (!dayType) continue;

                const dayNum = getDayNumber(dateStr, dayType);
                const dayKey = `${dayNum}.${dayType}`;

                [1, 2, 3, 4].forEach(period => {
                    const enrolledInPeriod = enrolledSubjects[period][dayType] || [];
                    enrolledInPeriod.forEach(subjectKey => {
                        // Apply subject filter
                        if (subjectFilter !== 'all' && subjectKey !== subjectFilter) {
                            return;
                        }

                        const lesson = window.curriculumData.getLesson(subjectKey, dayKey);
                        if (lesson) {
                            const lessonKey = `${dateStr}_${subjectKey}_${period}`;
                            lessons.push({
                                key: lessonKey,
                                date: new Date(date),
                                dateStr: dateStr,
                                dayType: dayType,
                                dayNum: dayNum,
                                period: period,
                                subjectKey: subjectKey,
                                lesson: lesson,
                                completed: isLessonCompleted(lessonKey)
                            });
                        }
                    });
                });
            }

            return lessons;
        }

        // Update progress statistics
        function updateProgressStats() {
            const allLessons = getAllLessons();
            const completed = allLessons.filter(l => l.completed).length;
            const total = allLessons.length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('completedCount').textContent = completed;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${percent}%`;
        }

        // Lesson schedule overrides (same as teacher dashboard)
        let lessonOverrides = [];

        async function loadLessonOverrides() {
            try {
                const { data, error } = await supabase
                    .from('lesson_schedule_overrides')
                    .select('*')
                    .eq('is_active', true);

                if (error) {
                    console.error('Error loading lesson overrides:', error);
                    return;
                }

                lessonOverrides = data || [];
                console.log(`ðŸ“š Loaded ${lessonOverrides.length} lesson override(s) for student view`);
            } catch (error) {
                console.error('Failed to load lesson overrides:', error);
            }
        }

        function getLessonsForDay(subjectKey, dayKey, period, grade, date) {
            const curriculumMap = window.curriculumMap || window.curriculumData?.curriculumMap;
            const subject = curriculumMap?.[subjectKey];
            const originalLesson = subject?.lessons?.[dayKey];

            const lessons = [];

            // Add original lesson if not moved away
            if (originalLesson) {
                const movedAway = lessonOverrides.some(override =>
                    override.subject_key === subjectKey &&
                    override.lesson_code === originalLesson.code &&
                    override.original_day_key === dayKey &&
                    override.scheduled_date !== date
                );

                if (!movedAway) {
                    lessons.push({...originalLesson, isOriginal: true});
                }
            }

            // Add overrides scheduled for this day
            const overridesForDay = lessonOverrides.filter(override =>
                override.subject_key === subjectKey &&
                override.scheduled_date === date &&
                override.period_number === period &&
                override.grade_level === grade.toString()
            );

            overridesForDay.forEach(override => {
                const lessonData = findLessonByCode(subjectKey, override.lesson_code);
                if (lessonData) {
                    lessons.push({...lessonData, isOverride: true, overrideId: override.id});
                }
            });

            return lessons;
        }

        function findLessonByCode(subjectKey, lessonCode) {
            const curriculumMap = window.curriculumMap || window.curriculumData?.curriculumMap;
            const subject = curriculumMap?.[subjectKey];
            if (!subject?.lessons) return null;

            for (const [dayKey, lesson] of Object.entries(subject.lessons)) {
                if (lesson.code === lessonCode) return lesson;
            }
            return null;
        }

        // Check if student is logged in
        function checkAuth() {
            const studentData = localStorage.getItem('currentStudent');
            if (!studentData) {
                window.location.href = 'index.html';
                return;
            }

            currentStudent = JSON.parse(studentData);
            studentGrade = currentStudent.grade_level;

            // Parse enrolled subjects by period and day type (A/B)
            enrolledSubjects[1].A = currentStudent.period_1_a_day || [];
            enrolledSubjects[1].B = currentStudent.period_1_b_day || [];
            enrolledSubjects[2].A = currentStudent.period_2_a_day || [];
            enrolledSubjects[2].B = currentStudent.period_2_b_day || [];
            enrolledSubjects[3].A = currentStudent.period_3_a_day || [];
            enrolledSubjects[3].B = currentStudent.period_3_b_day || [];
            enrolledSubjects[4].A = currentStudent.period_4_a_day || [];
            enrolledSubjects[4].B = currentStudent.period_4_b_day || [];

            // Update header with student name
            document.getElementById('studentName').textContent = `${currentStudent.full_name} - ${studentGrade}th Grade`;
        }

        // Check auth on page load
        checkAuth();

        // Populate subject filter dropdown with enrolled subjects
        function populateSubjectFilter() {
            const uniqueSubjects = new Set();

            // Extract all unique subject keys from enrolledSubjects
            Object.values(enrolledSubjects).forEach(periodData => {
                Object.values(periodData).forEach(subjects => {
                    subjects.forEach(subjectKey => uniqueSubjects.add(subjectKey));
                });
            });

            // Debug logging to help with Giacomo issue
            console.log('Enrolled Subjects:', enrolledSubjects);
            console.log('Unique Subjects Found:', Array.from(uniqueSubjects));

            const select = document.getElementById('subjectFilter');
            // Clear existing options except "All Subjects"
            select.innerHTML = '<option value="all">All Subjects</option>';

            // Add each unique subject
            Array.from(uniqueSubjects).sort().forEach(subjectKey => {
                const subjectInfo = getSubjectInfo(subjectKey);
                const option = document.createElement('option');
                option.value = subjectKey;
                option.textContent = subjectInfo.subject;
                select.appendChild(option);
            });
        }

        // Helper function to get subject display information
        function getSubjectInfo(subjectKey) {
            const subjectMap = {
                '7th_civics': { subject: 'Civics', class: 'subject-civics' },
                '7th_ela': { subject: 'English Language Arts', class: 'subject-ela' },
                '7th_math': { subject: 'Pre-Algebra', class: 'subject-math' },
                '7th_science': { subject: 'Life Science', class: 'subject-science' },
                '9th_ela': { subject: 'English Language Arts', class: 'subject-ela' },
                '9th_math': { subject: 'Geometry', class: 'subject-math' },
                '9th_world_history': { subject: 'World History', class: 'subject-history' },
                '11th_ela': { subject: 'American Literature', class: 'subject-ela' },
                '11th_math': { subject: 'Pre-Calculus', class: 'subject-math' },
                '11th_us_gvmnt': { subject: 'U.S. Government', class: 'subject-government' }
            };
            return subjectMap[subjectKey] || { subject: subjectKey, class: 'subject-default' };
        }

        // Period structure with grade-based subjects
        const periodStructure = {
            1: {
                7: { subject: 'Civics', key: '7th_civics', color: '#3B82F6', class: 'subject-civics' },
                9: { subject: 'English Language Arts', key: '9th_ela', color: '#8B5CF6', class: 'subject-ela' },
                11: { subject: 'Pre-Calculus', key: '11th_math', color: '#10B981', class: 'subject-math' }
            },
            2: {
                7: { subject: 'English Language Arts', key: '7th_ela', color: '#8B5CF6', class: 'subject-ela' },
                9: { subject: 'World History', key: '9th_world_history', color: '#EF4444', class: 'subject-history' },
                11: { subject: 'U.S. Government', key: '11th_us_gvmnt', color: '#3B82F6', class: 'subject-government' }
            },
            3: {
                7: { subject: 'Pre-Algebra', key: '7th_math', color: '#10B981', class: 'subject-math' },
                9: { subject: 'Geometry', key: '9th_math', color: '#10B981', class: 'subject-math' }
            },
            4: {
                7: { subject: 'Life Science', key: '7th_science', color: '#F59E0B', class: 'subject-science' }
            }
        };

        // Initialize: Load enhancements from database, then render UI
        document.addEventListener('DOMContentLoaded', async () => {
            await loadLessonEnhancements();
            await loadLessonOverrides(); // Load teacher schedule modifications
            await loadStudentAssignments(); // Load student assignments from database
            populateSubjectFilter();
            populateCourseList(); // Populate sidebar course list
            updateProgressStats();
            refreshDashboard(); // Populate dashboard cards
            renderView();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Subject filter
            document.getElementById('subjectFilter').addEventListener('change', (e) => {
                subjectFilter = e.target.value;
                renderView();
            });

            // Period filter
            document.getElementById('periodFilter').addEventListener('change', (e) => {
                periodFilter = e.target.value;
                renderView();
            });

            // Month navigation
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

            // View toggle
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentView = btn.dataset.view;
                    renderView();
                });
            });
        }

        // Render current view
        function renderView() {
            // Hide all views
            document.getElementById('calendarView').style.display = 'none';
            document.getElementById('dayView').style.display = 'none';
            document.getElementById('weekView').style.display = 'none';
            document.getElementById('listView').style.display = 'none';
            document.getElementById('calendarNav').style.display = 'none';

            // Show appropriate view
            if (currentView === 'calendar') {
                document.getElementById('calendarView').style.display = 'block';
                document.getElementById('calendarNav').style.display = 'flex';
                renderCalendar();
            } else if (currentView === 'day') {
                document.getElementById('dayView').style.display = 'block';
                renderDayView();
            } else if (currentView === 'week') {
                document.getElementById('weekView').style.display = 'block';
                renderWeekView();
            } else if (currentView === 'list') {
                document.getElementById('listView').style.display = 'block';
                renderListView();
            }
        }

        // ==================== NEW DASHBOARD FUNCTIONS ====================

        // Render Today's Lessons Card
        function renderTodaysLessons() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            document.getElementById('todayDate').textContent = dateStr;

            const dayType = getABDay(dateKey);
            const dayNum = getDayNumber(dateKey, dayType);

            const container = document.getElementById('todayLessonsContent');

            if (!dayType) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ–ï¸</div>
                        <p>No school today!</p>
                    </div>
                `;
                return;
            }

            const dayKeyForLesson = `${dayNum}.${dayType}`;
            const periods = [1, 2, 3, 4];
            const lessonsHtml = [];

            periods.forEach(period => {
                const enrolledInPeriod = enrolledSubjects[period][dayType] || [];

                enrolledInPeriod.forEach(subjectKey => {
                    const lesson = window.curriculumData.getLesson(subjectKey, dayKeyForLesson);
                    if (lesson) {
                        const subjectInfo = getSubjectInfo(subjectKey);
                        const enhancementKey = `${dateKey}_${subjectKey}_${period}`;
                        const enhancement = lessonEnhancements[enhancementKey] || {};

                        // Calculate progress
                        const completion = lessonCompletions[enhancementKey] || { assignments: {} };
                        const assignments = getAssignmentsList(enhancement);
                        const completedCount = Object.values(completion.assignments || {}).filter(v => v === true).length;
                        const totalCount = assignments.length;
                        const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                        // Check if this lesson has an assigned assignment
                        const assignedWork = getAssignmentForLesson(enhancementKey);
                        let assignmentBadge = '';
                        if (assignedWork) {
                            const dueDate = new Date(assignedWork.due_date);
                            const formattedDue = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            const isOverdue = dueDate < new Date() && assignedWork.status === 'assigned';
                            const badgeClass = isOverdue ? 'overdue' : assignedWork.status === 'graded' ? 'graded' : 'assigned';
                            const icon = assignedWork.type.toLowerCase() === 'quiz' ? 'ðŸ“' : 'ðŸ“–';
                            assignmentBadge = `<div class="lesson-assignment-badge ${badgeClass}">${icon} ${assignedWork.type} Due ${formattedDue}</div>`;
                        }

                        // Format objectives as bullet list
                        const objectivesHtml = lesson.objectives && lesson.objectives.length > 0
                            ? `<div class="lesson-objectives">
                                <strong>Objectives:</strong>
                                <ul>
                                    ${lesson.objectives.map(obj => `<li>${obj}</li>`).join('')}
                                </ul>
                            </div>`
                            : '';

                        lessonsHtml.push(`
                            <div class="today-lesson-card" onclick="openDayModal('${dateKey}', '${dayType}', ${dayNum})">
                                <div class="today-lesson-header">
                                    <div class="today-lesson-period">Period ${period}</div>
                                    ${totalCount > 0 ? `<div style="font-size: 0.9em;">${completedCount}/${totalCount} complete</div>` : ''}
                                </div>
                                <div class="today-lesson-title">${subjectInfo.subject}</div>
                                <div style="font-size: 0.9em; margin-bottom: 10px; opacity: 0.9;">${lesson.title || 'Lesson ' + lesson.code}</div>
                                ${assignmentBadge}
                                ${objectivesHtml}
                                ${totalCount > 0 ? `
                                    <div class="today-lesson-progress">
                                        <div class="today-lesson-progress-bar">
                                            <div class="today-lesson-progress-fill" style="width: ${progressPercent}%"></div>
                                        </div>
                                        <span>${progressPercent}%</span>
                                    </div>
                                ` : ''}
                            </div>
                        `);
                    }
                });
            });

            if (lessonsHtml.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <p>No lessons scheduled for today</p>
                    </div>
                `;
            } else {
                container.innerHTML = lessonsHtml.join('');
            }
        }

        // Helper function to find assigned work for a specific lesson
        function getAssignmentForLesson(lessonKey) {
            if (!studentAssignments || studentAssignments.length === 0) return null;

            // Find assignments that match this lesson_key
            return studentAssignments.find(a => a.lesson_key === lessonKey);
        }

        // Helper to get list of all assignments for a lesson
        function getAssignmentsList(enhancement) {
            const assignments = [];
            if (enhancement.notes) assignments.push({ type: 'read', label: 'Read Notes' });
            if (enhancement.quiz) assignments.push({ type: 'quiz', label: 'Take Quiz' });
            if (enhancement.activities) assignments.push({ type: 'activity', label: 'Complete Activities' });
            if (enhancement.videos && enhancement.videos.length > 0) assignments.push({ type: 'video', label: 'Watch Video' });
            if (enhancement.docs && enhancement.docs.length > 0) assignments.push({ type: 'docs', label: 'Review Documents' });
            return assignments;
        }

        // Render Upcoming Assignments
        function renderUpcomingAssignments() {
            const container = document.getElementById('upcomingAssignmentsContent');
            const today = new Date();
            const assignments = [];

            // Look ahead 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateKey = `${year}-${month}-${day}`;

                const dayType = getABDay(dateKey);
                if (!dayType) continue;

                const dayNum = getDayNumber(dateKey, dayType);
                const dayKeyForLesson = `${dayNum}.${dayType}`;

                [1, 2, 3, 4].forEach(period => {
                    const enrolledInPeriod = enrolledSubjects[period][dayType] || [];

                    enrolledInPeriod.forEach(subjectKey => {
                        const lesson = window.curriculumData.getLesson(subjectKey, dayKeyForLesson);
                        if (lesson) {
                            const subjectInfo = getSubjectInfo(subjectKey);
                            const enhancementKey = `${dateKey}_${subjectKey}_${period}`;
                            const enhancement = lessonEnhancements[enhancementKey] || {};
                            const completion = lessonCompletions[enhancementKey] || { assignments: {} };

                            const assignmentsList = getAssignmentsList(enhancement);
                            assignmentsList.forEach(assignment => {
                                const assignmentKey = `${assignment.type}_${enhancementKey}`;
                                const isCompleted = completion.assignments?.[assignmentKey] || false;

                                if (!isCompleted) {
                                    assignments.push({
                                        date: date,
                                        dateKey: dateKey,
                                        dayType: dayType,
                                        dayNum: dayNum,
                                        period: period,
                                        subject: subjectInfo.subject,
                                        subjectKey: subjectKey,
                                        lessonTitle: lesson.title || lesson.code,
                                        assignmentType: assignment.label,
                                        daysUntilDue: i
                                    });
                                }
                            });
                        }
                    });
                });
            }

            if (assignments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ…</div>
                        <p>All caught up! No pending assignments.</p>
                    </div>
                `;
                return;
            }

            // Group by due date
            const dueToday = assignments.filter(a => a.daysUntilDue === 0);
            const dueTomorrow = assignments.filter(a => a.daysUntilDue === 1);
            const dueThisWeek = assignments.filter(a => a.daysUntilDue > 1);

            let html = '';

            if (dueToday.length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="color: #dc3545; margin-bottom: 12px;">ðŸ”´ Due Today (${dueToday.length})</h4>
                    ${dueToday.map(a => createAssignmentHTML(a, 'due-today')).join('')}
                </div>`;
            }

            if (dueTomorrow.length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="color: #ffc107; margin-bottom: 12px;">âš ï¸ Due Tomorrow (${dueTomorrow.length})</h4>
                    ${dueTomorrow.map(a => createAssignmentHTML(a, 'due-tomorrow')).join('')}
                </div>`;
            }

            if (dueThisWeek.length > 0) {
                html += `<div>
                    <h4 style="color: #0ea5e9; margin-bottom: 12px;">ðŸ“… Due This Week (${dueThisWeek.length})</h4>
                    ${dueThisWeek.slice(0, 5).map(a => createAssignmentHTML(a, 'due-week')).join('')}
                    ${dueThisWeek.length > 5 ? `<p style="text-align: center; color: #6c757d; margin-top: 10px;">+${dueThisWeek.length - 5} more...</p>` : ''}
                </div>`;
            }

            container.innerHTML = html;
        }

        function createAssignmentHTML(assignment, className) {
            const dateStr = assignment.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            return `
                <div class="assignment-item ${className}" onclick="openDayModal('${assignment.dateKey}', '${assignment.dayType}', ${assignment.dayNum})">
                    <div class="assignment-header">
                        <div class="assignment-title">${assignment.assignmentType}</div>
                        <div class="assignment-badge ${className}">
                            ${assignment.daysUntilDue === 0 ? 'TODAY' : assignment.daysUntilDue === 1 ? 'TOMORROW' : dateStr}
                        </div>
                    </div>
                    <div class="assignment-meta">
                        <span>ðŸ“š ${assignment.subject}</span>
                        <span>ðŸ“ ${assignment.lessonTitle}</span>
                        <span>â° Period ${assignment.period}</span>
                    </div>
                </div>
            `;
        }

        // Helper function to check if student is enrolled in a subject
        function isStudentEnrolledInSubject(subjectKey) {
            for (let period = 1; period <= 4; period++) {
                const aDaySubjects = enrolledSubjects[period].A || [];
                const bDaySubjects = enrolledSubjects[period].B || [];
                if (aDaySubjects.includes(subjectKey) || bDaySubjects.includes(subjectKey)) {
                    return true;
                }
            }
            return false;
        }

        // Render Subject Progress
        function renderSubjectProgress() {
            const container = document.getElementById('subjectProgressContent');
            const subjectStats = {};

            // Calculate progress for each subject
            Object.keys(lessonCompletions).forEach(lessonKey => {
                // Extract subject key from enhancement key format: YYYY-MM-DD_subjectKey_period
                const parts = lessonKey.split('_');
                if (parts.length < 2) return;
                const subjectKey = parts[1];

                // Only process subjects the student is enrolled in
                if (!isStudentEnrolledInSubject(subjectKey)) return;

                if (!subjectStats[subjectKey]) {
                    subjectStats[subjectKey] = {
                        totalAssignments: 0,
                        completedAssignments: 0
                    };
                }

                const completion = lessonCompletions[lessonKey];
                if (completion && completion.assignments) {
                    const assignments = Object.values(completion.assignments);
                    subjectStats[subjectKey].totalAssignments += assignments.length;
                    subjectStats[subjectKey].completedAssignments += assignments.filter(a => a === true).length;
                }
            });

            // Also count assignments from enhancements (even if not started)
            Object.keys(lessonEnhancements).forEach(enhancementKey => {
                const parts = enhancementKey.split('_');
                if (parts.length < 2) return;
                const subjectKey = parts[1];
                const enhancement = lessonEnhancements[enhancementKey];

                // Only process subjects the student is enrolled in
                if (!isStudentEnrolledInSubject(subjectKey)) return;

                if (!subjectStats[subjectKey]) {
                    subjectStats[subjectKey] = {
                        totalAssignments: 0,
                        completedAssignments: 0
                    };
                }

                const assignmentsList = getAssignmentsList(enhancement);
                subjectStats[subjectKey].totalAssignments += assignmentsList.length;
            });

            const subjects = Object.keys(subjectStats).filter(key => subjectStats[key].totalAssignments > 0);

            if (subjects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“ˆ</div>
                        <p>No assignments yet!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            subjects.forEach(subjectKey => {
                const stats = subjectStats[subjectKey];
                const subjectInfo = getSubjectInfo(subjectKey);
                const percent = stats.totalAssignments > 0 ? Math.round((stats.completedAssignments / stats.totalAssignments) * 100) : 0;

                html += `
                    <div class="subject-progress-item">
                        <div class="subject-progress-name">${subjectInfo.subject}</div>
                        <div class="subject-progress-bar-container">
                            <div class="subject-progress-bar-fill" style="width: ${percent}%"></div>
                        </div>
                        <div class="subject-progress-percent">${percent}%</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Refresh all dashboard cards
        function refreshDashboard() {
            renderTodaysLessons();
            renderUpcomingAssignments();
            renderSubjectProgress();
            updateProgressStats();
        }

        // ==================== END NEW DASHBOARD FUNCTIONS ====================

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('currentMonth').textContent =
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Header row
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Calendar days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            // Previous month padding
            for (let i = startPadding - 1; i >= 0; i--) {
                const cell = createDayCell(new Date(year, month - 1, prevLastDay.getDate() - i), true);
                grid.appendChild(cell);
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = createDayCell(new Date(year, month, day), false);
                grid.appendChild(cell);
            }

            // Next month padding
            const totalCells = grid.children.length - 7;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDayCell(new Date(year, month + 1, day), true);
                grid.appendChild(cell);
            }
        }

        function createDayCell(date, isOtherMonth) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            if (isOtherMonth) cell.classList.add('other-month');

            // Check if weekend BEFORE any other processing
            const dayOfWeek = date.getDay();
            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);

            // Create date string without timezone issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            const dayType = isWeekend ? null : getABDay(dateStr);
            const isNoSchool = schoolCalendar.noSchoolDays.has(dateStr);
            const isHalfDay = schoolCalendar.noonDismissals.has(dateStr);

            if (isNoSchool) cell.classList.add('no-school');
            if (isHalfDay) cell.classList.add('half-day');

            let html = `<div class="day-number">${date.getDate()}</div>`;

            if (dayType && !isNoSchool && !isWeekend) {
                const dayNum = getDayNumber(dateStr, dayType);
                html += `<div class="day-type ${dayType.toLowerCase()}-day">Day ${dayNum} - ${dayType}</div>`;
                html += `<div class="period-sections">`;

                // Show only lessons student is enrolled in for this specific day type
                const periods = periodFilter === 'all' ? [1, 2, 3, 4] : [parseInt(periodFilter)];
                periods.forEach(period => {
                    const enrolledInPeriod = enrolledSubjects[period][dayType] || [];

                    if (enrolledInPeriod.length > 0) {
                        enrolledInPeriod.forEach(subjectKey => {
                            // Apply subject filter
                            if (subjectFilter !== 'all' && subjectKey !== subjectFilter) {
                                return;
                            }

                            const dayKey = `${dayNum}.${dayType}`;
                            const lessons = getLessonsForDay(subjectKey, dayKey, period, studentGrade, dateStr);

                            if (lessons.length > 0) {
                                // Get subject display info
                                const subjectInfo = getSubjectInfo(subjectKey);

                                lessons.forEach(lesson => {
                                    const isAdded = lesson.isOverride;
                                    const badge = isAdded ? ' <span style="background: #10b981; color: white; padding: 2px 4px; border-radius: 3px; font-size: 0.6em;">ADDED</span>' : '';

                                    html += `
                                        <div class="period-section ${isAdded ? 'lesson-override' : ''}">
                                            <div class="period-label">Period ${period}${badge}</div>
                                            <div class="lesson-item ${subjectInfo.class}" title="${lesson.title}">
                                                ${subjectInfo.subject}
                                            </div>
                                        </div>
                                    `;
                                });
                            }
                        });
                    }
                });

                html += `</div>`;
            } else if (isNoSchool) {
                html += `<div style="color: #dc3545; font-weight: 600; margin-top: 10px;">No School</div>`;
            } else if (isHalfDay) {
                html += `<div style="color: #ffc107; font-weight: 600; margin-top: 10px;">Half Day</div>`;
            }

            cell.innerHTML = html;

            if (dayType && !isNoSchool) {
                cell.addEventListener('click', () => showDayDetails(date, dayType, getDayNumber(dateStr, dayType)));
            }

            return cell;
        }

        function showDayDetails(date, dayType, dayNum) {
            const modal = document.getElementById('dayModal');
            const modalBody = document.getElementById('modalBody');

            const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const dayKey = `${dayNum}.${dayType}`;

            // Create date key without timezone issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            // Teacher enhancements are already loaded from Supabase in the global lessonEnhancements variable

            let html = `
                <div class="modal-header">
                    <h2>${dateStr}</h2>
                    <div class="day-info">Day ${dayNum} - ${dayType} Day</div>
                </div>
            `;

            // Track if we need completion checkboxes (collect all lesson keys first)
            const lessonKeysInModal = [];

            // IMPORTANT: Show ALL lessons for this day regardless of filters
            // Filters only apply to calendar/week/list views, NOT the day detail modal
            const periods = [1, 2, 3, 4]; // Always show all periods in modal
            periods.forEach(period => {
                const enrolledInPeriod = enrolledSubjects[period][dayType] || [];

                enrolledInPeriod.forEach(subjectKey => {
                    // NO FILTERING in day modal - students need to see all their classes
                    const lesson = window.curriculumData.getLesson(subjectKey, dayKey);

                    if (lesson) {
                        const subjectInfo = getSubjectInfo(subjectKey);
                        // Get the enhancement key (same format as teacher/admin dashboards)
                        const enhancementKey = `${dateKey}_${subjectKey}_${period}`;
                        const enhancement = lessonEnhancements[enhancementKey] || {};

                        // Track lesson completion
                        const lessonKey = enhancementKey;
                        const isCompleted = isLessonCompleted(lessonKey);
                        lessonKeysInModal.push(lessonKey);

                        html += `
                            <div class="period-detail">
                                <h3>Period ${period}: ${subjectInfo.subject}</h3>

                                <div class="lesson-card">
                                    <h4 style="color: #667eea">${lesson.title}</h4>

                                    <!-- Assignment Checklist - Students must complete all to finish lesson -->
                                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                        <h4 style="color: #0369a1; margin-bottom: 10px;">ðŸ“‹ Assignments to Complete</h4>
                                        <div id="assignments_${lessonKey}" style="display: flex; flex-direction: column; gap: 8px;">
                                            ${getAssignmentChecklist(lessonKey, enhancement)}
                                        </div>
                                    </div>
                                    ${lesson.objectives ? `<p><strong>Objectives:</strong> ${lesson.objectives}</p>` : ''}
                                    ${lesson.materials ? `<p><strong>Materials:</strong> ${lesson.materials}</p>` : ''}
                                    ${lesson.activities ? `<p><strong>Activities:</strong> ${lesson.activities}</p>` : ''}

                                    ${enhancement.notes ? `
                                        <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 2px solid #0ea5e9;">
                                            <h4 style="color: #0369a1; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>âœ¨</span> Enhanced Content from Your Teacher
                                            </h4>
                                            <div id="notes_${enhancementKey}" class="markdown-content"></div>
                                        </div>
                                    ` : ''}

                                    ${enhancement.quiz ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #047857; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>ðŸ“</span> Quiz for This Lesson
                                            </h4>
                                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px;">
                                                ${formatQuizQuestions(enhancement.quiz)}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${enhancement.activities ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #6d28d9; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>ðŸŽ¯</span> Class Activities
                                            </h4>
                                            <div style="background: #faf5ff; padding: 15px; border-radius: 8px;">
                                                ${formatInClassActivities(enhancement.activities)}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${enhancement.rubric ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #f59e0b; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #d97706; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>ðŸ“Š</span> Grading Rubric
                                            </h4>
                                            <div style="background: #fffbeb; padding: 15px; border-radius: 8px;">
                                                ${formatGradingRubric(enhancement.rubric)}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${(enhancement.videos && enhancement.videos.length > 0) ? `
                                        <div style="margin-top: 15px;">
                                            <h4 style="color: #667eea; margin-bottom: 10px;">ðŸŽ¥ Videos</h4>
                                            ${enhancement.videos.map(video => `
                                                <div style="margin-bottom: 8px;">
                                                    <a href="${video}" target="_blank" style="color: #4f46e5; text-decoration: underline;">${video}</a>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}

                                    ${(enhancement.docs && enhancement.docs.length > 0) ? `
                                        <div style="margin-top: 15px;">
                                            <h4 style="color: #667eea; margin-bottom: 10px;">ðŸ“„ Documents</h4>
                                            ${enhancement.docs.map(doc => `
                                                <div style="margin-bottom: 8px;">
                                                    <a href="${doc}" target="_blank" style="color: #4f46e5; text-decoration: underline;">${doc}</a>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}

                                    ${(enhancement.links && enhancement.links.length > 0) ? `
                                        <div style="margin-top: 15px;">
                                            <h4 style="color: #667eea; margin-bottom: 10px;">ðŸ”— Additional Resources</h4>
                                            ${enhancement.links.map(link => `
                                                <div style="margin-bottom: 8px;">
                                                    <a href="${link}" target="_blank" style="color: #4f46e5; text-decoration: underline;">${link}</a>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}

                                    ${enhancement.aiExpand ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #0ea5e9; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #0369a1; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>ðŸ“</span> Expanded Content
                                            </h4>
                                            <div class="markdown-content">${typeof marked !== 'undefined' ? marked.parse(enhancement.aiExpand) : enhancement.aiExpand}</div>
                                        </div>
                                    ` : ''}

                                    ${enhancement.aiSimplify ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #3b82f6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #1e40af; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>âœ¨</span> Simplified Text
                                            </h4>
                                            <div class="markdown-content">${typeof marked !== 'undefined' ? marked.parse(enhancement.aiSimplify) : enhancement.aiSimplify}</div>
                                        </div>
                                    ` : ''}

                                    ${enhancement.aiQuestions ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #6d28d9; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>â“</span> Discussion Questions
                                            </h4>
                                            <div class="markdown-content">${typeof marked !== 'undefined' ? marked.parse(enhancement.aiQuestions) : enhancement.aiQuestions}</div>
                                        </div>
                                    ` : ''}

                                    ${enhancement.aiActivities ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #047857; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>ðŸŽ¯</span> Suggested Activities
                                            </h4>
                                            <div class="markdown-content">${typeof marked !== 'undefined' ? marked.parse(enhancement.aiActivities) : enhancement.aiActivities}</div>
                                        </div>
                                    ` : ''}

                                    ${enhancement.aiAssessment ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #f59e0b; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #d97706; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>ðŸ“Š</span> Quiz Questions
                                            </h4>
                                            <div class="markdown-content">${typeof marked !== 'undefined' ? marked.parse(enhancement.aiAssessment) : enhancement.aiAssessment}</div>
                                        </div>
                                    ` : ''}

                                    ${enhancement.aiDifferentiate ? `
                                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #ec4899; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <h4 style="color: #be185d; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <span>ðŸŽ“</span> Differentiation Tips
                                            </h4>
                                            <div class="markdown-content">${typeof marked !== 'undefined' ? marked.parse(enhancement.aiDifferentiate) : enhancement.aiDifferentiate}</div>
                                        </div>
                                    ` : ''}

                                    <div class="lesson-meta">
                                        <div class="meta-badge" style="background: #667eea; color: white;">
                                            ${lesson.code || 'Standard'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // After HTML is inserted, render markdown for notes
                        setTimeout(() => {
                            if (enhancement.notes) {
                                const notesDiv = document.getElementById(`notes_${enhancementKey}`);
                                if (notesDiv && typeof marked !== 'undefined') {
                                    try {
                                        notesDiv.innerHTML = marked.parse(enhancement.notes);
                                    } catch (error) {
                                        console.error('Markdown parsing error:', error);
                                        notesDiv.textContent = enhancement.notes;
                                    }
                                }
                            }
                        }, 50);
                    }
                });
            });

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('dayModal').classList.remove('active');
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        // Render Day View (today's schedule)
        function renderDayView() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            const dayOfWeek = today.getDay();
            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
            const isNoSchool = schoolCalendar.noSchoolDays.has(dateStr);
            const dayType = isWeekend ? null : getABDay(dateStr);

            let html = `
                <div class="day-view-header">
                    <h2>${today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h2>
                    ${dayType ? `<div class="day-info">Day ${getDayNumber(dateStr, dayType)} - ${dayType} Day</div>` : ''}
                </div>
            `;

            if (isWeekend || isNoSchool || !dayType) {
                html += `<div style="text-align: center; padding: 60px; color: #6c757d;">
                    <h3>${isWeekend ? 'ðŸŽ‰ Weekend!' : 'ðŸ–ï¸ No School Today'}</h3>
                    <p>Enjoy your day off!</p>
                </div>`;
            } else {
                const dayNum = getDayNumber(dateStr, dayType);
                const dayKey = `${dayNum}.${dayType}`;

                html += `<div class="day-view-periods">`;

                const periods = periodFilter === 'all' ? [1, 2, 3, 4] : [parseInt(periodFilter)];
                periods.forEach(period => {
                    const enrolledInPeriod = enrolledSubjects[period][dayType] || [];

                    if (enrolledInPeriod.length > 0) {
                        // Filter subjects for this period
                        const filteredSubjects = enrolledInPeriod.filter(subjectKey =>
                            subjectFilter === 'all' || subjectKey === subjectFilter
                        );

                        if (filteredSubjects.length > 0) {
                            html += `<div class="day-view-period">
                                <h3>Period ${period}</h3>`;

                            filteredSubjects.forEach(subjectKey => {
                                const lesson = window.curriculumData.getLesson(subjectKey, dayKey);
                                if (lesson) {
                                const subjectInfo = getSubjectInfo(subjectKey);
                                const lessonKey = `${dateStr}_${subjectKey}_${period}`;
                                const completed = isLessonCompleted(lessonKey);

                                html += `
                                    <div class="day-view-lesson ${completed ? 'completed' : ''}" onclick="showLessonDetails('${dateStr}', '${dayType}', ${dayNum}, ${period}, '${subjectKey}')">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <h4 style="margin: 0 0 5px 0; color: #667eea;">${subjectInfo.subject}</h4>
                                                <p style="margin: 0; color: #6c757d;">${lesson.title}</p>
                                            </div>
                                            <span class="completion-badge ${completed ? 'complete' : 'incomplete'}">
                                                ${completed ? 'âœ“ Complete' : 'Not Started'}
                                            </span>
                                        </div>
                                    </div>
                                `;
                                }
                            });

                            html += `</div>`;
                        }
                    }
                });

                html += `</div>`;
            }

            document.getElementById('dayView').innerHTML = html;
        }

        // Render Week View (current week's schedule)
        function renderWeekView() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - dayOfWeek + 1); // Monday

            let html = `
                <div class="day-view-header">
                    <h2>Week of ${startOfWeek.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</h2>
                </div>
                <div class="week-grid">
            `;

            // Render 5 weekdays (Monday-Friday)
            for (let i = 0; i < 5; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;

                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();
                const isNoSchool = schoolCalendar.noSchoolDays.has(dateStr);
                const dayType = isNoSchool ? null : getABDay(dateStr);

                html += `<div class="week-day">
                    <div class="week-day-header">
                        ${dayName} ${dayNum}
                        ${dayType ? `<br><span style="font-size: 0.8em; color: #667eea;">Day ${getDayNumber(dateStr, dayType)} - ${dayType}</span>` : ''}
                    </div>`;

                if (isNoSchool || !dayType) {
                    html += `<div style="text-align: center; padding: 20px; color: #6c757d; font-size: 0.9em;">No School</div>`;
                } else {
                    const dayKey = `${getDayNumber(dateStr, dayType)}.${dayType}`;
                    const periods = periodFilter === 'all' ? [1, 2, 3, 4] : [parseInt(periodFilter)];

                    periods.forEach(period => {
                        const enrolledInPeriod = enrolledSubjects[period][dayType] || [];
                        enrolledInPeriod.forEach(subjectKey => {
                            // Apply subject filter
                            if (subjectFilter !== 'all' && subjectKey !== subjectFilter) {
                                return;
                            }

                            const lesson = window.curriculumData.getLesson(subjectKey, dayKey);
                            if (lesson) {
                                const subjectInfo = getSubjectInfo(subjectKey);
                                const lessonKey = `${dateStr}_${subjectKey}_${period}`;
                                const completed = isLessonCompleted(lessonKey);

                                html += `
                                    <div class="day-view-lesson ${completed ? 'completed' : ''}" onclick="showLessonDetails('${dateStr}', '${dayType}', ${getDayNumber(dateStr, dayType)}, ${period}, '${subjectKey}')" style="margin-bottom: 8px; padding: 10px; font-size: 0.85em;">
                                        <div style="font-weight: 600; margin-bottom: 3px;">P${period}: ${subjectInfo.subject}</div>
                                        <div style="font-size: 0.9em; color: #6c757d;">${lesson.title.length > 30 ? lesson.title.substring(0, 30) + '...' : lesson.title}</div>
                                    </div>
                                `;
                            }
                        });
                    });
                }

                html += `</div>`;
            }

            html += `</div>`;
            document.getElementById('weekView').innerHTML = html;
        }

        // Render List View (chronological list of all lessons)
        function renderListView() {
            const allLessons = getAllLessons();

            let html = `
                <div class="day-view-header">
                    <h2>All Lessons</h2>
                </div>
                <div class="list-view-filters">
                    <button class="filter-btn ${listFilter === 'all' ? 'active' : ''}" onclick="setListFilter('all')">All</button>
                    <button class="filter-btn ${listFilter === 'completed' ? 'active' : ''}" onclick="setListFilter('completed')">Completed</button>
                    <button class="filter-btn ${listFilter === 'incomplete' ? 'active' : ''}" onclick="setListFilter('incomplete')">Not Started</button>
                </div>
                <div class="list-view-items">
            `;

            const filteredLessons = allLessons.filter(l => {
                if (listFilter === 'completed') return l.completed;
                if (listFilter === 'incomplete') return !l.completed;
                return true;
            });

            // Apply period filter
            const periodFilteredLessons = periodFilter === 'all'
                ? filteredLessons
                : filteredLessons.filter(l => l.period === parseInt(periodFilter));

            if (periodFilteredLessons.length === 0) {
                html += `<div style="text-align: center; padding: 60px; color: #6c757d;">
                    <h3>No lessons found</h3>
                    <p>Try changing your filters</p>
                </div>`;
            } else {
                periodFilteredLessons.forEach(l => {
                    const subjectInfo = getSubjectInfo(l.subjectKey);
                    html += `
                        <div class="list-view-item ${l.completed ? 'completed' : ''}" onclick="showLessonDetails('${l.dateStr}', '${l.dayType}', ${l.dayNum}, ${l.period}, '${l.subjectKey}')">
                            <div class="list-item-header">
                                <div class="list-item-title">${l.lesson.title}</div>
                                <span class="completion-badge ${l.completed ? 'complete' : 'incomplete'}">
                                    ${l.completed ? 'âœ“ Complete' : 'Not Started'}
                                </span>
                            </div>
                            <div class="list-item-meta">
                                <span class="list-item-date">${l.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                <span>â€¢</span>
                                <span>Period ${l.period}: ${subjectInfo.subject}</span>
                                <span>â€¢</span>
                                <span>Day ${l.dayNum} - ${l.dayType}</span>
                            </div>
                        </div>
                    `;
                });
            }

            html += `</div>`;
            document.getElementById('listView').innerHTML = html;
        }

        function setListFilter(filter) {
            listFilter = filter;
            renderListView();
        }

        // Show lesson details in modal (wrapper function for different views)
        function showLessonDetails(dateStr, dayType, dayNum, period, subjectKey) {
            const date = new Date(dateStr);
            showDayDetails(date, dayType, dayNum);
        }

        function logout() {
            localStorage.removeItem('currentStudent');
            window.location.href = 'index.html';
        }

        // Sidebar Navigation Functions
        let selectedCourse = null;
        let currentNavSection = 'lessons';

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
                document.getElementById('mainContent').classList.toggle('expanded');
            }
        }

        function populateCourseList() {
            const courseListEl = document.getElementById('courseList');
            const uniqueCourses = new Set();

            // Extract all unique courses from enrolledSubjects
            Object.values(enrolledSubjects).forEach(periodData => {
                Object.values(periodData).forEach(subjects => {
                    subjects.forEach(subjectKey => uniqueCourses.add(subjectKey));
                });
            });

            if (uniqueCourses.size === 0) {
                courseListEl.innerHTML = '<p style="opacity: 0.7; font-size: 0.9em; padding: 10px;">No courses enrolled</p>';
                return;
            }

            // Get course icons
            const courseIcons = {
                '7th_civics': 'ðŸ›ï¸',
                '7th_ela': 'ðŸ“–',
                '7th_math': 'ðŸ”¢',
                '7th_science': 'ðŸ”¬',
                '9th_ela': 'ðŸ“š',
                '9th_math': 'ðŸ“',
                '9th_world_history': 'ðŸŒ',
                '11th_ela': 'âœï¸',
                '11th_math': 'ðŸ“Š',
                '11th_us_gvmnt': 'ðŸ›ï¸'
            };

            let coursesHtml = '';
            Array.from(uniqueCourses).sort().forEach(subjectKey => {
                const subjectInfo = getSubjectInfo(subjectKey);
                const icon = courseIcons[subjectKey] || 'ðŸ“š';
                const progress = calculateCourseProgress(subjectKey);

                coursesHtml += `
                    <div class="course-item ${selectedCourse === subjectKey ? 'active' : ''}"
                         onclick="selectCourse('${subjectKey}')">
                        <div class="course-item-header">
                            <span class="course-icon">${icon}</span>
                            <span class="course-name">${subjectInfo.subject}</span>
                        </div>
                        <div class="course-progress">
                            <div class="course-progress-bar">
                                <div class="course-progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="course-progress-text">${progress}% Complete</div>
                        </div>
                    </div>
                `;
            });

            courseListEl.innerHTML = coursesHtml;
        }

        function calculateCourseProgress(subjectKey) {
            let totalLessons = 0;
            let completedLessons = 0;

            // Count all lessons for this subject
            if (window.curriculumData && window.curriculumData.subjects) {
                const subjectData = window.curriculumData.subjects[subjectKey];
                if (subjectData && subjectData.lessons) {
                    Object.keys(subjectData.lessons).forEach(lessonKey => {
                        totalLessons++;
                        if (isLessonCompleted(lessonKey)) {
                            completedLessons++;
                        }
                    });
                }
            }

            return totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
        }

        function selectCourse(subjectKey) {
            selectedCourse = subjectKey;
            populateCourseList(); // Refresh to update active state

            // Show course navigation menu
            document.getElementById('courseNavMenu').style.display = 'block';

            // Update assignment badge
            updateAssignmentBadge(subjectKey);

            // Filter the main view to show only this course
            subjectFilter = subjectKey;
            renderView();

            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function updateAssignmentBadge(subjectKey) {
            // Count incomplete assignments for this course
            let incompleteCount = 0;

            if (window.curriculumData && window.curriculumData.subjects) {
                const subjectData = window.curriculumData.subjects[subjectKey];
                if (subjectData && subjectData.lessons) {
                    Object.keys(subjectData.lessons).forEach(lessonKey => {
                        const completion = lessonCompletions[lessonKey];
                        if (!completion || !completion.assignments) {
                            incompleteCount++;
                        } else {
                            const assignments = completion.assignments;
                            const incompleteAssignments = Object.values(assignments).filter(done => !done);
                            incompleteCount += incompleteAssignments.length;
                        }
                    });
                }
            }

            const badge = document.getElementById('assignmentBadge');
            if (badge) {
                badge.textContent = incompleteCount;
                badge.style.display = incompleteCount > 0 ? 'inline-block' : 'none';
            }
        }

        function navigateTo(section) {
            currentNavSection = section;

            // Update active state in nav menu
            document.querySelectorAll('#courseNavMenu .nav-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-menu-item').classList.add('active');

            // Handle different sections
            switch(section) {
                case 'lessons':
                    currentView = 'calendar';
                    document.querySelector('.view-btn[data-view="calendar"]').click();
                    break;
                case 'assignments':
                    showAssignmentsView();
                    break;
                case 'quizzes':
                    showQuizzesView();
                    break;
                case 'grades':
                    showGradesView();
                    break;
                case 'resources':
                    showResourcesView();
                    break;
            }

            // Close mobile menu
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function showAllCourses() {
            selectedCourse = null;
            subjectFilter = 'all';
            document.getElementById('subjectFilter').value = 'all';
            document.getElementById('courseNavMenu').style.display = 'none';
            populateCourseList();
            renderView();

            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function showCalendar() {
            currentView = 'calendar';
            document.querySelector('.view-btn[data-view="calendar"]').click();

            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function showAssignmentsView() {
            // Switch to list view and filter for incomplete
            currentView = 'list';
            listFilter = 'incomplete';
            document.querySelector('.view-btn[data-view="list"]').click();
        }

        function showQuizzesView() {
            // Show quizzes - could filter lessons with quizzes
            currentView = 'list';
            renderView();
        }

        function showGradesView() {
            // Show progress stats prominently
            alert('Grades view - Your overall progress: ' + document.getElementById('progressPercent').textContent);
        }

        function showResourcesView() {
            // Show all resources across lessons
            alert('Resources view coming soon - will show videos, docs, and links from all lessons');
        }

        // Formatting functions for assessments (copied from teacher dashboard)
        function formatQuizQuestions(data) {
            if (data.rawContent) {
                return `<div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 2px solid #fca5a5;">
                    <p style="color: #991b1b; font-weight: 600; margin-bottom: 10px;">âš ï¸ Unable to parse structured data</p>
                    <pre style="background: white; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.85em;">${data.rawContent}</pre>
                </div>`;
            }

            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #047857; margin-bottom: 10px;">${data.quizTitle || 'Quiz'}</h3>
                    <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.9em; color: #065f46;">
                        <span><strong>Total Points:</strong> ${data.totalPoints || 'N/A'}</span>
                        <span><strong>Time:</strong> ${data.estimatedTime || 'N/A'}</span>
                    </div>
                </div>
            `;

            if (data.questions && data.questions.length > 0) {
                data.questions.forEach((q, index) => {
                    html += `
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4 style="color: #047857; margin: 0;">Question ${index + 1} (${q.type})</h4>
                                <span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${q.points} pts</span>
                            </div>
                            <p style="color: #1f2937; margin-bottom: 10px; line-height: 1.6;"><strong>${q.question}</strong></p>
                    `;

                    if (q.type === 'multiple-choice') {
                        html += `<div style="margin-left: 15px; margin-bottom: 10px;">`;
                        q.options.forEach(option => {
                            const isCorrect = option.startsWith(q.correctAnswer);
                            html += `<div style="padding: 6px; ${isCorrect ? 'background: #d1fae5; border-radius: 4px; font-weight: 600;' : ''}">${option}</div>`;
                        });
                        html += `</div>`;
                        if (q.explanation) {
                            html += `<div style="background: #e0f2fe; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.9em;">
                                <strong style="color: #0369a1;">Explanation:</strong> ${q.explanation}
                            </div>`;
                        }
                    } else if (q.type === 'short-answer') {
                        if (q.sampleAnswer) {
                            html += `<div style="margin-top: 10px;"><strong style="color: #059669;">Sample Answer:</strong> ${q.sampleAnswer}</div>`;
                        }
                        if (q.keyPoints) {
                            html += `<div style="margin-top: 10px;"><strong>Key Points to Look For:</strong><ul style="margin: 5px 0 0 20px;">`;
                            q.keyPoints.forEach(point => {
                                html += `<li style="color: #374151;">${point}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                    } else if (q.type === 'essay') {
                        if (q.promptGuidance) {
                            html += `<div style="margin-top: 10px;"><strong>Guidance:</strong> ${q.promptGuidance}</div>`;
                        }
                        if (q.requiredLength) {
                            html += `<div style="margin-top: 5px;"><strong>Required Length:</strong> ${q.requiredLength}</div>`;
                        }
                    } else if (q.type === 'drawing-diagram') {
                        if (q.diagramType) {
                            html += `<div style="margin-top: 10px;"><strong>Type:</strong> ${q.diagramType}</div>`;
                        }
                        if (q.requiredElements) {
                            html += `<div style="margin-top: 10px;"><strong>Required Elements:</strong><ul style="margin: 5px 0 0 20px;">`;
                            q.requiredElements.forEach(el => {
                                html += `<li style="color: #374151;">${el}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                    } else if (q.type === 'external-activity') {
                        if (q.activityType) {
                            html += `<div style="margin-top: 10px;"><strong>Activity Type:</strong> ${q.activityType}</div>`;
                        }
                        if (q.instructions) {
                            html += `<div style="margin-top: 10px;"><strong>Instructions:</strong> ${q.instructions}</div>`;
                        }
                        if (q.submissionFormat) {
                            html += `<div style="margin-top: 10px;"><strong>Submission Format:</strong> ${q.submissionFormat}</div>`;
                        }
                    }

                    html += `</div>`;
                });
            }

            return html;
        }

        function formatGradingRubric(data) {
            if (data.rawContent) {
                return `<div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 2px solid #fca5a5;">
                    <p style="color: #991b1b; font-weight: 600; margin-bottom: 10px;">âš ï¸ Unable to parse structured data</p>
                    <pre style="background: white; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.85em;">${data.rawContent}</pre>
                </div>`;
            }

            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #c2410c; margin-bottom: 10px;">${data.rubricTitle || 'Grading Rubric'}</h3>
                    <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.9em; color: #9a3412;">
                        <span><strong>Assessment Type:</strong> ${data.assessmentType || 'N/A'}</span>
                        <span><strong>Total Points:</strong> ${data.totalPoints || 'N/A'}</span>
                    </div>
                </div>
            `;

            if (data.criteria && data.criteria.length > 0) {
                data.criteria.forEach((criterion, index) => {
                    html += `
                        <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #c2410c; margin: 0;">${criterion.category}</h4>
                                <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${criterion.weight}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    `;

                    if (criterion.levels) {
                        criterion.levels.forEach(level => {
                            const levelColors = {
                                'Exemplary': '#10b981',
                                'Proficient': '#3b82f6',
                                'Developing': '#f59e0b',
                                'Beginning': '#ef4444'
                            };
                            const color = levelColors[level.level] || '#6b7280';
                            html += `
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid ${color};">
                                    <div style="font-weight: 600; color: ${color}; margin-bottom: 5px;">${level.level}</div>
                                    <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 8px;">${level.points}</div>
                                    <div style="font-size: 0.9em; color: #374151; line-height: 1.4;">${level.description}</div>
                                </div>
                            `;
                        });
                    }

                    html += `</div></div>`;
                });
            }

            if (data.gradingGuidelines && data.gradingGuidelines.length > 0) {
                html += `
                    <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="color: #0369a1; margin-bottom: 10px;">Grading Guidelines</h4>
                        <ul style="margin: 0 0 0 20px; color: #374151;">
                `;
                data.gradingGuidelines.forEach(guideline => {
                    html += `<li style="margin-bottom: 5px;">${guideline}</li>`;
                });
                html += `</ul></div>`;
            }

            if (data.feedbackPrompts) {
                html += `<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="color: #059669; margin-bottom: 10px;">Feedback Prompts</h4>
                `;
                if (data.feedbackPrompts.strengths) {
                    html += `<div style="margin-bottom: 10px;"><strong>Strengths:</strong><ul style="margin: 5px 0 0 20px; color: #374151;">`;
                    data.feedbackPrompts.strengths.forEach(s => html += `<li>${s}</li>`);
                    html += `</ul></div>`;
                }
                if (data.feedbackPrompts.improvements) {
                    html += `<div style="margin-bottom: 10px;"><strong>Areas for Improvement:</strong><ul style="margin: 5px 0 0 20px; color: #374151;">`;
                    data.feedbackPrompts.improvements.forEach(i => html += `<li>${i}</li>`);
                    html += `</ul></div>`;
                }
                if (data.feedbackPrompts.nextSteps) {
                    html += `<div><strong>Next Steps:</strong><ul style="margin: 5px 0 0 20px; color: #374151;">`;
                    data.feedbackPrompts.nextSteps.forEach(n => html += `<li>${n}</li>`);
                    html += `</ul></div>`;
                }
                html += `</div>`;
            }

            return html;
        }

        function formatInClassActivities(data) {
            if (data.rawContent) {
                return `<div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 2px solid #fca5a5;">
                    <p style="color: #991b1b; font-weight: 600; margin-bottom: 10px;">âš ï¸ Unable to parse structured data</p>
                    <pre style="background: white; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.85em;">${data.rawContent}</pre>
                </div>`;
            }

            let html = `<div style="margin-bottom: 20px;">
                <h3 style="color: #7c3aed; margin-bottom: 5px;">${data.lessonTitle || 'In-Class Activities'}</h3>
            </div>`;

            // Warm-up
            if (data.warmUp) {
                html += `
                    <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin-bottom: 8px;">ðŸ”¥ Warm-Up (${data.warmUp.duration})</h4>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 5px;">${data.warmUp.title}</div>
                        <div style="color: #374151;">${data.warmUp.activity}</div>
                    </div>
                `;
            }

            // Main Activities
            if (data.activities && data.activities.length > 0) {
                data.activities.forEach((activity, index) => {
                    html += `
                        <div style="background: #faf5ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #8b5cf6;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4 style="color: #6d28d9; margin: 0;">Activity ${index + 1}: ${activity.title}</h4>
                                <span style="background: #8b5cf6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${activity.duration}</span>
                            </div>
                            <div style="margin-bottom: 8px;"><strong>Type:</strong> <span style="text-transform: capitalize;">${activity.type}</span></div>
                            <div style="margin-bottom: 8px;"><strong>Objective:</strong> ${activity.objective}</div>
                            ${activity.materials && activity.materials.length > 0 ? `<div style="margin-bottom: 8px;"><strong>Materials:</strong> ${activity.materials.join(', ')}</div>` : ''}
                            ${activity.setup ? `<div style="margin-bottom: 8px;"><strong>Setup:</strong> ${activity.setup}</div>` : ''}
                            ${activity.procedure && activity.procedure.length > 0 ? `
                                <div style="margin: 10px 0;">
                                    <strong>Procedure:</strong>
                                    <ol style="margin: 5px 0 0 20px;">
                                        ${activity.procedure.map(step => `<li style="margin-bottom: 5px; color: #374151;">${step}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            ${activity.differentiation ? `
                                <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                    <strong style="color: #059669;">Differentiation:</strong>
                                    <div style="margin-top: 8px; font-size: 0.9em;">
                                        ${activity.differentiation.support ? `<div style="margin-bottom: 5px;"><strong>Support:</strong> ${activity.differentiation.support}</div>` : ''}
                                        ${activity.differentiation.extension ? `<div style="margin-bottom: 5px;"><strong>Extension:</strong> ${activity.differentiation.extension}</div>` : ''}
                                        ${activity.differentiation.ell ? `<div><strong>ELL:</strong> ${activity.differentiation.ell}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${activity.assessment ? `<div style="margin-top: 8px;"><strong>Assessment:</strong> ${activity.assessment}</div>` : ''}
                            ${activity.digitalTools && activity.digitalTools.length > 0 ? `<div style="margin-top: 8px;"><strong>Digital Tools:</strong> ${activity.digitalTools.join(', ')}</div>` : ''}
                        </div>
                    `;
                });
            }

            // Closure
            if (data.closure) {
                html += `
                    <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1;">
                        <h4 style="color: #4338ca; margin-bottom: 8px;">ðŸŽ¯ Closure (${data.closure.duration})</h4>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 5px;">${data.closure.title}</div>
                        <div style="color: #374151; margin-bottom: 8px;">${data.closure.activity}</div>
                        ${data.closure.exitTicket ? `<div style="background: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <strong style="color: #6366f1;">Exit Ticket:</strong> ${data.closure.exitTicket}
                        </div>` : ''}
                    </div>
                `;
            }

            return html;
        }

        // Legacy function - removed in favor of assignment tracking

        // Close modal on outside click
        document.getElementById('dayModal').addEventListener('click', (e) => {
            if (e.target.id === 'dayModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
