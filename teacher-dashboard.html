<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - AI Academy @ Centner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom, #f0f4f8 0%, #e2e8f0 100%);
            min-height: 100vh;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            color: white;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-bottom: 3px solid #fb923c;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header h1 span {
            font-weight: 400;
            opacity: 0.9;
            font-size: 0.5em;
            display: block;
            margin-top: 4px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .manage-students-btn {
            background: rgba(255,255,255,0.95);
            color: #ea580c;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .manage-students-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #ea580c;
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Teacher Tools */
        .teacher-tools {
            background: white;
            padding: 28px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .teacher-tools h2 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 1.3em;
            font-weight: 700;
        }

        .tool-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            align-items: stretch;
        }

        .tool-btn {
            padding: 16px 24px;
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 56px;
        }

        .tool-btn:hover {
            background: linear-gradient(135deg, #4338ca 0%, #4f46e5 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .tool-btn.secondary {
            background: #6c757d;
        }

        .tool-btn.secondary:hover {
            background: #5a6268;
        }

        /* Controls */
        .controls {
            background: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-group label {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            color: #1e293b;
            font-weight: 500;
            transition: all 0.2s;
        }

        select:hover {
            border-color: #4f46e5;
        }

        select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Calendar Navigation */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: white;
            padding: 24px 28px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .calendar-nav h2 {
            color: #1e293b;
            font-size: 1.5em;
            font-weight: 700;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.25);
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #4338ca 0%, #4f46e5 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        /* Calendar */
        .calendar {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
        }

        .calendar-header {
            text-align: center;
            font-weight: 700;
            color: #64748b;
            padding: 16px;
            background: #f8fafc;
            border-radius: 10px;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            min-height: 180px;
            padding: 14px;
            background: #fafbfc;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .calendar-day:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.15);
            border-color: #4f46e5;
            background: white;
        }

        .calendar-day.other-month {
            opacity: 0.25;
            pointer-events: none;
        }

        .calendar-day.no-school {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .calendar-day.half-day {
            background: #fffbeb;
            border-color: #fde68a;
        }

        .edit-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
            transition: all 0.2s;
        }

        .edit-indicator:hover {
            background: linear-gradient(135deg, #4338ca 0%, #4f46e5 100%);
            transform: scale(1.1);
        }

        .day-number {
            font-weight: 700;
            font-size: 1.3em;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .day-type {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: 0.3px;
        }

        .day-type.a-day {
            background: #dbeafe;
            color: #1e40af;
        }

        .day-type.b-day {
            background: #fef3c7;
            color: #92400e;
        }

        .period-sections {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .period-section {
            border-left: 3px solid #cbd5e1;
            padding-left: 10px;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .period-section:active {
            cursor: grabbing;
        }

        .period-section:hover {
            border-left-color: #4f46e5;
            transform: translateX(3px);
        }

        .lesson-override {
            border-left-color: #10b981 !important;
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
        }

        .lesson-override:hover {
            border-left-color: #059669 !important;
        }

        /* Drag and Drop Styles */
        .calendar-day.drag-over {
            background: #eef2ff;
            border: 2px dashed #4f46e5;
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
            transform: scale(1.02);
        }

        .period-label {
            font-size: 0.7em;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 4px;
            letter-spacing: 0.2px;
        }

        .lesson-item {
            padding: 10px;
            border-radius: 8px;
            font-size: 0.75em;
            color: white;
            margin-bottom: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .period-section:hover .lesson-item {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: scale(1.03);
        }

        /* Subject Colors - Muted & Professional */
        .subject-civics { background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); }
        .subject-ela { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }
        .subject-math { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .subject-science { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }
        .subject-history { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
        .subject-government { background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 44px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 32px;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: #ef4444;
            transform: rotate(90deg);
        }

        /* Edit Form */
        .edit-form {
            margin-top: 24px;
            padding: 24px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-save {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.25);
        }

        .btn-save:hover {
            background: linear-gradient(135deg, #4338ca 0%, #4f46e5 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .btn-save.secondary {
            background: #6c757d;
        }

        .btn-save.secondary:hover {
            background: #5a6268;
        }

        /* Attendance Styles */
        .attendance-period,
        .roster-period {
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            background: #f8f9fa;
        }

        .attendance-period h3,
        .roster-period h3 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .attendance-class,
        .roster-class {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .student-attendance-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }

        .student-attendance-row:hover {
            background: #f8f9fa;
        }

        .student-attendance-row:last-child {
            border-bottom: none;
        }

        .student-attendance-row label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            cursor: pointer;
        }

        .attendance-check {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .attendance-status {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attendance-status:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Grade Sliders */
        .grade-sliders {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .grade-slider-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }

        .grade-slider-label {
            font-size: 0.75em;
            color: #6c757d;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grade-value {
            font-size: 1.2em;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            background: #f8f9fa;
            min-width: 28px;
            text-align: center;
        }

        .grade-value.participation {
            color: #0ea5e9;
            border: 2px solid #0ea5e9;
        }

        .grade-value.effort {
            color: #8b5cf6;
            border: 2px solid #8b5cf6;
        }

        .grade-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            transition: background 0.2s;
        }

        .grade-slider:hover {
            background: #dee2e6;
        }

        .grade-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .grade-slider::-webkit-slider-thumb:hover {
            background: #5a67d8;
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .grade-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .grade-slider::-moz-range-thumb:hover {
            background: #5a67d8;
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .grade-slider.participation::-webkit-slider-thumb {
            background: #0ea5e9;
        }

        .grade-slider.participation::-webkit-slider-thumb:hover {
            background: #0284c7;
        }

        .grade-slider.effort::-webkit-slider-thumb {
            background: #8b5cf6;
        }

        .grade-slider.effort::-webkit-slider-thumb:hover {
            background: #7c3aed;
        }

        /* Roster Styles */
        .roster-day-type {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .roster-day-type h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .roster-day-type h5 {
            margin: 10px 0 5px 0;
        }

        .roster-day-type ul {
            margin: 5px 0;
            padding-left: 25px;
        }

        .roster-day-type li {
            padding: 5px 0;
            color: #495057;
        }

        .resource-list {
            margin-top: 15px;
        }

        .resource-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .resource-item input {
            flex: 1;
        }

        .btn-add {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Attendance Filters */
        .attendance-filters {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border: 2px solid #e5e7eb;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border-color: #4f46e5;
        }

        .filter-btn:hover {
            border-color: #4f46e5;
            transform: translateY(-1px);
        }

        .attendance-summary {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .summary-item h4 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .summary-item p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .day-number {
            font-weight: 700;
            font-size: 1.3em;
            color: #1e293b;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .day-number:hover {
            background: #eef2ff;
            color: #4f46e5;
            transform: scale(1.05);
        }

        /* Beautiful Markdown Content Styling */
        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.7;
            color: #2d3748;
        }

        .markdown-content h1 {
            font-size: 2em;
            font-weight: 700;
            color: #1a202c;
            margin: 1.5em 0 0.75em 0;
            padding-bottom: 0.3em;
            border-bottom: 3px solid #4f46e5;
        }

        .markdown-content h2 {
            font-size: 1.6em;
            font-weight: 600;
            color: #2d3748;
            margin: 1.25em 0 0.6em 0;
            padding-bottom: 0.25em;
            border-bottom: 2px solid #e2e8f0;
        }

        .markdown-content h3 {
            font-size: 1.3em;
            font-weight: 600;
            color: #4a5568;
            margin: 1em 0 0.5em 0;
        }

        .markdown-content h4 {
            font-size: 1.1em;
            font-weight: 600;
            color: #718096;
            margin: 0.8em 0 0.4em 0;
        }

        .markdown-content p {
            margin: 0.75em 0;
            line-height: 1.75;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 0.75em 0;
            padding-left: 2em;
        }

        .markdown-content li {
            margin: 0.5em 0;
            line-height: 1.6;
        }

        .markdown-content ul li {
            list-style-type: disc;
        }

        .markdown-content ul ul li {
            list-style-type: circle;
        }

        .markdown-content strong {
            font-weight: 600;
            color: #1a202c;
        }

        .markdown-content em {
            font-style: italic;
            color: #4a5568;
        }

        .markdown-content code {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #d63384;
        }

        .markdown-content pre {
            background: #2d3748;
            color: #f7fafc;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .markdown-content pre code {
            background: transparent;
            border: none;
            color: #f7fafc;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #4f46e5;
            padding-left: 1em;
            margin: 1em 0;
            color: #4a5568;
            font-style: italic;
            background: #f8f9fa;
            padding: 0.75em 1em;
            border-radius: 0 4px 4px 0;
        }

        .markdown-content hr {
            border: none;
            border-top: 2px solid #e2e8f0;
            margin: 2em 0;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .markdown-content th {
            background: #4f46e5;
            color: white;
            padding: 0.75em;
            text-align: left;
            font-weight: 600;
        }

        .markdown-content td {
            padding: 0.75em;
            border: 1px solid #e2e8f0;
        }

        .markdown-content tr:nth-child(even) {
            background: #f8f9fa;
        }

        /* AI Content Badge */
        .ai-content-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 0 0 1em 0;
        }

        /* Content Section Divider */
        .content-divider {
            border: none;
            border-top: 3px dashed #cbd5e0;
            margin: 2em 0;
            position: relative;
        }

        .content-divider::before {
            content: '✨ AI-Enhanced Content ✨';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 15px;
            color: #667eea;
            font-weight: 600;
            font-size: 0.9em;
        }

        /* View Mode Tabs - Professional Design */
        .view-mode-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            padding: 8px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .view-tab-btn {
            padding: 12px 28px;
            border: none;
            background: white;
            color: #64748b;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .view-tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .view-tab-btn span {
            position: relative;
            z-index: 1;
        }

        .view-tab-btn:hover:not(.active) {
            background: #f8fafc;
            color: #475569;
            transform: translateY(-2px);
        }

        .view-tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Filter Controls - Modern Design */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            background: white;
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
        }

        .filter-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-label .icon {
            font-size: 16px;
        }

        .filter-select {
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            cursor: pointer;
            background: white;
            color: #1e293b;
            font-weight: 500;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
            padding-right: 40px;
        }

        .filter-select:hover {
            border-color: #667eea;
            background-color: #fafbfc;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        /* Markdown Styling for Chat Messages */
        .chat-markdown {
            line-height: 1.7;
            color: #1e293b;
        }

        .chat-markdown h1 {
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            color: #0f172a;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .chat-markdown h2 {
            font-size: 1.3em;
            font-weight: 700;
            margin-top: 0.8em;
            margin-bottom: 0.5em;
            color: #1e293b;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25em;
        }

        .chat-markdown h3 {
            font-size: 1.15em;
            font-weight: 600;
            margin-top: 0.7em;
            margin-bottom: 0.4em;
            color: #334155;
        }

        .chat-markdown h4 {
            font-size: 1.05em;
            font-weight: 600;
            margin-top: 0.6em;
            margin-bottom: 0.3em;
            color: #475569;
        }

        .chat-markdown h1:first-child,
        .chat-markdown h2:first-child,
        .chat-markdown h3:first-child,
        .chat-markdown h4:first-child {
            margin-top: 0;
        }

        .chat-markdown p {
            margin-bottom: 0.8em;
            color: #334155;
        }

        .chat-markdown p:last-child {
            margin-bottom: 0;
        }

        .chat-markdown strong {
            font-weight: 700;
            color: #0f172a;
        }

        .chat-markdown em {
            font-style: italic;
            color: #475569;
        }

        .chat-markdown ul,
        .chat-markdown ol {
            margin: 0.8em 0;
            padding-left: 1.5em;
        }

        .chat-markdown ul {
            list-style-type: disc;
        }

        .chat-markdown ol {
            list-style-type: decimal;
        }

        .chat-markdown li {
            margin-bottom: 0.4em;
            padding-left: 0.3em;
            color: #334155;
        }

        .chat-markdown li > p {
            margin-bottom: 0.3em;
        }

        .chat-markdown ul ul,
        .chat-markdown ol ul,
        .chat-markdown ul ol,
        .chat-markdown ol ol {
            margin: 0.3em 0;
        }

        .chat-markdown code {
            background: #f1f5f9;
            color: #8b5cf6;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: 500;
        }

        .chat-markdown pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1em 0;
            border: 1px solid #334155;
        }

        .chat-markdown pre code {
            background: transparent;
            color: inherit;
            padding: 0;
            font-size: 0.9em;
            font-weight: 400;
        }

        .chat-markdown blockquote {
            border-left: 4px solid #8b5cf6;
            padding-left: 1em;
            margin: 1em 0;
            color: #475569;
            font-style: italic;
            background: #f8fafc;
            padding: 0.8em 1em;
            border-radius: 0 6px 6px 0;
        }

        .chat-markdown a {
            color: #6366f1;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .chat-markdown a:hover {
            color: #8b5cf6;
        }

        .chat-markdown hr {
            border: none;
            border-top: 2px solid #e5e7eb;
            margin: 1.5em 0;
        }

        .chat-markdown table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .chat-markdown th,
        .chat-markdown td {
            border: 1px solid #e5e7eb;
            padding: 0.5em;
            text-align: left;
        }

        .chat-markdown th {
            background: #f8fafc;
            font-weight: 600;
            color: #0f172a;
        }

        .chat-markdown td {
            color: #334155;
        }

        /* Grading Dashboard Styles */
        .grading-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .grading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .grading-stats {
            display: flex;
            gap: 20px;
        }

        .stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .stat-label {
            font-size: 0.85em;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #1e293b;
            margin-top: 5px;
        }

        .stat-value.late {
            color: #dc2626;
        }

        .grading-filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        .submissions-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 20px;
            min-height: 400px;
        }

        .submission-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .submission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: #ea580c;
        }

        .submission-card.late {
            border-left: 5px solid #dc2626;
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .submission-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .submission-student {
            font-size: 1em;
            color: #64748b;
            font-weight: 500;
        }

        .submission-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            color: #64748b;
        }

        .meta-icon {
            font-size: 1.1em;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.quiz {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .badge.essay {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .badge.project {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .badge.homework {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .badge.late {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .badge.submitted {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .badge.graded {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .grade-btn {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .grade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        /* Grading Modal Styles */
        .grading-modal-header {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .grading-modal-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .grading-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .grading-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .submission-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .quiz-question {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #e2e8f0;
        }

        .quiz-question.correct {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .quiz-question.incorrect {
            border-left-color: #dc2626;
            background: #fef2f2;
        }

        .question-text {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .answer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .file-preview:hover {
            border-color: #ea580c;
            background: #fff7ed;
        }

        .file-icon {
            font-size: 2em;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #1e293b;
        }

        .file-size {
            font-size: 0.85em;
            color: #64748b;
        }

        .points-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .points-input {
            flex: 1;
        }

        .points-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .points-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            cursor: pointer;
        }

        .points-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            cursor: pointer;
        }

        .points-display {
            font-size: 2em;
            font-weight: 700;
            color: #ea580c;
            min-width: 120px;
            text-align: center;
        }

        .letter-grade {
            font-size: 1.5em;
            font-weight: 700;
            color: #1e293b;
            padding: 10px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            text-align: center;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            transition: all 0.3s;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: #ea580c;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }

        .rubric-criteria {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rubric-criterion {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .criterion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .criterion-name {
            font-weight: 600;
            color: #1e293b;
        }

        .criterion-score {
            font-weight: 700;
            color: #ea580c;
        }

        .submit-grade-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 25px;
        }

        .submit-grade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .submit-grade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner p {
            margin-top: 20px;
            color: #64748b;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .auto-score-display {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .auto-score-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .auto-score-value {
            font-size: 2.5em;
            font-weight: 700;
        }

        .override-notice {
            background: #fff7ed;
            border: 2px solid #fdba74;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #9a3412;
        }

        @media (max-width: 968px) {
            .grading-sections {
                grid-template-columns: 1fr;
            }

            .grading-stats {
                flex-direction: column;
                width: 100%;
            }

            .stat-card {
                width: 100%;
            }
        }


/* Assignment Modal Styles */
.assignment-type-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin: 20px 0;
}

.assignment-type-btn {
    padding: 16px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    font-size: 0.9em;
    font-weight: 600;
    color: #64748b;
}

.assignment-type-btn:hover {
    border-color: #0ea5e9;
    background: #f0f9ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
}

.assignment-type-btn.selected {
    border-color: #0ea5e9;
    background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
}

.assignment-type-btn .icon {
    font-size: 2em;
    display: block;
    margin-bottom: 8px;
}

.student-checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
    max-height: 400px;
    overflow-y: auto;
    padding: 16px;
    background: #f8fafc;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
}

.student-checkbox-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    cursor: pointer;
    transition: all 0.2s;
}

.student-checkbox-item:hover {
    border-color: #0ea5e9;
    background: #f0f9ff;
    transform: translateX(4px);
}

.student-checkbox-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
    accent-color: #0ea5e9;
}

.student-info {
    flex: 1;
    min-width: 0;
}

.student-name {
    font-weight: 500;
    color: #1e293b;
    font-size: 0.95em;
}

.student-email {
    font-size: 0.8em;
    color: #64748b;
    margin-top: 2px;
}

.select-all-students {
    background: #f0f9ff;
    border: 2px solid #0ea5e9;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.select-all-students:hover {
    background: #e0f2fe;
}

.quiz-questions-preview {
    background: #fef3c7;
    border: 2px solid #fbbf24;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

.quiz-question-item {
    background: white;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    border: 2px solid #fde68a;
}

.question-text {
    font-weight: 600;
    color: #92400e;
    margin-bottom: 12px;
}

.answer-options {
    margin-left: 20px;
}

.answer-option {
    padding: 8px 12px;
    margin: 6px 0;
    border-radius: 6px;
    background: #fef9f3;
    border-left: 3px solid #fbbf24;
    font-size: 0.9em;
}

.answer-option.correct {
    background: #d1fae5;
    border-left-color: #10b981;
    font-weight: 600;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loading-content {
    background: white;
    padding: 40px 60px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    text-align: center;
}

.loading-spinner {
    width: 80px;
    height: 80px;
    border: 6px solid #e0f2fe;
    border-top-color: #0ea5e9;
    border-right-color: #8b5cf6;
    border-bottom-color: #06b6d4;
    border-radius: 50%;
    animation: spin 0.8s linear infinite, pulse 2s ease-in-out infinite;
    margin: 0 auto 20px;
    box-shadow: 0 0 30px rgba(14, 165, 233, 0.3);
}

@keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(14, 165, 233, 0.3); }
    50% { transform: scale(1.1); box-shadow: 0 0 50px rgba(14, 165, 233, 0.5); }
}

/* AI Brain Animation */
.ai-brain-loader {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto 25px;
}

.ai-brain {
    width: 100%;
    height: 100%;
    position: relative;
    animation: float 3s ease-in-out infinite;
}

.brain-core {
    position: absolute;
    width: 80px;
    height: 80px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    border-radius: 50%;
    animation: glow 2s ease-in-out infinite;
    box-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
}

.brain-particle {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
    box-shadow: 0 0 15px currentColor;
}

.particle-1 { top: 10%; left: 20%; animation: orbit 3s linear infinite; }
.particle-2 { top: 20%; right: 15%; animation: orbit 2.5s linear infinite 0.5s; }
.particle-3 { bottom: 15%; left: 25%; animation: orbit 3.5s linear infinite 1s; }
.particle-4 { bottom: 20%; right: 20%; animation: orbit 2.8s linear infinite 1.5s; }
.particle-5 { top: 50%; left: 5%; animation: orbit 3.2s linear infinite 0.3s; }
.particle-6 { top: 50%; right: 5%; animation: orbit 2.7s linear infinite 0.8s; }

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(5deg); }
}

@keyframes glow {
    0%, 100% { box-shadow: 0 0 40px rgba(102, 126, 234, 0.6), 0 0 80px rgba(139, 92, 246, 0.4); }
    50% { box-shadow: 0 0 60px rgba(102, 126, 234, 0.8), 0 0 120px rgba(139, 92, 246, 0.6); }
}

@keyframes orbit {
    0% { transform: rotate(0deg) translateX(50px) rotate(0deg); opacity: 0.3; }
    50% { opacity: 1; }
    100% { transform: rotate(360deg) translateX(50px) rotate(-360deg); opacity: 0.3; }
}

/* Sparkle effects */
.sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    animation: sparkle 1.5s ease-in-out infinite;
    box-shadow: 0 0 10px #fff, 0 0 20px #0ea5e9;
}

.sparkle:nth-child(1) { top: 15%; left: 30%; animation-delay: 0s; }
.sparkle:nth-child(2) { top: 25%; right: 25%; animation-delay: 0.3s; }
.sparkle:nth-child(3) { bottom: 20%; left: 20%; animation-delay: 0.6s; }
.sparkle:nth-child(4) { bottom: 30%; right: 30%; animation-delay: 0.9s; }

@keyframes sparkle {
    0%, 100% { opacity: 0; transform: scale(0); }
    50% { opacity: 1; transform: scale(1.5); }
}

</style>
</head>
<body>
    <div class="header">
        <h1>
            AI Academy @ Centner
            <span>Teacher Dashboard 2025-2026</span>
        </h1>
        <div class="user-info">
            <span id="teacherName" style="font-weight: 500;">Brett & Jairo</span>
            <button class="manage-students-btn" onclick="window.location.href='student-management.html'">
                <span>👥</span> Manage Students
            </button>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Teacher Tools -->
        <div class="teacher-tools">
            <h2>🛠️ Teacher Tools</h2>
            <div class="tool-buttons">
                <button class="tool-btn" onclick="window.location.href='curriculum-sequencing.html'" style="background: linear-gradient(135deg, #ea580c 0%, #f97316 100%); color: white; font-weight: 700; border: 3px solid #fed7aa; box-shadow: 0 4px 12px rgba(234,88,12,0.3);">📊 Curriculum Sequencing & AI Assignment Planning ✨</button>
                <button class="tool-btn" onclick="changeViewMode('grading'); document.querySelector('.view-tab-btn[data-view=grading]').scrollIntoView({ behavior: 'smooth', block: 'center' });">✅ Grade Submissions</button>
                <button class="tool-btn" onclick="openAttendance()">📋 Take Attendance</button>
                <button class="tool-btn secondary" onclick="openRoster()">👥 View Roster</button>
                <button class="tool-btn" onclick="toggleViewAsStudent()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; font-weight: 600;">👁️ View as Student</button>
            </div>
        </div>

        <!-- Multi-Lesson Homework Generator -->
        <div id="multiLessonHomework" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; border-radius: 16px; padding: 24px; margin: 20px; box-shadow: 0 4px 16px rgba(14, 165, 233, 0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #0369a1; margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span>📚</span> Multi-Lesson Homework Generator
                </h2>
                <button onclick="toggleLessonSelector()" id="toggleSelectorBtn" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'">
                    Show Lesson Selector
                </button>
            </div>

            <div id="lessonSelectorPanel" style="display: none;">
                <p style="color: #0c4a6e; margin-bottom: 15px; font-size: 0.95em;">
                    Select multiple lessons to generate comprehensive homework assignments. The AI will combine context from all selected lessons to create cohesive homework questions.
                </p>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- Lesson checkboxes will be populated here -->
                    <div id="lessonCheckboxContainer"></div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="generateMultiLessonHomework()" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(14, 165, 233, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(14, 165, 233, 0.3)'">
                        📝 Generate Homework from Selected Lessons
                    </button>
                    <span id="selectedCount" style="color: #0369a1; font-weight: 600;"></span>
                </div>

                <!-- Results will be displayed here -->
                <div id="multiLessonHomeworkResults" style="margin-top: 20px; display: none;"></div>
            </div>
        </div>

        <!-- Student View Banner (hidden by default) -->
        <div id="studentViewBanner" style="display: none; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 16px 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.5em;">👁️</span>
                <div>
                    <div style="font-weight: 700; font-size: 1.1em;">Student View Mode</div>
                    <div style="opacity: 0.95; font-size: 0.9em;">Viewing calendar as: <span id="studentViewName" style="font-weight: 600;"></span></div>
                </div>
            </div>
            <button onclick="exitStudentView()" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                ✕ Exit Student View
            </button>
        </div>

        <!-- View Mode Selector -->
        <div class="view-mode-selector">
            <button class="view-tab-btn active" data-view="month" onclick="changeViewMode('month')">
                <span>Month View</span>
            </button>
            <button class="view-tab-btn" data-view="week" onclick="changeViewMode('week')">
                <span>Week View</span>
            </button>
            <button class="view-tab-btn" data-view="day" onclick="changeViewMode('day')">
                <span>Day View</span>
            </button>
            <button class="view-tab-btn" data-view="list" onclick="changeViewMode('list')">
                <span>List View</span>
            </button>
            <button class="view-tab-btn" data-view="sequence" onclick="changeViewMode('sequence')">
                <span>Sequence View</span>
            </button>
            <button class="view-tab-btn" data-view="assignments" onclick="changeViewMode('assignments')">
                <span>Assignments</span>
            </button>
            <button class="view-tab-btn" data-view="grading" onclick="changeViewMode('grading')">
                <span>Grading</span>
            </button>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label" for="gradeFilter">
                    <span class="icon">🎓</span>
                    <span>Grade Level</span>
                </label>
                <select id="gradeFilter" class="filter-select">
                    <option value="all" selected>All Grades</option>
                    <option value="7">7th Grade</option>
                    <option value="9">9th Grade</option>
                    <option value="11">11th Grade</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="subjectFilter">
                    <span class="icon">📚</span>
                    <span>Subject</span>
                </label>
                <select id="subjectFilter" class="filter-select">
                    <option value="all" selected>All Subjects</option>
                    <option value="math">Mathematics</option>
                    <option value="ela">English Language Arts</option>
                    <option value="science">Science</option>
                    <option value="history">History</option>
                    <option value="civics">Civics</option>
                    <option value="government">Government</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="periodFilter">
                    <span class="icon">⏰</span>
                    <span>Period</span>
                </label>
                <select id="periodFilter" class="filter-select">
                    <option value="all" selected>All Periods</option>
                    <option value="1">Period 1</option>
                    <option value="2">Period 2</option>
                    <option value="3">Period 3</option>
                    <option value="4">Period 4</option>
                </select>
            </div>
        </div>

        <!-- Date Range Picker -->
        <div class="date-picker-section" style="background: white; padding: 20px; margin: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; color: #64748b; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">
                    📅 START DATE
                </label>
                <input type="date" id="startDatePicker"
                       style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; cursor: pointer; transition: border-color 0.2s;"
                       onfocus="this.style.borderColor='#ea580c'"
                       onblur="this.style.borderColor='#e5e7eb'">
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; color: #64748b; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">
                    📅 END DATE
                </label>
                <input type="date" id="endDatePicker"
                       style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; cursor: pointer; transition: border-color 0.2s;"
                       onfocus="this.style.borderColor='#ea580c'"
                       onblur="this.style.borderColor='#e5e7eb'">
            </div>
            <button onclick="applyDateRange()"
                    style="background: linear-gradient(135deg, #ea580c 0%, #f97316 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3); transition: all 0.2s; align-self: flex-end;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(234, 88, 12, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(234, 88, 12, 0.3)'">
                Apply Date Range
            </button>
            <button onclick="resetToToday()"
                    style="background: white; color: #64748b; border: 2px solid #e5e7eb; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; align-self: flex-end;"
                    onmouseover="this.style.borderColor='#ea580c'; this.style.color='#ea580c'"
                    onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#64748b'">
                Reset to Today
            </button>
            <button onclick="clearLessonOverrides()"
                    style="background: white; color: #dc2626; border: 2px solid #fecaca; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; align-self: flex-end;"
                    onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2'"
                    onmouseout="this.style.borderColor='#fecaca'; this.style.background='white'">
                🔄 Reset Curriculum
            </button>
        </div>

        <!-- Calendar Navigation -->
        <div class="calendar-nav">
            <button class="nav-btn" id="prevMonth">← Previous</button>
            <h2 id="currentMonth"></h2>
            <button class="nav-btn" id="nextMonth">Next →</button>
        </div>

        <!-- Calendar -->
        <div class="calendar" id="calendarView">
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- Grading Dashboard -->
        <div id="gradingView" style="display: none;">
            <div class="grading-dashboard">
                <!-- Grading Header -->
                <div class="grading-header">
                    <h2 style="font-size: 1.8em; font-weight: 700; color: #1e293b;">
                        <span style="color: #ea580c;">📝</span> Student Submissions
                    </h2>
                    <div class="grading-stats" id="gradingStats">
                        <div class="stat-card">
                            <span class="stat-label">Pending</span>
                            <span class="stat-value" id="pendingCount">-</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Graded</span>
                            <span class="stat-value" id="gradedCount">-</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Late</span>
                            <span class="stat-value late" id="lateCount">-</span>
                        </div>
                    </div>
                </div>

                <!-- Grading Filters -->
                <div class="grading-filters">
                    <div class="filter-row">
                        <select id="gradingStatusFilter" class="filter-select">
                            <option value="all">All Statuses</option>
                            <option value="submitted" selected>Pending Review</option>
                            <option value="graded">Graded</option>
                        </select>
                        <select id="gradingGradeLevelFilter" class="filter-select">
                            <option value="all">All Grade Levels</option>
                            <option value="7th">7th Grade</option>
                            <option value="9th">9th Grade</option>
                            <option value="11th">11th Grade</option>
                        </select>
                        <select id="gradingSubjectFilter" class="filter-select">
                            <option value="all">All Subjects</option>
                            <optgroup label="7th Grade">
                                <option value="7th_civics">Civics</option>
                                <option value="7th_ela">English Language Arts</option>
                                <option value="7th_science">Life Science</option>
                                <option value="7th_math">Pre-Algebra</option>
                            </optgroup>
                            <optgroup label="9th Grade">
                                <option value="9th_ela">English Language Arts</option>
                                <option value="9th_math">Geometry</option>
                                <option value="9th_world_history">World History</option>
                            </optgroup>
                            <optgroup label="11th Grade">
                                <option value="11th_ela">American Literature</option>
                                <option value="11th_math">Pre-Calculus</option>
                                <option value="11th_us_gvmnt">U.S. Government</option>
                            </optgroup>
                        </select>
                        <select id="gradingTypeFilter" class="filter-select">
                            <option value="all">All Types</option>
                            <option value="quiz">Quizzes</option>
                            <option value="essay">Essays</option>
                            <option value="project">Projects</option>
                            <option value="homework">Homework</option>
                        </select>
                        <select id="gradingSortFilter" class="filter-select">
                            <option value="due_date">Sort by Due Date</option>
                            <option value="submitted_at">Sort by Submission Date</option>
                            <option value="student_name">Sort by Student Name</option>
                        </select>
                        <button class="refresh-btn" onclick="loadSubmissions()" title="Refresh">
                            🔄 Refresh
                        </button>
                    </div>
                </div>

                <!-- Submissions List -->
                <div class="submissions-container">
                    <div id="submissionsList">
                        <!-- Dynamically loaded submissions -->
                        <div class="loading-spinner" id="gradingLoader">
                            <div class="spinner"></div>
                            <p>Loading submissions...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Lesson Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
            <div id="editModalBody"></div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <h2 style="color: #ea580c; margin-bottom: 10px; font-size: 1.8em;">🔐 Teacher Login</h2>
            <p style="color: #64748b; margin-bottom: 30px;">Please sign in to access the teacher dashboard</p>

            <div class="form-group">
                <label for="authEmail">Email Address</label>
                <input type="email" id="authEmail" placeholder="teacher@example.com" required>
            </div>

            <div class="form-group">
                <label for="authPassword">Password</label>
                <input type="password" id="authPassword" placeholder="Enter your password" required>
            </div>

            <div id="authError" style="color: #ef4444; margin-bottom: 15px; display: none; padding: 12px; background: #fee; border-radius: 8px; font-size: 14px;"></div>

            <button class="btn-save" onclick="handleLogin()" id="loginBtn" style="width: 100%;">
                Sign In
            </button>

            <!-- Demo Credentials -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <p style="color: #64748b; font-size: 13px; margin-bottom: 12px; text-align: center; font-weight: 600;">
                    🎯 Quick Login - Demo Credentials
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button onclick="useDemoCredentials('teacher')" style="padding: 8px 12px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 12px; color: #475569; font-weight: 500; transition: all 0.2s;">
                        👨‍🏫 Teacher Demo
                    </button>
                    <button onclick="useDemoCredentials('brett')" style="padding: 8px 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; cursor: pointer; font-size: 12px; color: #92400e; font-weight: 500; transition: all 0.2s;">
                        👑 Brett's Login
                    </button>
                </div>
                <p style="color: #94a3b8; font-size: 11px; margin-top: 8px; text-align: center; font-style: italic;">
                    Click to auto-fill credentials
                </p>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; color: #64748b; font-size: 14px; text-align: center;">
                Don't have an account? <a href="#" onclick="handleSignUp(); return false;" style="color: #ea580c; font-weight: 600;">Create Teacher Account</a>
            </div>
        </div>
    </div>

    <!-- Grading Modal -->
    <div id="gradingModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <span class="modal-close" onclick="closeGradingModal()">&times;</span>
            <div id="gradingModalContent">
                <!-- Dynamically loaded grading interface -->
            </div>
        
    <!-- Assign to Students Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeAssignModal()">&times;</span>
            <div id="assignModalBody"></div>
        </div>
    </div>

</div>
    </div>

    <script src="dist/schedule-data.js?v=20251006j"></script>
    <script src="curriculum-api.js"></script>
    <script src="dist/student-roster.js?v=20251006j"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Markdown parser for beautiful content rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://qypmfilbkvxwyznnenge.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5cG1maWxia3Z4d3l6bm5lbmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNDY3NTIsImV4cCI6MjA3NTcyMjc1Mn0.3uC16cqBUjjFrAz103yws-E5W45HUh6rexbLBI3KCII';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true,
                storage: window.localStorage
            }
        });

        let currentMonth = new Date('2025-09-01');
        let gradeFilter = 'all';
        let subjectFilter = 'all';
        let periodFilter = 'all';
        let currentViewMode = 'month';

        // Date range variables
        let customStartDate = null;
        let customEndDate = null;

        // Lesson enhancements stored in-memory (loaded from Supabase)
        let lessonEnhancements = {};

        // Load all lesson enhancements from Supabase
        async function loadLessonEnhancements() {
            try {
                const { data, error } = await supabase
                    .from('lesson_enhancements')
                    .select('*');

                if (error) {
                    console.error('Error loading lesson enhancements:', error);
                    return;
                }

                // Convert array to object keyed by lesson_key
                lessonEnhancements = {};
                (data || []).forEach(enhancement => {
                    lessonEnhancements[enhancement.lesson_key] = {
                        notes: enhancement.notes,
                        quiz: enhancement.quiz,
                        activities: enhancement.activities,
                        rubric: enhancement.rubric,
                        videos: enhancement.videos,
                        docs: enhancement.docs,
                        links: enhancement.links,
                        aiExpand: enhancement.ai_expand,
                        aiSimplify: enhancement.ai_simplify,
                        aiQuestions: enhancement.ai_questions,
                        aiActivities: enhancement.ai_activities,
                        aiAssessment: enhancement.ai_assessment,
                        aiDifferentiate: enhancement.ai_differentiate
                    };
                });

                console.log(`Loaded ${data.length} lesson enhancements from database`);
            } catch (error) {
                console.error('Failed to load lesson enhancements:', error);
            }
        }

        // Save a single lesson enhancement to Supabase
        async function saveLessonEnhancement(lessonKey, enhancementData) {
            try {
                const { data: { user } } = await supabase.auth.getUser();

                const { data, error } = await supabase
                    .from('lesson_enhancements')
                    .upsert({
                        lesson_key: lessonKey,
                        notes: enhancementData.notes || null,
                        quiz: enhancementData.quiz || null,
                        activities: enhancementData.activities || null,
                        rubric: enhancementData.rubric || null,
                        videos: enhancementData.videos || null,
                        docs: enhancementData.docs || null,
                        links: enhancementData.links || null,
                        ai_expand: enhancementData.aiExpand || null,
                        ai_simplify: enhancementData.aiSimplify || null,
                        ai_questions: enhancementData.aiQuestions || null,
                        ai_activities: enhancementData.aiActivities || null,
                        ai_assessment: enhancementData.aiAssessment || null,
                        ai_differentiate: enhancementData.aiDifferentiate || null,
                        created_by: user?.id
                    }, {
                        onConflict: 'lesson_key'
                    });

                if (error) {
                    console.error('Error saving lesson enhancement:', error);
                    alert('Failed to save lesson enhancement. Please try again.');
                    return false;
                }

                console.log(`Saved lesson enhancement for ${lessonKey}`);
                return true;
            } catch (error) {
                console.error('Failed to save lesson enhancement:', error);
                alert('Failed to save lesson enhancement. Please try again.');
                return false;
            }
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================

        // Check if user is authenticated
        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    console.error('Error checking auth session:', error);
                    return false;
                }

                if (session && session.user) {
                    console.log('User is authenticated:', session.user.email);
                    updateUIForAuthenticatedUser(session.user);
                    return true;
                } else {
                    console.log('No active session, showing auth modal');
                    showAuthModal();
                    return false;
                }
            } catch (error) {
                console.error('Failed to check authentication:', error);
                showAuthModal();
                return false;
            }
        }

        // Show authentication modal
        function showAuthModal() {
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.classList.add('active');
                // Focus on email input
                setTimeout(() => {
                    document.getElementById('authEmail')?.focus();
                }, 100);
            }
        }

        // Hide authentication modal
        function hideAuthModal() {
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.classList.remove('active');
            }
        }

        // Handle login
        async function handleLogin() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('authError');

            // Validate inputs
            if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
            }

            // Disable button and show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.style.display = 'none';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    console.error('Login error:', error);
                    showAuthError(error.message);
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                    return;
                }

                if (data.user) {
                    console.log('Login successful:', data.user.email);
                    hideAuthModal();
                    updateUIForAuthenticatedUser(data.user);
                    // Reload lesson enhancements now that we're authenticated
                    await loadLessonEnhancements();
                    renderView();
                }
            } catch (error) {
                console.error('Failed to login:', error);
                showAuthError('An unexpected error occurred. Please try again.');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        // Handle sign up
        async function handleSignUp() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('authError');

            // Validate inputs
            if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }

            // Disable button and show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Creating account...';
            errorDiv.style.display = 'none';

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    console.error('Sign up error:', error);
                    showAuthError(error.message);
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                    return;
                }

                // Check if we have both user AND session
                if (data.user && data.session) {
                    console.log('Sign up successful with active session:', data.user.email);
                    alert('✅ Account created successfully! You are now signed in.');
                    hideAuthModal();
                    updateUIForAuthenticatedUser(data.user);
                    // Reload lesson enhancements
                    await loadLessonEnhancements();
                    renderView();
                } else if (data.user && !data.session) {
                    console.log('Account created but email confirmation required:', data.user.email);
                    alert('⚠️ Account created! Please check your email to confirm your account before signing in.\n\nNote: If using a test email, you\'ll need to disable email confirmation in Supabase settings or use a real email address.');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            } catch (error) {
                console.error('Failed to sign up:', error);
                showAuthError('An unexpected error occurred. Please try again.');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        // Show authentication error
        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        // Use demo credentials - auto-fill login form
        function useDemoCredentials(type) {
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const errorDiv = document.getElementById('authError');

            // Hide any previous errors
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }

            // Demo credentials mapping
            const credentials = {
                teacher: {
                    email: 'demo.teacher@centneracademy.com',
                    password: 'Teacher2025!'
                },
                brett: {
                    email: 'brett@centneracademy.com',
                    password: 'Brett2025Admin!'
                }
            };

            const creds = credentials[type];
            if (creds && emailInput && passwordInput) {
                emailInput.value = creds.email;
                passwordInput.value = creds.password;

                // Add visual feedback
                emailInput.style.background = '#f0fdf4';
                passwordInput.style.background = '#f0fdf4';

                setTimeout(() => {
                    emailInput.style.background = '';
                    passwordInput.style.background = '';
                }, 1000);

                // Optional: Focus password field to show it's ready
                passwordInput.focus();
            }
        }

        // Update UI for authenticated user
        function updateUIForAuthenticatedUser(user) {
            const teacherName = document.getElementById('teacherName');
            if (teacherName && user.email) {
                // Extract name from email (e.g., "john.doe@example.com" -> "John Doe")
                const namePart = user.email.split('@')[0];
                const formattedName = namePart
                    .split('.')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                teacherName.textContent = formattedName;
            }
        }

        // Handle logout
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();

                if (error) {
                    console.error('Logout error:', error);
                    alert('Failed to logout. Please try again.');
                    return;
                }

                console.log('Logout successful');
                // Clear local data
                lessonEnhancements = {};
                // Show auth modal again
                showAuthModal();
                // Clear calendar
                const calendarGrid = document.getElementById('calendarGrid');
                if (calendarGrid) {
                    calendarGrid.innerHTML = '<p style="padding: 20px; text-align: center; color: #64748b;">Please sign in to view the calendar.</p>';
                }
            } catch (error) {
                console.error('Failed to logout:', error);
                alert('An unexpected error occurred. Please try again.');
            }
        }

        // Handle Enter key in password field
        document.addEventListener('DOMContentLoaded', () => {
            const passwordInput = document.getElementById('authPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
        });

        // Initialize: Check auth and load enhancements from database on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                await loadLessonEnhancements();
                renderView();
            }
        });

        // Period structure now supports A/B day scheduling
        const periodStructure = {
            A: {
                1: {
                    9: { subject: 'English Language Arts', key: '9th_ela', color: '#8B5CF6', class: 'subject-ela' },
                    11: { subject: 'Pre-Calculus', key: '11th_math', color: '#10B981', class: 'subject-math' }
                },
                2: {
                    7: { subject: 'Life Science', key: '7th_science', color: '#F59E0B', class: 'subject-science' },
                    11: { subject: 'U.S. Government', key: '11th_us_gvmnt', color: '#3B82F6', class: 'subject-government' }
                },
                3: {
                    7: { subject: 'English Language Arts', key: '7th_ela', color: '#8B5CF6', class: 'subject-ela' }
                },
                4: {}  // No students
            },
            B: {
                1: {
                    9: { subject: 'World History', key: '9th_world_history', color: '#EF4444', class: 'subject-history' },
                    11: { subject: 'American Literature', key: '11th_ela', color: '#8B5CF6', class: 'subject-ela' }
                },
                2: {
                    7: { subject: 'Pre-Algebra', key: '7th_math', color: '#10B981', class: 'subject-math' }
                },
                3: {
                    7: { subject: 'Civics', key: '7th_civics', color: '#3B82F6', class: 'subject-civics' },
                    9: { subject: 'Geometry', key: '9th_math', color: '#10B981', class: 'subject-math' }
                },
                4: {}  // No students
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, setting up calendar...');

            // Always setup event listeners first, even if renderView fails
            setupEventListeners();

            // Load lesson overrides from database
            await loadLessonOverrides();

            // Load student roster for assignment functionality
            await loadStudentRoster();

            try {
                renderView();
            } catch (error) {
                console.error('Error rendering view:', error);
            }
        });

        function setupEventListeners() {
            console.log('Setting up event listeners...');

            const prevBtn = document.getElementById('prevMonth');
            const nextBtn = document.getElementById('nextMonth');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    console.log('Previous month clicked');
                    changeMonth(-1);
                });
                console.log('Previous button listener attached');
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    console.log('Next month clicked');
                    changeMonth(1);
                });
                console.log('Next button listener attached');
            }

            document.getElementById('gradeFilter').addEventListener('change', (e) => {
                gradeFilter = e.target.value;
                renderView();
            });
            document.getElementById('subjectFilter').addEventListener('change', (e) => {
                subjectFilter = e.target.value;
                renderView();
            });
            document.getElementById('periodFilter').addEventListener('change', (e) => {
                periodFilter = e.target.value;
                renderView();
            });

            // Grading filter event listeners
            const gradingStatusFilter = document.getElementById('gradingStatusFilter');
            const gradingGradeLevelFilter = document.getElementById('gradingGradeLevelFilter');
            const gradingSubjectFilter = document.getElementById('gradingSubjectFilter');
            const gradingTypeFilter = document.getElementById('gradingTypeFilter');
            const gradingSortFilter = document.getElementById('gradingSortFilter');

            if (gradingStatusFilter) {
                gradingStatusFilter.addEventListener('change', () => {
                    if (currentViewMode === 'grading') loadSubmissions();
                });
            }
            if (gradingGradeLevelFilter) {
                gradingGradeLevelFilter.addEventListener('change', () => {
                    if (currentViewMode === 'grading') loadSubmissions();
                });
            }
            if (gradingSubjectFilter) {
                gradingSubjectFilter.addEventListener('change', () => {
                    if (currentViewMode === 'grading') loadSubmissions();
                });
            }
            if (gradingTypeFilter) {
                gradingTypeFilter.addEventListener('change', () => {
                    if (currentViewMode === 'grading') loadSubmissions();
                });
            }
            if (gradingSortFilter) {
                gradingSortFilter.addEventListener('change', () => {
                    if (currentViewMode === 'grading') loadSubmissions();
                });
            }
        }

        // Date picker functions
        function applyDateRange() {
            const startInput = document.getElementById('startDatePicker');
            const endInput = document.getElementById('endDatePicker');

            if (!startInput.value || !endInput.value) {
                alert('Please select both start and end dates');
                return;
            }

            customStartDate = new Date(startInput.value);
            customEndDate = new Date(endInput.value);

            if (customStartDate > customEndDate) {
                alert('Start date must be before end date');
                return;
            }

            // Update currentMonth to the start date for navigation context
            currentMonth = new Date(customStartDate);

            renderView();
        }

        function resetToToday() {
            customStartDate = null;
            customEndDate = null;
            document.getElementById('startDatePicker').value = '';
            document.getElementById('endDatePicker').value = '';

            // Reset to current week/month
            const today = new Date();
            currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            renderView();
        }

        // View mode switching - must be global for onclick handlers
        window.changeViewMode = function(mode) {
            currentViewMode = mode;

            // Update button styles using class-based approach
            document.querySelectorAll('.view-tab-btn').forEach(btn => {
                if (btn.dataset.view === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Show/hide appropriate views
            if (mode === 'grading') {
                document.getElementById('calendarView').style.display = 'none';
                document.getElementById('gradingView').style.display = 'block';
                loadSubmissions(); // Load submissions when grading view is opened
            } else {
                document.getElementById('calendarView').style.display = 'block';
                document.getElementById('gradingView').style.display = 'none';
                renderView();
            }
        };

        // Main render function that delegates to the appropriate view
        function renderView() {
            switch(currentViewMode) {
                case 'day':
                    renderDayView();
                    break;
                case 'week':
                    renderWeekView();
                    break;
                case 'list':
                    renderListView();
                    break;
                case 'sequence':
                    renderSequenceView();
                    break;
                case 'assignments':
                    renderAssignmentsView();
                    break;
                case 'month':
                default:
                    renderCalendar();
            }
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('currentMonth').textContent =
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const grid = document.getElementById('calendarGrid');
            // Restore grid display for month view
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(7, 1fr)';

            grid.innerHTML = '';

            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            for (let i = startPadding - 1; i >= 0; i--) {
                const cell = createDayCell(new Date(year, month - 1, prevLastDay.getDate() - i), true);
                grid.appendChild(cell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const cell = createDayCell(new Date(year, month, day), false);
                grid.appendChild(cell);
            }

            const totalCells = grid.children.length - 7;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDayCell(new Date(year, month + 1, day), true);
                grid.appendChild(cell);
            }
        }

        function createDayCell(date, isOtherMonth) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            if (isOtherMonth) cell.classList.add('other-month');

            const dateStr = date.toISOString().split('T')[0];
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const dayType = getABDay(dateStr);
            const isNoSchool = schoolCalendar.noSchoolDays.has(dateStr);
            const isHalfDay = schoolCalendar.noonDismissals.has(dateStr);

            if (isNoSchool || isWeekend) cell.classList.add('no-school');
            if (isHalfDay) cell.classList.add('half-day');

            let html = '';

            html += `<div class="day-number" onclick="openDayAttendance('${dateStr}')" title="Click to take attendance">${date.getDate()}</div>`;

            if (dayType && !isNoSchool && !isWeekend) {
                const dayNum = getDayNumber(dateStr, dayType);
                html += `<div class="day-type ${dayType.toLowerCase()}-day">Day ${dayNum} - ${dayType}</div>`;
                html += `<div class="period-sections">`;

                const periods = periodFilter === 'all' ? [1, 2, 3, 4] : [parseInt(periodFilter)];
                const grades = gradeFilter === 'all' ? [7, 9, 11] : [parseInt(gradeFilter)];

                periods.forEach(period => {
                    grades.forEach(grade => {
                        const subj = periodStructure[dayType]?.[period]?.[grade];
                        if (subj) {
                            // Apply subject filter
                            const subjectType = getSubjectType(subj.subject);
                            if (subjectFilter !== 'all' && subjectType !== subjectFilter) {
                                return; // Skip this subject
                            }

                            // Student View Mode: Filter lessons by enrollment
                            if (!isStudentEnrolledInLesson(subj.key, period, dayType)) {
                                return; // Student not enrolled in this lesson
                            }

                            const dayKey = `${dayNum}.${dayType}`;
                            const lessons = getLessonsForDay(subj.key, dayKey, period, grade, dateStr);

                            lessons.forEach((lesson, lessonIndex) => {
                                const lessonCode = lesson.code || 'N/A';
                                const isAdded = lesson.isOverride;
                                const badge = isAdded ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; margin-left: 6px;">ADDED</span>' : '';

                                html += `
                                    <div class="period-section ${isAdded ? 'lesson-override' : ''}"
                                         draggable="true"
                                         data-subject-key="${subj.key}"
                                         data-day-key="${dayKey}"
                                         data-date="${dateStr}"
                                         data-period="${period}"
                                         data-grade="${grade}"
                                         data-lesson-code="${lessonCode}"
                                         ondragstart="handleDragStart(event)"
                                         ondragend="handleDragEnd(event)"
                                         onclick="openEditModal(event, '${dateStr}', '${dayType}', ${dayNum}, ${period}, ${grade})"
                                         oncontextmenu="event.preventDefault(); showLessonContextMenu(event, ${JSON.stringify({subjectKey: subj.key, lessonCode, period, grade, dayKey, date: dateStr})})">
                                        <div class="period-label">
                                            <span style="font-weight: 700; color: #495057;">${lessonCode}${badge}</span>
                                            <span style="opacity: 0.7; margin-left: 8px;">P${period} - Grade ${grade}</span>
                                        </div>
                                        <div class="lesson-item ${subj.class}" title="${lesson.title || 'No title'}\n\nDrag to move • Right-click for options • Click to edit">
                                            <div style="font-weight: 600;">${subj.subject}</div>
                                            <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.9;">${lesson.title || 'Lesson ' + lessonCode}</div>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    });
                });

                html += `</div>`;
            } else if (isNoSchool) {
                html += `<div style="color: #dc3545; font-weight: 600; margin-top: 10px;">No School</div>`;
            } else if (isHalfDay) {
                html += `<div style="color: #ffc107; font-weight: 600; margin-top: 10px;">Half Day</div>`;
            }

            cell.innerHTML = html;

            // Add drop zone functionality for valid school days
            if (dayType && !isNoSchool && !isWeekend) {
                cell.setAttribute('data-date', dateStr);
                cell.setAttribute('data-day-type', dayType);
                cell.setAttribute('data-day-num', getDayNumber(dateStr, dayType));

                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('dragleave', handleDragLeave);
                cell.addEventListener('drop', handleDrop);
            }

            return cell;
        }

        // Open day modal - finds the lesson and opens the edit modal
        function openDayModal(dateStr, dayType, dayNum) {
            // Find the lesson for this day by searching through all periods and grades
            const dayKey = `${dayNum}.${dayType}`;

            // Search through periodStructure to find matching lesson
            for (const dt in periodStructure) {
                for (const period in periodStructure[dt]) {
                    for (const grade in periodStructure[dt][period]) {
                        const subj = periodStructure[dt][period][grade];
                        if (subj && dt === dayType) {
                            // Check if this subject has a lesson for this day
                            const lesson = window.curriculumData.getLesson(subj.key, dayKey);
                            if (lesson) {
                                // Found the lesson! Call openEditModal with all parameters
                                // Create a fake event object
                                const fakeEvent = { stopPropagation: () => {} };
                                openEditModal(fakeEvent, dateStr, dayType, dayNum, period, grade);
                                return; // Exit after opening the first matching lesson
                            }
                        }
                    }
                }
            }

            // If no lesson found, show error
            alert(`❌ No lesson found for Day ${dayNum}${dayType}`);
        }

        function openEditModal(e, dateStr, dayType, dayNum, period, grade) {
            e.stopPropagation();
            const modal = document.getElementById('editModal');
            const modalBody = document.getElementById('editModalBody');

            const date = new Date(dateStr + 'T12:00:00');
            const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const dayKey = `${dayNum}.${dayType}`;

            const subj = periodStructure[dayType]?.[period]?.[grade];
            if (!subj) {
                alert('❌ No lesson found for this period/grade');
                return;
            }

            const lesson = window.curriculumData.getLesson(subj.key, dayKey);
            if (!lesson) {
                alert('❌ No lesson data found');
                return;
            }

            const enhancementKey = `${dateStr}_${subj.key}_${period}`;
            const enhancement = lessonEnhancements[enhancementKey] || {};

            let html = `
                <h2>✏️ Edit Lesson - ${dateFormatted}</h2>
                <h3 style="color: ${subj.color}; margin-top: 20px;">Period ${period} - Grade ${grade}: ${subj.subject}</h3>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #495057;">📚 Original Lesson Plan</h4>

                    ${lesson.code ? `<p><strong>Lesson Code:</strong> ${lesson.code}</p>` : ''}

                    ${lesson.standards ? `<p><strong>Florida Standards:</strong> <code>${lesson.standards}</code></p>` : ''}

                    ${lesson.objectives && lesson.objectives.length > 0 ? `
                        <div style="margin-top: 12px;">
                            <strong>Learning Objectives:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                ${lesson.objectives.map(obj => `<li>${obj}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${lesson.materials ? `<p><strong>Materials:</strong> ${lesson.materials}</p>` : ''}

                    ${lesson.activities && lesson.activities.length > 0 ? `
                        <div style="margin-top: 12px;">
                            <strong>Activities:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                ${lesson.activities.map(act => `<li>${act}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${lesson.assessment ? `<p><strong>Assessment:</strong> ${lesson.assessment}</p>` : ''}
                </div>

                <!-- Enrolled Students Section -->
                <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #0369a1; display: flex; align-items: center; gap: 8px;">
                            <span>👥</span> Enrolled Students
                        </h4>
                        <button class="btn-save" onclick="toggleAttendanceForLesson('${dateStr}', ${period}, '${subj.key}')"
                                style="background: #0ea5e9; padding: 8px 16px; font-size: 0.9em;">
                            📋 Take Attendance
                        </button>
                    </div>
                    ${(() => {
                        const enrolledStudents = getStudentsByPeriod(period, dayType, subj.key);
                        if (!enrolledStudents || enrolledStudents.length === 0) {
                            return '<p style="color: #64748b; font-style: italic;">No students enrolled in this class</p>';
                        }
                        return `
                            <div id="student-list-${period}-${subj.key.replace(/[^a-z0-9]/gi, '')}">
                                <p style="margin-bottom: 10px;"><strong>Total: ${enrolledStudents.length} student${enrolledStudents.length !== 1 ? 's' : ''}</strong></p>
                                <ul style="margin: 0; padding-left: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                                    ${enrolledStudents.map(student => `
                                        <li style="color: #0c4a6e; font-weight: 500;">
                                            ${student.firstName}${student.lastName ? ' ' + student.lastName : ''}
                                            <span style="color: #64748b; font-size: 0.9em;">(Grade ${student.grade})</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div id="attendance-section-${period}-${subj.key.replace(/[^a-z0-9]/gi, '')}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #bae6fd;">
                                <div style="display: grid; gap: 12px;">
                                    ${enrolledStudents.map(student => {
                                        const savedAttendance = loadSavedAttendance(dateStr, period);
                                        const savedData = savedAttendance[student.id] || { status: 'present', participation: 3, effort: 3 };
                                        return `
                                            <div class="student-attendance-row" data-period="${period}" data-student-id="${student.id}"
                                                 style="display: grid; grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr; gap: 12px; align-items: center; background: white; padding: 12px; border-radius: 6px; border: 2px solid #0ea5e9;">
                                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                                                    <input type="checkbox" class="attendance-check" data-student="${student.id}"
                                                           ${savedData.status === 'present' ? 'checked' : ''}
                                                           style="width: 18px; height: 18px; cursor: pointer;">
                                                    <div style="display: flex; flex-direction: column;">
                                                        <span style="font-weight: 600; color: #212529;">${student.firstName} ${student.lastName || ''}</span>
                                                        <span style="color: #6c757d; font-size: 0.75em;">${student.email || ''}</span>
                                                    </div>
                                                </label>
                                                <select class="attendance-status" data-student="${student.id}"
                                                        style="padding: 8px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.85em;">
                                                    <option value="present" ${savedData.status === 'present' ? 'selected' : ''}>✅ Present</option>
                                                    <option value="absent" ${savedData.status === 'absent' ? 'selected' : ''}>❌ Absent</option>
                                                    <option value="tardy" ${savedData.status === 'tardy' ? 'selected' : ''}>🕐 Tardy</option>
                                                    <option value="excused" ${savedData.status === 'excused' ? 'selected' : ''}>📝 Excused</option>
                                                </select>
                                                <div class="grade-slider-container">
                                                    <div class="grade-slider-label">
                                                        <span>🎯 Participation</span>
                                                        <span class="grade-value participation" id="lesson-participation-${student.id}">${savedData.participation}</span>
                                                    </div>
                                                    <input type="range" min="0" max="5" value="${savedData.participation}"
                                                           class="grade-slider participation" data-student="${student.id}"
                                                           oninput="updateGradeValue(this, 'lesson-participation-${student.id}')">
                                                </div>
                                                <div class="grade-slider-container">
                                                    <div class="grade-slider-label">
                                                        <span>💪 Effort</span>
                                                        <span class="grade-value effort" id="lesson-effort-${student.id}">${savedData.effort}</span>
                                                    </div>
                                                    <input type="range" min="0" max="5" value="${savedData.effort}"
                                                           class="grade-slider effort" data-student="${student.id}"
                                                           oninput="updateGradeValue(this, 'lesson-effort-${student.id}')">
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div style="margin-top: 15px; text-align: center;">
                                    <button class="btn-save" onclick="saveLessonAttendance('${dateStr}', ${period})"
                                            style="background: #0ea5e9;">
                                        💾 Save Attendance
                                    </button>
                                    <button class="btn-save secondary" onclick="toggleAttendanceForLesson('${dateStr}', ${period}, '${subj.key}')"
                                            style="background: #6c757d; margin-left: 10px;">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `;
                    })()}
                </div>

                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea id="notes_${enhancementKey}" placeholder="Add teaching notes, tips, or modifications..." oninput="updateMarkdownPreview('${enhancementKey}')">${enhancement.notes || ''}</textarea>

                    <!-- Markdown Preview -->
                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label style="margin: 0; font-weight: 600; color: #667eea;">📖 Preview (How students will see it)</label>
                            <button type="button" onclick="togglePreview('${enhancementKey}')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600;">
                                Toggle Preview
                            </button>
                        </div>
                        <div id="preview_${enhancementKey}" class="markdown-content" style="display: block; background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; min-height: 100px; max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Video URLs (one per line)</label>
                    <textarea id="videos_${enhancementKey}" placeholder="https://youtube.com/...">${(enhancement.videos || []).join('\n')}</textarea>
                </div>

                <div class="form-group">
                    <label>Document/PDF URLs (one per line)</label>
                    <textarea id="docs_${enhancementKey}" placeholder="https://drive.google.com/...">${(enhancement.docs || []).join('\n')}</textarea>
                </div>

                <div class="form-group">
                    <label>Additional Links (one per line)</label>
                    <textarea id="links_${enhancementKey}" placeholder="https://...">${(enhancement.links || []).join('\n')}</textarea>
                </div>

                <!-- AI Assistant Section -->
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 2px solid #0ea5e9;">
                    <h3 style="color: #0369a1; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">🤖</span> AI Lesson Assistant
                    </h3>

                    <!-- Progress Tracker -->
                    <div id="aiProgress_${enhancementKey}" style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 2px solid #bae6fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #0369a1; font-size: 0.9em;">Progress</span>
                            <span id="aiProgressText_${enhancementKey}" style="color: #64748b; font-size: 0.85em;">0/6 completed</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e0f2fe; border-radius: 4px; overflow: hidden;">
                            <div id="aiProgressBar_${enhancementKey}" style="width: 0%; height: 100%; background: linear-gradient(90deg, #0ea5e9 0%, #06b6d4 100%); transition: width 0.5s ease-out;"></div>
                        </div>
                    </div>

                    <p style="color: #64748b; margin-bottom: 15px; font-size: 0.9em;">Let AI help you improve this lesson plan:</p>

                    <!-- Generate All Button -->
                    <button id="generateAll_${enhancementKey}" onclick="generateAllContent('${enhancementKey}')" style="width: 100%; background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1em; margin-bottom: 10px; transition: all 0.3s; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(14, 165, 233, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(14, 165, 233, 0.3)'" title="Generate all recommended AI content at once">
                        ⚡ Generate All Recommended Content
                    </button>

                    <!-- Chat with AI Button -->
                    <button onclick="openLessonChat('${enhancementKey}')" style="width: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1em; margin-bottom: 15px; transition: all 0.3s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)'" title="Chat with AI to refine your lesson interactively">
                        💬 Chat with AI Assistant
                    </button>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button id="aiBtn_expand_${enhancementKey}" onclick="aiImproveContent('${enhancementKey}', 'expand')" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; position: relative;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'" title="Expand lesson content with more details and examples">
                            <span class="ai-status" id="aiStatus_expand_${enhancementKey}" style="position: absolute; top: -8px; right: -8px; background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.7em; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">✓</span>
                            📝 Expand Content
                        </button>
                        <button id="aiBtn_simplify_${enhancementKey}" onclick="aiImproveContent('${enhancementKey}', 'simplify')" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; position: relative;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'" title="Simplify content for easier student understanding">
                            <span class="ai-status" id="aiStatus_simplify_${enhancementKey}" style="position: absolute; top: -8px; right: -8px; background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.7em; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">✓</span>
                            ✨ Simplify Text
                        </button>
                        <button id="aiBtn_questions_${enhancementKey}" onclick="aiImproveContent('${enhancementKey}', 'questions')" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; position: relative;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'" title="Generate discussion questions for class engagement">
                            <span class="ai-status" id="aiStatus_questions_${enhancementKey}" style="position: absolute; top: -8px; right: -8px; background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.7em; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">✓</span>
                            ❓ Add Discussion Questions
                        </button>
                        <button id="aiBtn_activities_${enhancementKey}" onclick="aiImproveContent('${enhancementKey}', 'activities')" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; position: relative;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'" title="Get engaging activity suggestions for hands-on learning">
                            <span class="ai-status" id="aiStatus_activities_${enhancementKey}" style="position: absolute; top: -8px; right: -8px; background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.7em; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">✓</span>
                            🎯 Suggest Activities
                        </button>
                        <button id="aiBtn_assessment_${enhancementKey}" onclick="aiImproveContent('${enhancementKey}', 'assessment')" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; position: relative;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'" title="Create homework questions to assess understanding">
                            <span class="ai-status" id="aiStatus_assessment_${enhancementKey}" style="position: absolute; top: -8px; right: -8px; background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.7em; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">✓</span>
                            📊 Generate Homework Questions
                        </button>
                        <button id="aiBtn_differentiate_${enhancementKey}" onclick="aiImproveContent('${enhancementKey}', 'differentiate')" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; position: relative;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'" title="Get differentiation strategies for diverse learners">
                            <span class="ai-status" id="aiStatus_differentiate_${enhancementKey}" style="position: absolute; top: -8px; right: -8px; background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.7em; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">✓</span>
                            🎓 Differentiation Tips
                        </button>
                    </div>

                    <!-- AI Content Display Areas -->
                    <div id="aiExpandDisplay_${enhancementKey}" style="display: none; margin-top: 20px; background: white; border-radius: 8px; padding: 20px; border: 2px solid #bae6fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #0369a1; display: flex; align-items: center; gap: 8px;">
                                <span>📝</span> Expanded Content
                            </h4>
                            <button onclick="document.getElementById('aiExpandDisplay_${enhancementKey}').style.display='none'" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.2em; padding: 0; min-width: auto;" title="Close">&times;</button>
                        </div>

                        <!-- Quick Actions Bar -->
                        <div style="display: flex; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px; flex-wrap: wrap;">
                            <button onclick="copyToClipboard('aiExpandContent_${enhancementKey}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Copy to clipboard">
                                📋 Copy
                            </button>
                            <button onclick="aiImproveContent('${enhancementKey}', 'expand')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Regenerate content">
                                🔄 Regenerate
                            </button>
                            <button onclick="toggleEditMode('aiExpandContent_${enhancementKey}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Edit content">
                                ✏️ Edit
                            </button>
                            <button onclick="saveAIContent('${enhancementKey}', 'expand', 'aiExpandContent_${enhancementKey}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Save to localStorage">
                                💾 Save
                            </button>
                            <button onclick="addToNotes('${enhancementKey}', 'aiExpandContent_${enhancementKey}', 'Expanded Content')" style="background: #06b6d4; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Add to lesson notes">
                                ✅ Add to Notes
                            </button>
                            <button onclick="toggleStudentView('aiExpandContent_${enhancementKey}')" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Preview student view">
                                👁️ Preview
                            </button>
                        </div>

                        <div id="aiExpandContent_${enhancementKey}" style="max-height: 400px; overflow-y: auto; line-height: 1.7; color: #334155; font-size: 0.95em;"></div>
                    </div>

                    <div id="aiSimplifyDisplay_${enhancementKey}" style="display: none; margin-top: 20px; background: white; border-radius: 8px; padding: 20px; border: 2px solid #bae6fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #0369a1; display: flex; align-items: center; gap: 8px;">
                                <span>✨</span> Simplified Text
                            </h4>
                            <button onclick="document.getElementById('aiSimplifyDisplay_${enhancementKey}').style.display='none'" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.2em; padding: 0; min-width: auto;" title="Close">&times;</button>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px; flex-wrap: wrap;">
                            <button onclick="copyToClipboard('aiSimplifyContent_${enhancementKey}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Copy to clipboard">
                                📋 Copy
                            </button>
                            <button onclick="aiImproveContent('${enhancementKey}', 'simplify')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Regenerate content">
                                🔄 Regenerate
                            </button>
                            <button onclick="toggleEditMode('aiSimplifyContent_${enhancementKey}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Edit content">
                                ✏️ Edit
                            </button>
                            <button onclick="saveAIContent('${enhancementKey}', 'simplify', 'aiSimplifyContent_${enhancementKey}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Save to localStorage">
                                💾 Save
                            </button>
                            <button onclick="addToNotes('${enhancementKey}', 'aiSimplifyContent_${enhancementKey}', 'Simplified Text')" style="background: #06b6d4; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Add to lesson notes">
                                ✅ Add to Notes
                            </button>
                            <button onclick="toggleStudentView('aiSimplifyContent_${enhancementKey}')" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Preview student view">
                                👁️ Preview
                            </button>
                        </div>
                        <div id="aiSimplifyContent_${enhancementKey}" style="max-height: 400px; overflow-y: auto; line-height: 1.7; color: #334155; font-size: 0.95em;"></div>
                    </div>

                    <div id="aiQuestionsDisplay_${enhancementKey}" style="display: none; margin-top: 20px; background: white; border-radius: 8px; padding: 20px; border: 2px solid #bae6fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #0369a1; display: flex; align-items: center; gap: 8px;">
                                <span>❓</span> Discussion Questions
                            </h4>
                            <button onclick="document.getElementById('aiQuestionsDisplay_${enhancementKey}').style.display='none'" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.2em; padding: 0; min-width: auto;" title="Close">&times;</button>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px; flex-wrap: wrap;">
                            <button onclick="copyToClipboard('aiQuestionsContent_${enhancementKey}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Copy to clipboard">📋 Copy</button>
                            <button onclick="aiImproveContent('${enhancementKey}', 'questions')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Regenerate content">🔄 Regenerate</button>
                            <button onclick="toggleEditMode('aiQuestionsContent_${enhancementKey}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Edit content">✏️ Edit</button>
                            <button onclick="saveAIContent('${enhancementKey}', 'questions', 'aiQuestionsContent_${enhancementKey}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Save to localStorage">💾 Save</button>
                            <button onclick="addToNotes('${enhancementKey}', 'aiQuestionsContent_${enhancementKey}', 'Discussion Questions')" style="background: #06b6d4; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Add to lesson notes">✅ Add to Notes</button>
                            <button onclick="toggleStudentView('aiQuestionsContent_${enhancementKey}')" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Preview student view">👁️ Preview</button>
                        </div>
                        <div id="aiQuestionsContent_${enhancementKey}" style="max-height: 400px; overflow-y: auto; line-height: 1.7; color: #334155; font-size: 0.95em;"></div>
                    </div>

                    <div id="aiActivitiesDisplay_${enhancementKey}" style="display: none; margin-top: 20px; background: white; border-radius: 8px; padding: 20px; border: 2px solid #bae6fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #0369a1; display: flex; align-items: center; gap: 8px;">
                                <span>🎯</span> Suggested Activities
                            </h4>
                            <button onclick="document.getElementById('aiActivitiesDisplay_${enhancementKey}').style.display='none'" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.2em; padding: 0; min-width: auto;" title="Close">&times;</button>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px; flex-wrap: wrap;">
                            <button onclick="copyToClipboard('aiActivitiesContent_${enhancementKey}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Copy to clipboard">📋 Copy</button>
                            <button onclick="aiImproveContent('${enhancementKey}', 'activities')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Regenerate content">🔄 Regenerate</button>
                            <button onclick="toggleEditMode('aiActivitiesContent_${enhancementKey}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Edit content">✏️ Edit</button>
                            <button onclick="saveAIContent('${enhancementKey}', 'activities', 'aiActivitiesContent_${enhancementKey}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Save to localStorage">💾 Save</button>
                            <button onclick="addToNotes('${enhancementKey}', 'aiActivitiesContent_${enhancementKey}', 'Suggested Activities')" style="background: #06b6d4; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Add to lesson notes">✅ Add to Notes</button>
                            <button onclick="toggleStudentView('aiActivitiesContent_${enhancementKey}')" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Preview student view">👁️ Preview</button>
                        </div>
                        <div id="aiActivitiesContent_${enhancementKey}" style="max-height: 400px; overflow-y: auto; line-height: 1.7; color: #334155; font-size: 0.95em;"></div>
                    </div>

                    <div id="aiAssessmentDisplay_${enhancementKey}" style="display: none; margin-top: 20px; background: white; border-radius: 8px; padding: 20px; border: 2px solid #bae6fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #0369a1; display: flex; align-items: center; gap: 8px;">
                                <span>📊</span> Homework Questions
                            </h4>
                            <button onclick="document.getElementById('aiAssessmentDisplay_${enhancementKey}').style.display='none'" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.2em; padding: 0; min-width: auto;" title="Close">&times;</button>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px; flex-wrap: wrap;">
                            <button onclick="copyToClipboard('aiAssessmentContent_${enhancementKey}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Copy to clipboard">📋 Copy</button>
                            <button onclick="aiImproveContent('${enhancementKey}', 'assessment')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Regenerate content">🔄 Regenerate</button>
                            <button onclick="toggleEditMode('aiAssessmentContent_${enhancementKey}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Edit content">✏️ Edit</button>
                            <button onclick="saveAIContent('${enhancementKey}', 'assessment', 'aiAssessmentContent_${enhancementKey}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Save to localStorage">💾 Save</button>
                            <button onclick="addToNotes('${enhancementKey}', 'aiAssessmentContent_${enhancementKey}', 'Homework Questions')" style="background: #06b6d4; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Add to lesson notes">✅ Add to Notes</button>
                            <button onclick="toggleStudentView('aiAssessmentContent_${enhancementKey}')" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Preview student view">👁️ Preview</button>
                        </div>
                        <div id="aiAssessmentContent_${enhancementKey}" style="max-height: 400px; overflow-y: auto; line-height: 1.7; color: #334155; font-size: 0.95em;"></div>
                    </div>

                    <div id="aiDifferentiateDisplay_${enhancementKey}" style="display: none; margin-top: 20px; background: white; border-radius: 8px; padding: 20px; border: 2px solid #bae6fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #0369a1; display: flex; align-items: center; gap: 8px;">
                                <span>🎓</span> Differentiation Tips
                            </h4>
                            <button onclick="document.getElementById('aiDifferentiateDisplay_${enhancementKey}').style.display='none'" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.2em; padding: 0; min-width: auto;" title="Close">&times;</button>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px; flex-wrap: wrap;">
                            <button onclick="copyToClipboard('aiDifferentiateContent_${enhancementKey}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Copy to clipboard">📋 Copy</button>
                            <button onclick="aiImproveContent('${enhancementKey}', 'differentiate')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Regenerate content">🔄 Regenerate</button>
                            <button onclick="toggleEditMode('aiDifferentiateContent_${enhancementKey}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Edit content">✏️ Edit</button>
                            <button onclick="saveAIContent('${enhancementKey}', 'differentiate', 'aiDifferentiateContent_${enhancementKey}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Save to localStorage">💾 Save</button>
                            <button onclick="addToNotes('${enhancementKey}', 'aiDifferentiateContent_${enhancementKey}', 'Differentiation Tips')" style="background: #06b6d4; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Add to lesson notes">✅ Add to Notes</button>
                            <button onclick="toggleStudentView('aiDifferentiateContent_${enhancementKey}')" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px;" title="Preview student view">👁️ Preview</button>
                        </div>
                        <div id="aiDifferentiateContent_${enhancementKey}" style="max-height: 400px; overflow-y: auto; line-height: 1.7; color: #334155; font-size: 0.95em;"></div>
                    </div>
                </div>

                <!-- Assessment Builder Section -->
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b;">
                    <h3 style="color: #92400e; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">📝</span> Assessment Builder
                    </h3>
                    <p style="color: #78350f; margin-bottom: 15px; font-size: 0.9em;">Generate homework, rubrics, and activities for this lesson:</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <button onclick="generateAssessment('${enhancementKey}', 'quiz-questions')" style="background: white; border: 2px solid #f59e0b; color: #92400e; padding: 12px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='#f59e0b'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>📝</span> Generate Homework Questions
                        </button>
                        <button onclick="generateAssessment('${enhancementKey}', 'grading-rubric')" style="background: white; border: 2px solid #f59e0b; color: #92400e; padding: 12px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='#f59e0b'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>📊</span> Generate Grading Rubric
                        </button>
                        <button onclick="generateAssessment('${enhancementKey}', 'in-class-activities')" style="background: white; border: 2px solid #f59e0b; color: #92400e; padding: 12px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='#f59e0b'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>🎯</span> Generate Activities
                        </button>
                    </div>

                    <!-- Assessment Display Area -->
                    <div id="assessmentDisplay_${enhancementKey}" style="display: none; background: white; border-radius: 8px; padding: 20px; border: 2px solid #fde68a; max-height: 500px; overflow-y: auto;">
                        <div id="assessmentContent_${enhancementKey}"></div>
                    </div>
                </div>

                <!-- Saved Homework Section -->
                ${enhancement.quiz ? `
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h3 style="color: #047857; margin: 0 0 5px 0; display: flex; align-items: center; gap: 10px;">
                                <span>📝</span> Saved Homework
                            </h3>
                            <div style="color: #6b7280; font-size: 0.85em;">
                                Generated: ${enhancement.quizTimestamp || 'Unknown'}
                                ${enhancement.quizVersions && enhancement.quizVersions.length > 1 ? ` • ${enhancement.quizVersions.length} versions available` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${enhancement.quizVersions && enhancement.quizVersions.length > 1 ? `
                            <button onclick="viewVersionHistory('${enhancementKey}', 'quiz')" style="background: #3b82f6; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                📜 History
                            </button>
                            ` : ''}
                            <button onclick="clearSavedAssessment('${enhancementKey}', 'quiz')" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                        ${formatQuizQuestions(enhancement.quiz)}
                    </div>
                </div>
                ` : ''}

                <!-- Saved Activities Section -->
                ${enhancement.activities ? `
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #8b5cf6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h3 style="color: #6d28d9; margin: 0 0 5px 0; display: flex; align-items: center; gap: 10px;">
                                <span>🎯</span> Saved Activities
                            </h3>
                            <div style="color: #6b7280; font-size: 0.85em;">
                                Generated: ${enhancement.activitiesTimestamp || 'Unknown'}
                                ${enhancement.activitiesVersions && enhancement.activitiesVersions.length > 1 ? ` • ${enhancement.activitiesVersions.length} versions available` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${enhancement.activitiesVersions && enhancement.activitiesVersions.length > 1 ? `
                            <button onclick="viewVersionHistory('${enhancementKey}', 'activities')" style="background: #3b82f6; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                📜 History
                            </button>
                            ` : ''}
                            <button onclick="clearSavedAssessment('${enhancementKey}', 'activities')" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                    <div style="background: #faf5ff; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                        ${formatInClassActivities(enhancement.activities)}
                    </div>
                </div>
                ` : ''}

                <!-- Saved Rubric Section -->
                ${enhancement.rubric ? `
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #f59e0b;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h3 style="color: #d97706; margin: 0 0 5px 0; display: flex; align-items: center; gap: 10px;">
                                <span>📊</span> Saved Grading Rubric
                            </h3>
                            <div style="color: #6b7280; font-size: 0.85em;">
                                Generated: ${enhancement.rubricTimestamp || 'Unknown'}
                                ${enhancement.rubricVersions && enhancement.rubricVersions.length > 1 ? ` • ${enhancement.rubricVersions.length} versions available` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${enhancement.rubricVersions && enhancement.rubricVersions.length > 1 ? `
                            <button onclick="viewVersionHistory('${enhancementKey}', 'rubric')" style="background: #3b82f6; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                📜 History
                            </button>
                            ` : ''}
                            <button onclick="clearSavedAssessment('${enhancementKey}', 'rubric')" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                    <div style="background: #fffbeb; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                        ${formatGradingRubric(enhancement.rubric)}
                    </div>
                </div>
                ` : ''}

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn-save"
                            onclick="openAssignModal('${enhancementKey}', ${JSON.stringify(lesson)}, ${JSON.stringify(subj)}, ${period}, ${grade}, '${dateStr}')"
                            style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);">
                        <span style="display: flex; align-items: center; gap: 8px;">
                            <span>📤</span>
                            <span>Assign to Students</span>
                        </span>
                    </button>
                    <button class="btn-save" onclick="saveEnhancement('${enhancementKey}')">
                        💾 Save Changes
                    </button>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.add('active');

            // Store lesson data for AI functions to access
            window.currentEditingLesson = {
                lesson: lesson,
                subject: subj.subject,
                grade: grade,
                enhancementKey: enhancementKey
            };

            // Initialize markdown preview with current content
            setTimeout(() => updateMarkdownPreview(enhancementKey), 100);

            // Restore saved AI content if it exists
            setTimeout(() => restoreSavedAIContent(enhancementKey), 150);
        }

        function restoreSavedAIContent(enhancementKey) {
            const enhancement = lessonEnhancements[enhancementKey];
            if (!enhancement) return;

            // Initialize temp storage with saved content
            if (!window.tempAIContent) window.tempAIContent = {};
            window.tempAIContent[enhancementKey] = {};

            // Map of improvement types to content keys
            const contentMapping = {
                'expand': 'aiExpand',
                'simplify': 'aiSimplify',
                'questions': 'aiQuestions',
                'activities': 'aiActivities',
                'assessment': 'aiAssessment',
                'differentiate': 'aiDifferentiate'
            };

            // Map improvement type to display section ID
            const displayMapping = {
                'expand': 'aiExpand',
                'simplify': 'aiSimplify',
                'questions': 'aiQuestions',
                'activities': 'aiActivities',
                'assessment': 'aiAssessment',
                'differentiate': 'aiDifferentiate'
            };

            // Restore each type of AI content
            Object.entries(contentMapping).forEach(([improvementType, contentKey]) => {
                const content = enhancement[contentKey];
                if (content) {
                    // Store in temp storage
                    window.tempAIContent[enhancementKey][improvementType] = content;

                    // Get display area and content area
                    const sectionId = displayMapping[improvementType];
                    const displayArea = document.getElementById(`${sectionId}Display_${enhancementKey}`);
                    const contentArea = document.getElementById(`${sectionId}Content_${enhancementKey}`);

                    if (displayArea && contentArea) {
                        // Restore and display the content
                        contentArea.innerHTML = formatAIContent(content);
                        displayArea.style.display = 'block';

                        // Update progress tracker
                        updateAIProgress(enhancementKey, improvementType);
                    }
                }
            });
        }

        async function clearSavedAssessment(enhancementKey, type) {
            if (!confirm(`Are you sure you want to delete this ${type}? This cannot be undone.`)) {
                return;
            }

            const existing = lessonEnhancements[enhancementKey] || {};
            existing[type] = null;
            lessonEnhancements[enhancementKey] = existing;
            await saveLessonEnhancement(enhancementKey, lessonEnhancements[enhancementKey]);

            // Reload the modal to show updated content
            const modal = document.getElementById('editModal');
            modal.classList.remove('active');

            // Re-open the lesson after a brief moment
            setTimeout(() => {
                const currentLesson = window.currentEditingLesson;
                if (currentLesson) {
                    // Trigger a re-open by simulating the click
                    // You'll need to pass the same parameters used to open
                    alert('Assessment deleted! Please close and reopen this lesson to see the changes.');
                }
            }, 100);
        }

        async function saveEnhancement(key) {
            // Get existing enhancement to preserve generated assessments
            const existing = lessonEnhancements[key] || {};

            // Get AI content from temporary storage if it exists
            const aiContent = window.tempAIContent && window.tempAIContent[key] ? window.tempAIContent[key] : {};

            const enhancementData = {
                notes: document.getElementById(`notes_${key}`).value,
                videos: document.getElementById(`videos_${key}`).value.split('\n').filter(v => v.trim()),
                docs: document.getElementById(`docs_${key}`).value.split('\n').filter(d => d.trim()),
                links: document.getElementById(`links_${key}`).value.split('\n').filter(l => l.trim()),
                // Preserve generated assessments and their version history
                quiz: existing.quiz || null,
                rubric: existing.rubric || null,
                activities: existing.activities || null,
                quizVersions: existing.quizVersions || [],
                rubricVersions: existing.rubricVersions || [],
                activitiesVersions: existing.activitiesVersions || [],
                quizTimestamp: existing.quizTimestamp || null,
                rubricTimestamp: existing.rubricTimestamp || null,
                activitiesTimestamp: existing.activitiesTimestamp || null,
                // Save AI-generated content from AI Lesson Assistant
                aiExpand: aiContent.expand || existing.aiExpand || null,
                aiSimplify: aiContent.simplify || existing.aiSimplify || null,
                aiQuestions: aiContent.questions || existing.aiQuestions || null,
                aiActivities: aiContent.activities || existing.aiActivities || null,
                aiAssessment: aiContent.assessment || existing.aiAssessment || null,
                aiDifferentiate: aiContent.differentiate || existing.aiDifferentiate || null
            };

            // Save to in-memory cache
            lessonEnhancements[key] = enhancementData;

            // Save to Supabase database
            const success = await saveLessonEnhancement(key, enhancementData);

            if (success) {
                alert('✅ Lesson enhancements saved to database!');
                closeEditModal();
            }
        }

        // Version History Functions
        function viewVersionHistory(enhancementKey, type) {
            const existing = lessonEnhancements[enhancementKey] || {};
            const versionsKey = type === 'quiz' ? 'quizVersions' :
                               type === 'rubric' ? 'rubricVersions' :
                               'activitiesVersions';
            const versions = existing[versionsKey] || [];

            if (versions.length === 0) {
                alert('No version history available.');
                return;
            }

            const typeLabels = {
                quiz: 'Quiz',
                rubric: 'Grading Rubric',
                activities: 'Activities'
            };

            // Create version history modal
            const modal = document.createElement('div');
            modal.id = 'versionHistoryModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10002;';

            let versionsHTML = versions.map((version, index) => {
                const isCurrent = index === 0;
                return `
                    <div style="background: ${isCurrent ? '#f0f9ff' : 'white'}; padding: 15px; border-radius: 8px; border: 2px solid ${isCurrent ? '#3b82f6' : '#e5e7eb'}; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                                    ${isCurrent ? '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">CURRENT</span>' : ''}
                                    Version ${versions.length - index}
                                </div>
                                <div style="color: #6b7280; font-size: 0.85em; margin-top: 4px;">
                                    ${version.dateDisplay}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="previewVersion('${enhancementKey}', '${type}', ${index})" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                    👁️ Preview
                                </button>
                                ${!isCurrent ? `
                                <button onclick="restoreVersion('${enhancementKey}', '${type}', ${index})" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                    ↩️ Restore
                                </button>
                                <button onclick="deleteVersion('${enhancementKey}', '${type}', ${index})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                    🗑️
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1f2937;">📜 ${typeLabels[type]} Version History</h2>
                        <button onclick="closeVersionHistory()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ✕ Close
                        </button>
                    </div>
                    <div style="color: #6b7280; margin-bottom: 20px;">
                        ${versions.length} version${versions.length > 1 ? 's' : ''} saved. The current version is shown at the top.
                    </div>
                    ${versionsHTML}
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeVersionHistory() {
            const modal = document.getElementById('versionHistoryModal');
            if (modal) {
                document.body.removeChild(modal);
            }
            const previewModal = document.getElementById('versionPreviewModal');
            if (previewModal) {
                document.body.removeChild(previewModal);
            }
        }

        function previewVersion(enhancementKey, type, versionIndex) {
            const existing = lessonEnhancements[enhancementKey] || {};
            const versionsKey = type === 'quiz' ? 'quizVersions' :
                               type === 'rubric' ? 'rubricVersions' :
                               'activitiesVersions';
            const versions = existing[versionsKey] || [];
            const version = versions[versionIndex];

            if (!version) {
                alert('Version not found.');
                return;
            }

            let content = '';
            if (type === 'quiz') {
                content = formatQuizQuestions(version.data);
            } else if (type === 'rubric') {
                content = formatGradingRubric(version.data);
            } else if (type === 'activities') {
                content = formatInClassActivities(version.data);
            }

            const modal = document.createElement('div');
            modal.id = 'versionPreviewModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10003;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0; color: #1f2937;">Preview: Version ${versions.length - versionIndex}</h2>
                            <div style="color: #6b7280; font-size: 0.9em; margin-top: 5px;">${version.dateDisplay}</div>
                        </div>
                        <button onclick="closeVersionHistory()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ✕ Close Preview
                        </button>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                        ${content}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function restoreVersion(enhancementKey, type, versionIndex) {
            if (!confirm('Restore this version? This will create a new version with this content as the current version.')) {
                return;
            }

            const existing = lessonEnhancements[enhancementKey] || {};
            const versionsKey = type === 'quiz' ? 'quizVersions' :
                               type === 'rubric' ? 'rubricVersions' :
                               'activitiesVersions';
            const versions = existing[versionsKey] || [];
            const version = versions[versionIndex];

            if (!version) {
                alert('Version not found.');
                return;
            }

            // Create new version with restored data
            const newVersion = {
                data: version.data,
                timestamp: new Date().toISOString(),
                dateDisplay: new Date().toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }) + ' (Restored)'
            };

            // Add to beginning of versions array
            versions.unshift(newVersion);

            // Keep only last 10 versions
            if (versions.length > 10) {
                existing[versionsKey] = versions.slice(0, 10);
            }

            // Set as current version
            if (type === 'quiz') {
                existing.quiz = version.data;
                existing.quizTimestamp = newVersion.dateDisplay;
            } else if (type === 'rubric') {
                existing.rubric = version.data;
                existing.rubricTimestamp = newVersion.dateDisplay;
            } else if (type === 'activities') {
                existing.activities = version.data;
                existing.activitiesTimestamp = newVersion.dateDisplay;
            }

            lessonEnhancements[enhancementKey] = existing;
            await saveLessonEnhancement(enhancementKey, lessonEnhancements[enhancementKey]);

            alert('✅ Version restored! Close and reopen the lesson to see the changes.');
            closeVersionHistory();
        }

        async function deleteVersion(enhancementKey, type, versionIndex) {
            if (!confirm('Delete this version permanently? This cannot be undone.')) {
                return;
            }

            const existing = lessonEnhancements[enhancementKey] || {};
            const versionsKey = type === 'quiz' ? 'quizVersions' :
                               type === 'rubric' ? 'rubricVersions' :
                               'activitiesVersions';
            const versions = existing[versionsKey] || [];

            // Remove the version
            versions.splice(versionIndex, 1);
            existing[versionsKey] = versions;

            lessonEnhancements[enhancementKey] = existing;
            await saveLessonEnhancement(enhancementKey, lessonEnhancements[enhancementKey]);

            alert('✅ Version deleted!');
            closeVersionHistory();

            // Reopen version history to show updated list
            setTimeout(() => viewVersionHistory(enhancementKey, type), 100);
        }

        // Markdown Preview Functions
        function updateMarkdownPreview(enhancementKey) {
            const notesField = document.getElementById(`notes_${enhancementKey}`);
            const previewDiv = document.getElementById(`preview_${enhancementKey}`);

            if (!notesField || !previewDiv) return;

            const markdownText = notesField.value;

            if (!markdownText.trim()) {
                previewDiv.innerHTML = '<p style="color: #94a3b8; font-style: italic;">Preview will appear here...</p>';
                return;
            }

            // Use marked.js to convert markdown to HTML
            try {
                const htmlContent = marked.parse(markdownText);
                previewDiv.innerHTML = htmlContent;
            } catch (error) {
                console.error('Markdown parsing error:', error);
                previewDiv.innerHTML = '<p style="color: #ef4444;">Error rendering markdown preview</p>';
            }
        }

        function togglePreview(enhancementKey) {
            const previewDiv = document.getElementById(`preview_${enhancementKey}`);
            if (!previewDiv) return;

            if (previewDiv.style.display === 'none') {
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // AI Lesson Improvement Functions
        async function aiImproveContent(enhancementKey, improvementType) {
            // Get lesson data from stored window object
            if (!window.currentEditingLesson) {
                alert('❌ Could not find lesson data. Please close and reopen the lesson.');
                return;
            }

            const { lesson, subject: subjectName, grade } = window.currentEditingLesson;

            // Gather ALL available context for AI generation
            const enhancementContext = {
                notes: document.getElementById(`notes_${enhancementKey}`)?.value || '',
                videos: document.getElementById(`videos_${enhancementKey}`)?.value.split('\n').filter(v => v.trim()) || [],
                docs: document.getElementById(`docs_${enhancementKey}`)?.value.split('\n').filter(d => d.trim()) || [],
                links: document.getElementById(`links_${enhancementKey}`)?.value.split('\n').filter(l => l.trim()) || []
            };

            // Show loading state
            const loadingMsg = {
                'expand': 'Expanding lesson content...',
                'simplify': 'Simplifying lesson text...',
                'questions': 'Generating discussion questions...',
                'activities': 'Suggesting engaging activities...',
                'assessment': 'Creating homework questions...',
                'differentiate': 'Generating differentiation strategies...'
            };

            const originalNotes = document.getElementById(`notes_${enhancementKey}`).value;

            // Show loading indicator with animated AI brain
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'ai-loading';
            loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 40px 60px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 10001; text-align: center; border: 2px solid rgba(102, 126, 234, 0.2);';
            loadingDiv.innerHTML = `
                <div class="ai-brain-loader">
                    <div class="ai-brain">
                        <div class="brain-core"></div>
                        <div class="brain-particle particle-1"></div>
                        <div class="brain-particle particle-2"></div>
                        <div class="brain-particle particle-3"></div>
                        <div class="brain-particle particle-4"></div>
                        <div class="brain-particle particle-5"></div>
                        <div class="brain-particle particle-6"></div>
                    </div>
                </div>
                <div style="font-size: 1.4em; color: #667eea; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    AI Working Its Magic ✨
                </div>
                <div style="font-size: 1.1em; color: #0369a1; font-weight: 600; margin-bottom: 12px;">${loadingMsg[improvementType]}</div>
                <div style="color: #64748b; font-size: 0.95em;">Analyzing your lesson content...</div>
            `;
            document.body.appendChild(loadingDiv);

            try {
                // Generate AI-powered content based on improvement type (with full context)
                const aiContent = await generateAIContent(lesson, improvementType, subjectName, grade, enhancementContext);

                // Store AI content in temporary storage for saving later
                if (!window.tempAIContent) window.tempAIContent = {};
                if (!window.tempAIContent[enhancementKey]) window.tempAIContent[enhancementKey] = {};
                window.tempAIContent[enhancementKey][improvementType] = aiContent;

                // Map improvement type to display section ID
                const displayMapping = {
                    'expand': 'aiExpand',
                    'simplify': 'aiSimplify',
                    'questions': 'aiQuestions',
                    'activities': 'aiActivities',
                    'assessment': 'aiAssessment',
                    'differentiate': 'aiDifferentiate'
                };

                const sectionId = displayMapping[improvementType];

                // Display the AI content in its dedicated section
                const displayArea = document.getElementById(`${sectionId}Display_${enhancementKey}`);
                const contentArea = document.getElementById(`${sectionId}Content_${enhancementKey}`);

                if (displayArea && contentArea) {
                    // Format and display the AI content with nice styling
                    contentArea.innerHTML = formatAIContent(aiContent);
                    displayArea.style.display = 'block';

                    // Update progress tracker and status indicator
                    updateAIProgress(enhancementKey, improvementType);

                    // Scroll to the display area
                    displayArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Remove loading indicator
                document.body.removeChild(loadingDiv);

                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10001; animation: slideIn 0.3s ease-out;';
                successDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5em;">✅</span>
                        <span style="font-weight: 600;">AI content generated!</span>
                    </div>
                `;
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    successDiv.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => document.body.removeChild(successDiv), 300);
                }, 3000);

            } catch (error) {
                document.body.removeChild(loadingDiv);
                alert('❌ AI generation failed. Please try again.');
                console.error('AI generation error:', error);
            }
        }

        function formatAIContent(content) {
            // Convert plain text to nicely formatted HTML with structure
            let formatted = content;

            // Convert markdown-style headers
            formatted = formatted.replace(/^### (.+)$/gm, '<h4 style="color: #0369a1; margin: 20px 0 10px 0; font-weight: 700; font-size: 1.1em;">$1</h4>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h3 style="color: #0369a1; margin: 25px 0 12px 0; font-weight: 700; font-size: 1.2em;">$1</h3>');

            // Convert numbered lists
            formatted = formatted.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin: 8px 0 8px 20px; display: flex; gap: 10px;"><span style="font-weight: 700; color: #0369a1; min-width: 25px;">$1.</span><span style="flex: 1;">$2</span></div>');

            // Convert bullet points
            formatted = formatted.replace(/^[•\-\*]\s+(.+)$/gm, '<div style="margin: 8px 0 8px 20px; display: flex; gap: 10px;"><span style="color: #0ea5e9; font-weight: 700;">•</span><span style="flex: 1;">$1</span></div>');

            // Convert bold text
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #0c4a6e; font-weight: 700;">$1</strong>');

            // Convert inline code or quoted text
            formatted = formatted.replace(/`([^`]+)`/g, '<code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #64748b;">$1</code>');

            // Add paragraph spacing
            formatted = formatted.replace(/\n\n/g, '<br><br>');
            formatted = formatted.replace(/\n/g, '<br>');

            return formatted;
        }

        function addToNotes(enhancementKey, contentElementId, sectionTitle) {
            const contentElement = document.getElementById(contentElementId);
            const notesField = document.getElementById(`notes_${enhancementKey}`);

            if (!contentElement || !notesField) return;

            // Get the plain text content (stripping HTML tags)
            const content = contentElement.innerText;
            const separator = notesField.value.trim() ? '\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n' : '';
            const header = `✨ ${sectionTitle.toUpperCase()}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n`;

            notesField.value = notesField.value + separator + header + content;

            // Update markdown preview
            updateMarkdownPreview(enhancementKey);

            // Show success message
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10001; animation: slideIn 0.3s ease-out;';
            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">✅</span>
                    <span style="font-weight: 600;">Added to lesson notes!</span>
                </div>
            `;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => document.body.removeChild(successDiv), 300);
            }, 2000);

            // Scroll to notes field
            notesField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function toggleStudentView(contentElementId) {
            const contentElement = document.getElementById(contentElementId);
            if (!contentElement) return;

            const content = contentElement.innerHTML;

            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 10002; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; backdrop-filter: blur(4px);';

            modal.innerHTML = `
                <style>
                    .student-view-content {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                        line-height: 1.8;
                        color: #1e293b;
                        font-size: 1.05em;
                    }
                    .student-view-content h1, .student-view-content h2, .student-view-content h3,
                    .student-view-content h4, .student-view-content h5, .student-view-content h6 {
                        font-weight: 700;
                        color: #0f172a;
                        margin-top: 1.5em;
                        margin-bottom: 0.75em;
                        line-height: 1.3;
                    }
                    .student-view-content h1 { font-size: 2em; border-bottom: 3px solid #6366f1; padding-bottom: 0.3em; }
                    .student-view-content h2 { font-size: 1.65em; color: #4338ca; }
                    .student-view-content h3 { font-size: 1.4em; color: #4f46e5; }
                    .student-view-content h4 { font-size: 1.2em; color: #6366f1; }
                    .student-view-content p { margin-bottom: 1.2em; }
                    .student-view-content ul, .student-view-content ol {
                        margin: 1em 0;
                        padding-left: 2em;
                    }
                    .student-view-content li {
                        margin-bottom: 0.6em;
                        line-height: 1.7;
                    }
                    .student-view-content strong {
                        font-weight: 700;
                        color: #1e293b;
                    }
                    .student-view-content em {
                        font-style: italic;
                        color: #475569;
                    }
                    .student-view-content code {
                        background: #f1f5f9;
                        padding: 0.2em 0.4em;
                        border-radius: 4px;
                        font-family: 'Monaco', 'Courier New', monospace;
                        font-size: 0.9em;
                        color: #dc2626;
                    }
                    .student-view-content pre {
                        background: #1e293b;
                        color: #e2e8f0;
                        padding: 1.25em;
                        border-radius: 8px;
                        overflow-x: auto;
                        margin: 1.5em 0;
                        font-size: 0.9em;
                        line-height: 1.6;
                    }
                    .student-view-content blockquote {
                        border-left: 4px solid #6366f1;
                        padding-left: 1.25em;
                        margin: 1.5em 0;
                        color: #475569;
                        font-style: italic;
                        background: #f8fafc;
                        padding: 1em 1.25em;
                        border-radius: 0 8px 8px 0;
                    }
                    .student-view-content a {
                        color: #6366f1;
                        text-decoration: underline;
                        font-weight: 500;
                    }
                    .student-view-content a:hover {
                        color: #4f46e5;
                    }
                    .student-view-content hr {
                        border: none;
                        border-top: 2px solid #e2e8f0;
                        margin: 2em 0;
                    }
                    .student-view-content table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 1.5em 0;
                    }
                    .student-view-content th, .student-view-content td {
                        border: 1px solid #e2e8f0;
                        padding: 0.75em;
                        text-align: left;
                    }
                    .student-view-content th {
                        background: #f1f5f9;
                        font-weight: 700;
                        color: #0f172a;
                    }
                </style>
                <div style="background: white; border-radius: 20px; max-width: 1000px; width: 92%; max-height: 88vh; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.35); animation: slideUp 0.3s ease-out;">
                    <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 24px 30px; color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid #4338ca;">
                        <div>
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 1.4em; font-weight: 700;">
                                <span style="font-size: 1.3em;">👁️</span> Student View Preview
                            </h3>
                            <p style="margin: 8px 0 0 0; opacity: 0.95; font-size: 0.95em; font-weight: 500;">This is how students will see this content</p>
                        </div>
                        <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; font-size: 1.6em; width: 44px; height: 44px; border-radius: 50%; transition: all 0.2s; font-weight: 300; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">&times;</button>
                    </div>
                    <div style="padding: 35px; overflow-y: auto; max-height: calc(88vh - 140px); background: #fafbfc;">
                        <div style="background: white; border-radius: 16px; padding: 35px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;">
                            <div class="student-view-content">${content}</div>
                        </div>
                    </div>
                    <div style="padding: 18px 30px; background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #64748b; font-size: 0.9em; font-weight: 500;">
                            <span style="font-size: 1.2em;">💡</span> Optimized for student readability
                        </div>
                        <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.2s; box-shadow: 0 2px 8px rgba(99,102,241,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(99,102,241,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(99,102,241,0.3)'">
                            ✓ Close Preview
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // New AI Assistant Helper Functions

        function updateAIProgress(enhancementKey, improvementType) {
            // Show status indicator on the button
            const statusIndicator = document.getElementById(`aiStatus_${improvementType}_${enhancementKey}`);
            if (statusIndicator) {
                statusIndicator.style.display = 'flex';
            }

            // Track completion count
            const types = ['expand', 'simplify', 'questions', 'activities', 'assessment', 'differentiate'];
            let completedCount = 0;

            types.forEach(type => {
                const indicator = document.getElementById(`aiStatus_${type}_${enhancementKey}`);
                if (indicator && indicator.style.display !== 'none') {
                    completedCount++;
                }
            });

            // Update progress text and bar
            const progressText = document.getElementById(`aiProgressText_${enhancementKey}`);
            const progressBar = document.getElementById(`aiProgressBar_${enhancementKey}`);

            if (progressText && progressBar) {
                progressText.textContent = `${completedCount}/6 completed`;
                const percentage = (completedCount / 6) * 100;
                progressBar.style.width = `${percentage}%`;
            }

            // Save progress to localStorage
            const savedProgress = JSON.parse(localStorage.getItem('aiContentProgress') || '{}');
            savedProgress[enhancementKey] = savedProgress[enhancementKey] || {};
            savedProgress[enhancementKey][improvementType] = true;
            localStorage.setItem('aiContentProgress', JSON.stringify(savedProgress));
        }

        async function generateAllContent(enhancementKey) {
            if (!confirm('Generate all 6 AI content types? This will take several minutes.')) {
                return;
            }

            const button = document.getElementById(`generateAll_${enhancementKey}`);
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">⏳</span> Generating...';
            button.style.opacity = '0.6';

            const types = ['expand', 'simplify', 'questions', 'activities', 'assessment', 'differentiate'];

            for (let i = 0; i < types.length; i++) {
                try {
                    button.innerHTML = `<span style="display: inline-block; animation: spin 1s linear infinite;">⏳</span> Generating ${i + 1}/6...`;
                    await aiImproveContent(enhancementKey, types[i]);

                    // Wait 2 seconds between calls to avoid rate limiting
                    if (i < types.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                } catch (error) {
                    console.error(`Failed to generate ${types[i]}:`, error);
                }
            }

            button.disabled = false;
            button.innerHTML = originalText;
            button.style.opacity = '1';

            // Show completion message
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10001;';
            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.5em;">🎉</span>
                    <span style="font-weight: 600;">All content generated successfully!</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => document.body.removeChild(successDiv), 4000);
        }

        function copyToClipboard(contentElementId) {
            const contentElement = document.getElementById(contentElementId);
            if (!contentElement) return;

            const text = contentElement.innerText;

            navigator.clipboard.writeText(text).then(() => {
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; animation: slideIn 0.2s ease-out;';
                successDiv.innerHTML = '📋 Copied to clipboard!';
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    successDiv.style.animation = 'slideOut 0.2s ease-out';
                    setTimeout(() => document.body.removeChild(successDiv), 200);
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('❌ Failed to copy to clipboard');
            });
        }

        function toggleEditMode(contentElementId) {
            const contentElement = document.getElementById(contentElementId);
            if (!contentElement) return;

            // Check if already in edit mode
            const isEditing = contentElement.contentEditable === 'true';

            if (isEditing) {
                // Exit edit mode
                contentElement.contentEditable = 'false';
                contentElement.style.border = 'none';
                contentElement.style.padding = '0';
                contentElement.style.background = 'transparent';
            } else {
                // Enter edit mode
                contentElement.contentEditable = 'true';
                contentElement.style.border = '2px dashed #f59e0b';
                contentElement.style.padding = '10px';
                contentElement.style.background = '#fffbeb';
                contentElement.focus();

                // Show edit hint
                const hintDiv = document.createElement('div');
                hintDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f59e0b; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001;';
                hintDiv.innerHTML = '✏️ Edit mode active - Click Edit again to save';
                document.body.appendChild(hintDiv);

                setTimeout(() => document.body.removeChild(hintDiv), 3000);
            }
        }

        function saveAIContent(enhancementKey, contentType, contentElementId) {
            const contentElement = document.getElementById(contentElementId);
            if (!contentElement) return;

            const content = contentElement.innerHTML;

            // Save to localStorage
            const savedContent = JSON.parse(localStorage.getItem('aiGeneratedContent') || '{}');
            savedContent[enhancementKey] = savedContent[enhancementKey] || {};
            savedContent[enhancementKey][contentType] = {
                content: content,
                timestamp: new Date().toISOString(),
                version: (savedContent[enhancementKey][contentType]?.version || 0) + 1
            };
            localStorage.setItem('aiGeneratedContent', JSON.stringify(savedContent));

            // Show save confirmation
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); z-index: 10001; animation: slideIn 0.3s ease-out;';
            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">💾</span>
                    <span style="font-weight: 600;">Saved to localStorage!</span>
                </div>
            `;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => document.body.removeChild(successDiv), 300);
            }, 2500);
        }

        async function generateAIContent(lesson, improvementType, subjectName, grade, enhancementContext = {}) {
            // Call Netlify serverless function to generate AI content using Claude
            try {
                // Map curriculum data structure to API expected format with ALL available context
                const lessonForAPI = {
                    // Core lesson data
                    title: lesson.title || lesson.code || 'Untitled Lesson',
                    code: lesson.code || '',
                    objectives: lesson.objectives || [],
                    subject: subjectName,
                    grade: grade,
                    standards: lesson.standards || '',

                    // Original curriculum fields
                    materials: lesson.materials || '',
                    activities: lesson.activities || [],
                    assessment: lesson.assessment || '',

                    // Teacher enhancements (additional context)
                    notes: enhancementContext.notes || '',
                    videoUrls: enhancementContext.videos || [],
                    documentUrls: enhancementContext.docs || [],
                    additionalLinks: enhancementContext.links || []
                };

                const response = await fetch('/.netlify/functions/improve-lesson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lesson: lessonForAPI,
                        improvementType: improvementType
                    })
                });

                if (!response.ok) {
                    // Handle timeout and other errors that may not return JSON
                    let errorMessage = 'AI service unavailable';
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            console.error('AI API error:', errorData);
                            errorMessage = errorData.error || errorMessage;
                        } else {
                            const errorText = await response.text();
                            console.error('AI API error (non-JSON):', response.status, errorText);
                            if (response.status === 504) {
                                errorMessage = 'Request timeout - the AI is taking too long to respond. Please try again.';
                            }
                        }
                    } catch (parseError) {
                        console.error('Error parsing error response:', parseError);
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                if (!data.success || !data.content) {
                    throw new Error('Invalid response from AI service');
                }

                return data.content;

            } catch (error) {
                console.error('Error calling AI service:', error);

                // Fallback to basic message if AI fails
                throw new Error(`AI service error: ${error.message}. Please try again later.`);
            }
        }

        // Assessment Generation Functions
        async function generateAssessment(enhancementKey, assessmentType) {
            if (!window.currentEditingLesson) {
                alert('❌ Could not find lesson data. Please close and reopen the lesson.');
                return;
            }

            const { lesson, subject: subjectName, grade } = window.currentEditingLesson;

            // Gather ALL available context for AI generation
            const enhancementContext = {
                notes: document.getElementById(`notes_${enhancementKey}`)?.value || '',
                videos: document.getElementById(`videos_${enhancementKey}`)?.value.split('\n').filter(v => v.trim()) || [],
                docs: document.getElementById(`docs_${enhancementKey}`)?.value.split('\n').filter(d => d.trim()) || [],
                links: document.getElementById(`links_${enhancementKey}`)?.value.split('\n').filter(l => l.trim()) || []
            };

            const assessmentLabels = {
                'quiz-questions': 'Homework Questions',
                'grading-rubric': 'Grading Rubric',
                'in-class-activities': 'In-Class Activities'
            };

            // Show loading state
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'assessment-loading';
            loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px 50px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10001; text-align: center;';
            loadingDiv.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 15px;">📝</div>
                <div style="font-size: 1.2em; color: #92400e; font-weight: 600;">Generating ${assessmentLabels[assessmentType]}...</div>
                <div style="margin-top: 15px; color: #78350f;">This may take a few moments...</div>
            `;
            document.body.appendChild(loadingDiv);

            try {
                // Map curriculum data structure to API expected format with ALL available context
                const lessonForAPI = {
                    // Core lesson data
                    title: lesson.title || lesson.code || 'Untitled Lesson',
                    code: lesson.code || '',
                    objectives: lesson.objectives || [],
                    subject: subjectName,
                    grade: grade,
                    standards: lesson.standards || '',

                    // Original curriculum fields
                    materials: lesson.materials || '',
                    activities: lesson.activities || [],
                    assessment: lesson.assessment || '',

                    // Teacher enhancements (additional context)
                    notes: enhancementContext.notes || '',
                    videoUrls: enhancementContext.videos || [],
                    documentUrls: enhancementContext.docs || [],
                    additionalLinks: enhancementContext.links || []
                };

                const response = await fetch('/.netlify/functions/generate-assessment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lesson: lessonForAPI,
                        assessmentType: assessmentType
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Assessment API error:', errorData);
                    throw new Error(errorData.error || 'Assessment service unavailable');
                }

                const data = await response.json();

                if (!data.success || !data.data) {
                    throw new Error('Invalid response from assessment service');
                }

                // Display the generated assessment
                await displayAssessment(enhancementKey, assessmentType, data.data);

                // Remove loading indicator
                document.body.removeChild(loadingDiv);

                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10001;';
                successDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5em;">✅</span>
                        <span style="font-weight: 600;">${assessmentLabels[assessmentType]} Generated!</span>
                    </div>
                `;
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 3000);

            } catch (error) {
                document.body.removeChild(loadingDiv);
                alert('❌ Assessment generation failed. Please try again.');
                console.error('Assessment generation error:', error);
            }
        }

        async function displayAssessment(enhancementKey, assessmentType, data) {
            const displayArea = document.getElementById(`assessmentDisplay_${enhancementKey}`);
            const contentArea = document.getElementById(`assessmentContent_${enhancementKey}`);

            if (!displayArea || !contentArea) return;

            // Save assessment to localStorage with version history
            const existing = lessonEnhancements[enhancementKey] || {};

            // Create version object with timestamp
            const version = {
                data: data,
                timestamp: new Date().toISOString(),
                dateDisplay: new Date().toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                })
            };

            // Map assessment types to storage keys
            const storageKey = assessmentType === 'quiz-questions' ? 'quizVersions' :
                              assessmentType === 'grading-rubric' ? 'rubricVersions' :
                              'activitiesVersions';

            // Initialize versions array if it doesn't exist
            if (!existing[storageKey]) {
                existing[storageKey] = [];
            }

            // Add new version to the beginning of the array
            existing[storageKey].unshift(version);

            // Keep only last 10 versions to avoid localStorage bloat
            if (existing[storageKey].length > 10) {
                existing[storageKey] = existing[storageKey].slice(0, 10);
            }

            // Set current version to the newest one
            if (assessmentType === 'quiz-questions') {
                existing.quiz = data;
                existing.quizTimestamp = version.dateDisplay;
            } else if (assessmentType === 'grading-rubric') {
                existing.rubric = data;
                existing.rubricTimestamp = version.dateDisplay;
            } else if (assessmentType === 'in-class-activities') {
                existing.activities = data;
                existing.activitiesTimestamp = version.dateDisplay;
            }

            lessonEnhancements[enhancementKey] = existing;
            await saveLessonEnhancement(enhancementKey, lessonEnhancements[enhancementKey]);

            // Create unique ID for this assessment content
            const contentId = `assessmentContent_${assessmentType}_${enhancementKey}`;

            const assessmentLabels = {
                'quiz-questions': 'Homework Questions',
                'grading-rubric': 'Grading Rubric',
                'in-class-activities': 'In-Class Activities'
            };

            let formattedContent = '';
            if (assessmentType === 'quiz-questions') {
                formattedContent = formatQuizQuestions(data);
            } else if (assessmentType === 'grading-rubric') {
                formattedContent = formatGradingRubric(data);
            } else if (assessmentType === 'in-class-activities') {
                formattedContent = formatInClassActivities(data);
            }

            // Build complete HTML with Quick Actions Bar
            contentArea.innerHTML = `
                <!-- Quick Actions Bar -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 2px solid #f59e0b;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; flex: 1;">
                        <button onclick="copyAssessmentToClipboard('${contentId}')" style="background: white; border: 2px solid #92400e; color: #92400e; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#92400e'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>📋</span> Copy
                        </button>
                        <button onclick="generateAssessment('${enhancementKey}', '${assessmentType}')" style="background: white; border: 2px solid #92400e; color: #92400e; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#92400e'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>🔄</span> Regenerate
                        </button>
                        <button onclick="toggleEditMode('${contentId}')" style="background: white; border: 2px solid #92400e; color: #92400e; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#92400e'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>✏️</span> Edit
                        </button>
                        <button onclick="saveAssessmentContent('${enhancementKey}', '${assessmentType}', '${contentId}')" style="background: white; border: 2px solid #92400e; color: #92400e; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#92400e'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>💾</span> Save
                        </button>
                        <button onclick="addAssessmentToNotes('${contentId}')" style="background: white; border: 2px solid #92400e; color: #92400e; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#92400e'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>✅</span> Add to Notes
                        </button>
                        <button onclick="toggleStudentView('${contentId}')" style="background: white; border: 2px solid #92400e; color: #92400e; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#92400e'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#92400e'">
                            <span>👁️</span> Preview
                        </button>
                    </div>
                    <button onclick="document.getElementById('assessmentDisplay_${enhancementKey}').style.display='none'" style="background: #dc2626; border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; gap: 6px; margin-left: 10px;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                        <span>✕</span> Close
                    </button>
                </div>

                <!-- Assessment Title -->
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5em;">📝</span>
                        <div>
                            <h4 style="margin: 0; font-size: 1.2em; font-weight: 700;">${assessmentLabels[assessmentType]}</h4>
                            <p style="margin: 5px 0 0 0; font-size: 0.85em; opacity: 0.9;">Generated on ${version.dateDisplay}</p>
                        </div>
                    </div>
                </div>

                <!-- Assessment Content -->
                <div id="${contentId}" style="line-height: 1.7; color: #1f2937;">
                    ${formattedContent}
                </div>
            `;

            displayArea.style.display = 'block';

            // Scroll to the assessment display
            displayArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Helper function to copy assessment content to clipboard
        function copyAssessmentToClipboard(contentId) {
            const contentElement = document.getElementById(contentId);
            if (!contentElement) return;

            const textContent = contentElement.innerText;
            navigator.clipboard.writeText(textContent).then(() => {
                showCopyConfirmation();
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy content');
            });
        }

        // Helper function to add assessment to notes
        function addAssessmentToNotes(contentId) {
            const contentElement = document.getElementById(contentId);
            if (!contentElement) return;

            const textContent = contentElement.innerText;
            const notesField = document.getElementById('additionalNotes');

            if (notesField) {
                const currentNotes = notesField.value.trim();
                const separator = currentNotes ? '\n\n---\n\n' : '';
                notesField.value = currentNotes + separator + textContent;

                // Show confirmation
                const confirmation = document.createElement('div');
                confirmation.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10001; font-weight: 600;';
                confirmation.innerHTML = `<span style="font-size: 1.3em; margin-right: 8px;">✅</span> Added to Additional Notes!`;
                document.body.appendChild(confirmation);

                setTimeout(() => {
                    confirmation.remove();
                }, 2500);

                // Scroll to notes field
                notesField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Multi-Lesson Homework Generator Functions
        function toggleLessonSelector() {
            const panel = document.getElementById('lessonSelectorPanel');
            const btn = document.getElementById('toggleSelectorBtn');

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.textContent = 'Hide Lesson Selector';
                populateLessonCheckboxes();
            } else {
                panel.style.display = 'none';
                btn.textContent = 'Show Lesson Selector';
            }
        }

        function populateLessonCheckboxes() {
            const container = document.getElementById('lessonCheckboxContainer');
            container.innerHTML = '';

            // Get all subjects from curriculum data
            const curriculumMap = window.curriculumMap || window.curriculumData?.curriculumMap;
            if (!curriculumMap) {
                container.innerHTML = '<p style="color: #dc2626;">❌ Curriculum data not loaded yet. Please wait...</p>';
                return;
            }

            // Group lessons by subject
            const lessonsBySubject = {};

            Object.keys(curriculumMap).forEach(subjectKey => {
                const subject = curriculumMap[subjectKey];
                if (!subject || !subject.lessons) return;

                const subjectName = subject.subject || subjectKey;
                const grade = subject.grade || 'Unknown';

                if (!lessonsBySubject[subjectName]) {
                    lessonsBySubject[subjectName] = {
                        grade: grade,
                        lessons: []
                    };
                }

                Object.keys(subject.lessons).forEach(dayKey => {
                    const lesson = subject.lessons[dayKey];
                    if (lesson && lesson.title) {
                        lessonsBySubject[subjectName].lessons.push({
                            key: `${subjectKey}_${dayKey}`,
                            subjectKey: subjectKey,
                            dayKey: dayKey,
                            title: lesson.title || lesson.code || `Lesson ${dayKey}`,
                            code: lesson.code || dayKey
                        });
                    }
                });
            });

            // Create UI for each subject
            Object.keys(lessonsBySubject).forEach(subjectName => {
                const subjectData = lessonsBySubject[subjectName];

                const subjectDiv = document.createElement('div');
                subjectDiv.style.cssText = 'background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';

                let subjectHTML = `
                    <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
                        <div style="font-weight: 700; color: #1e293b; font-size: 1.05em; margin-bottom: 4px;">
                            📚 ${subjectName}
                        </div>
                        <div style="font-size: 0.85em; color: #64748b;">
                            Grade ${subjectData.grade} • ${subjectData.lessons.length} lessons
                        </div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                `;

                subjectData.lessons.forEach(lesson => {
                    subjectHTML += `
                        <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox"
                                   class="lesson-checkbox"
                                   data-lesson-key="${lesson.key}"
                                   data-subject-key="${lesson.subjectKey}"
                                   data-day-key="${lesson.dayKey}"
                                   onchange="updateSelectedCount()"
                                   style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: #334155; font-size: 0.9em;">${lesson.title}</div>
                                <div style="font-size: 0.75em; color: #94a3b8;">${lesson.code}</div>
                            </div>
                        </label>
                    `;
                });

                subjectHTML += `</div>`;
                subjectDiv.innerHTML = subjectHTML;
                container.appendChild(subjectDiv);
            });

            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.lesson-checkbox:checked');
            const count = checkboxes.length;
            const countEl = document.getElementById('selectedCount');

            if (count === 0) {
                countEl.textContent = 'No lessons selected';
                countEl.style.color = '#94a3b8';
            } else {
                countEl.textContent = `${count} lesson${count > 1 ? 's' : ''} selected`;
                countEl.style.color = '#0ea5e9';
                countEl.style.fontWeight = '700';
            }
        }

        async function generateMultiLessonHomework() {
            const checkboxes = document.querySelectorAll('.lesson-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('❌ Please select at least one lesson');
                return;
            }

            // Gather lesson data
            const lessons = [];
            const curriculumMap = window.curriculumMap || window.curriculumData?.curriculumMap;

            checkboxes.forEach(checkbox => {
                const subjectKey = checkbox.dataset.subjectKey;
                const dayKey = checkbox.dataset.dayKey;
                const lesson = curriculumMap[subjectKey]?.lessons?.[dayKey];

                if (lesson) {
                    lessons.push({
                        subjectKey: subjectKey,
                        subject: curriculumMap[subjectKey].subject,
                        grade: curriculumMap[subjectKey].grade,
                        dayKey: dayKey,
                        ...lesson
                    });
                }
            });

            // Show loading state
            const resultsDiv = document.getElementById('multiLessonHomeworkResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 2em; margin-bottom: 15px; animation: spin 1s linear infinite;">⚡</div>
                    <div style="color: #0369a1; font-weight: 600; font-size: 1.1em;">Generating homework from ${lessons.length} lessons...</div>
                    <div style="color: #64748b; font-size: 0.9em; margin-top: 8px;">This may take a moment as the AI analyzes all selected lessons</div>
                </div>
            `;

            try {
                // Call serverless function
                const response = await fetch('/.netlify/functions/generate-assessment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lessons: lessons,
                        assessmentType: 'quiz-questions',
                        multiLesson: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Display results
                displayMultiLessonHomeworkResults(data, lessons);

            } catch (error) {
                console.error('Error generating multi-lesson homework:', error);
                resultsDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 2px solid #fecaca; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">❌</div>
                        <div style="color: #dc2626; font-weight: 600; margin-bottom: 8px;">Error Generating Homework</div>
                        <div style="color: #991b1b; font-size: 0.9em;">${error.message}</div>
                    </div>
                `;
            }
        }

        function displayMultiLessonHomeworkResults(data, lessons) {
            const resultsDiv = document.getElementById('multiLessonHomeworkResults');

            const lessonList = lessons.map(l => `<li>${l.title || l.code} (${l.subject}, Grade ${l.grade})</li>`).join('');

            resultsDiv.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #0369a1; margin: 0 0 12px 0; display: flex; align-items: center; gap: 10px;">
                                <span>✅</span> Multi-Lesson Homework Generated
                            </h3>
                            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 12px 16px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 6px;">Based on ${lessons.length} lessons:</div>
                                <ul style="margin: 0; padding-left: 20px; color: #0369a1; font-size: 0.9em;">
                                    ${lessonList}
                                </ul>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="copyMultiLessonHomework()" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'" title="Copy to clipboard">
                                📋 Copy
                            </button>
                            <button onclick="printMultiLessonHomework()" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'" title="Print homework">
                                🖨️ Print
                            </button>
                        </div>
                    </div>

                    <div id="multiLessonHomeworkContent" style="background: #fafbfc; border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; line-height: 1.8; white-space: pre-wrap; font-family: 'Inter', sans-serif;">
${data}
                    </div>
                </div>
            `;
        }

        function copyMultiLessonHomework() {
            const content = document.getElementById('multiLessonHomeworkContent');
            if (!content) return;

            navigator.clipboard.writeText(content.innerText).then(() => {
                showCopyConfirmation();
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy content');
            });
        }

        function printMultiLessonHomework() {
            const content = document.getElementById('multiLessonHomeworkContent');
            if (!content) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Multi-Lesson Homework</title>
                    <style>
                        body { font-family: 'Inter', Arial, sans-serif; padding: 40px; line-height: 1.6; }
                        h1 { color: #0369a1; }
                        pre { white-space: pre-wrap; }
                    </style>
                </head>
                <body>
                    <h1>Multi-Lesson Homework</h1>
                    <pre>${content.innerText}</pre>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Chat Attachments Management
        let chatAttachments = {
            files: [],
            links: [],
            studentWork: []
        };

        function toggleLinkInput() {
            const linkArea = document.getElementById('linkInputArea');
            if (linkArea.style.display === 'none') {
                linkArea.style.display = 'block';
                document.getElementById('linkUrlInput').focus();
            } else {
                linkArea.style.display = 'none';
                document.getElementById('linkUrlInput').value = '';
                document.getElementById('linkLabelInput').value = '';
            }
        }

        function addLink() {
            const urlInput = document.getElementById('linkUrlInput');
            const labelInput = document.getElementById('linkLabelInput');
            const url = urlInput.value.trim();
            const label = labelInput.value.trim() || url;

            if (!url) {
                alert('❌ Please enter a URL');
                return;
            }

            // Validate URL format
            try {
                new URL(url);
            } catch (e) {
                alert('❌ Please enter a valid URL (must start with http:// or https://)');
                return;
            }

            chatAttachments.links.push({ url, label, timestamp: Date.now() });
            updateAttachmentsDisplay();
            toggleLinkInput();
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`❌ File "${file.name}" is too large. Maximum size is 10MB.`);
                    continue;
                }

                // Read file content
                const reader = new FileReader();
                reader.onload = (e) => {
                    chatAttachments.files.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        content: e.target.result,
                        timestamp: Date.now()
                    });
                    updateAttachmentsDisplay();
                };

                // Read as text for text files, base64 for others
                if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.csv') || file.name.endsWith('.json')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsDataURL(file);
                }
            }

            // Reset file input
            event.target.value = '';
        }

        function updateAttachmentsDisplay() {
            const attachmentsDiv = document.getElementById('chatAttachments');
            const attachmentsList = document.getElementById('attachmentsList');

            const totalAttachments = chatAttachments.files.length + chatAttachments.links.length + chatAttachments.studentWork.length;

            if (totalAttachments === 0) {
                attachmentsDiv.style.display = 'none';
                return;
            }

            attachmentsDiv.style.display = 'block';
            attachmentsList.innerHTML = '';

            // Display files
            chatAttachments.files.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;';
                fileDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                        <span>📄</span>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 0.9em;">${file.name}</div>
                            <div style="font-size: 0.75em; color: #94a3b8;">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                    </div>
                    <button onclick="removeAttachment('file', ${index})" style="background: transparent; border: none; color: #dc2626; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='transparent'">
                        ✕
                    </button>
                `;
                attachmentsList.appendChild(fileDiv);
            });

            // Display links
            chatAttachments.links.forEach((link, index) => {
                const linkDiv = document.createElement('div');
                linkDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;';
                linkDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                        <span>🔗</span>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 0.9em;">${link.label}</div>
                            <div style="font-size: 0.75em; color: #0ea5e9; word-break: break-all;">${link.url}</div>
                        </div>
                    </div>
                    <button onclick="removeAttachment('link', ${index})" style="background: transparent; border: none; color: #dc2626; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='transparent'">
                        ✕
                    </button>
                `;
                attachmentsList.appendChild(linkDiv);
            });

            // Display student work
            chatAttachments.studentWork.forEach((work, index) => {
                const workDiv = document.createElement('div');
                workDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;';
                workDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                        <span>👤</span>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 0.9em;">${work.studentName} - ${work.type}</div>
                            <div style="font-size: 0.75em; color: #94a3b8;">${work.assignmentTitle}</div>
                        </div>
                    </div>
                    <button onclick="removeAttachment('studentWork', ${index})" style="background: transparent; border: none; color: #dc2626; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='transparent'">
                        ✕
                    </button>
                `;
                attachmentsList.appendChild(workDiv);
            });
        }

        function removeAttachment(type, index) {
            if (type === 'file') {
                chatAttachments.files.splice(index, 1);
            } else if (type === 'link') {
                chatAttachments.links.splice(index, 1);
            } else if (type === 'studentWork') {
                chatAttachments.studentWork.splice(index, 1);
            }
            updateAttachmentsDisplay();
        }

        function toggleStudentSubmissions() {
            const panel = document.getElementById('studentSubmissionsPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadStudentSubmissions();
            } else {
                panel.style.display = 'none';
            }
        }

        async function loadStudentSubmissions() {
            const listDiv = document.getElementById('studentSubmissionsList');

            // TODO: Replace with actual API call to fetch student submissions
            // For now, show demo data
            const demoSubmissions = [
                {
                    studentName: 'Sarah Johnson',
                    assignmentTitle: '7.2.a.3 - Religious Liberty Analysis',
                    type: 'NotebookLM',
                    url: 'https://notebooklm.google.com/example1',
                    submittedDate: '2025-10-18',
                    grade: '7',
                    subject: 'Civics',
                    feedback: null
                },
                {
                    studentName: 'Marcus Williams',
                    assignmentTitle: '7.2.a.3 - First Amendment Research',
                    type: 'Gamma Presentation',
                    url: 'https://gamma.app/example2',
                    submittedDate: '2025-10-18',
                    grade: '7',
                    subject: 'Civics',
                    feedback: 'Great work! Could use more examples.'
                },
                {
                    studentName: 'Emma Rodriguez',
                    assignmentTitle: '7.2.a.3 - Establishment Clause Essay',
                    type: 'Document',
                    url: 'https://docs.google.com/document/example3',
                    submittedDate: '2025-10-17',
                    grade: '7',
                    subject: 'Civics',
                    feedback: null
                }
            ];

            listDiv.innerHTML = '';

            demoSubmissions.forEach(submission => {
                const submissionDiv = document.createElement('div');
                submissionDiv.style.cssText = 'background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e5e7eb; transition: all 0.2s; cursor: pointer;';
                submissionDiv.onmouseover = function() { this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; };
                submissionDiv.onmouseout = function() { this.style.boxShadow = 'none'; };

                submissionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 700; color: #1e293b; margin-bottom: 4px;">${submission.studentName}</div>
                            <div style="color: #0369a1; font-size: 0.85em; font-weight: 600;">${submission.assignmentTitle}</div>
                        </div>
                        <div style="background: #0ea5e9; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 700;">
                            ${submission.type}
                        </div>
                    </div>
                    <div style="color: #64748b; font-size: 0.8em; margin-bottom: 8px;">
                        Submitted: ${new Date(submission.submittedDate).toLocaleDateString()}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="analyzeSubmission(${JSON.stringify(submission).replace(/"/g, '&quot;')}); event.stopPropagation();" style="background: #8b5cf6; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.2s;" onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'">
                            🔍 Analyze
                        </button>
                        <button onclick="addSubmissionToChat(${JSON.stringify(submission).replace(/"/g, '&quot;')}); event.stopPropagation();" style="background: #10b981; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                            📎 Add to Chat
                        </button>
                        <a href="${submission.url}" target="_blank" onclick="event.stopPropagation();" style="background: #0ea5e9; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; text-decoration: none; display: inline-block; transition: all 0.2s;" onmouseover="this.style.background='#0284c7'" onmouseout="this.style.background='#0ea5e9'">
                            🔗 Open
                        </a>
                    </div>
                `;
                listDiv.appendChild(submissionDiv);
            });
        }

        function addSubmissionToChat(submission) {
            chatAttachments.studentWork.push(submission);
            updateAttachmentsDisplay();
            toggleStudentSubmissions();

            // Show confirmation
            const confirmation = document.createElement('div');
            confirmation.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10001; font-weight: 600;';
            confirmation.innerHTML = `<span style="font-size: 1.3em; margin-right: 8px;">✅</span> Added ${submission.studentName}'s work to chat!`;
            document.body.appendChild(confirmation);

            setTimeout(() => {
                confirmation.remove();
            }, 2500);
        }

        async function analyzeSubmission(submission) {
            // Add submission to chat
            addSubmissionToChat(submission);

            // Pre-fill chat with analysis request
            const chatInput = document.getElementById('chatInput');
            chatInput.value = `Analyze ${submission.studentName}'s ${submission.type} submission for "${submission.assignmentTitle}". Identify: 1) What concepts they understood well, 2) What areas need improvement, 3) Specific recommendations for reinforcement in future lessons.`;

            // Scroll to chat input
            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            chatInput.focus();
        }

        // Helper function to save assessment content
        function saveAssessmentContent(enhancementKey, assessmentType, contentId) {
            const contentElement = document.getElementById(contentId);
            if (!contentElement) return;

            // The content is already saved via displayAssessment, this just shows confirmation
            const confirmation = document.createElement('div');
            confirmation.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10001; font-weight: 600;';
            confirmation.innerHTML = `<span style="font-size: 1.3em; margin-right: 8px;">💾</span> Assessment Saved!`;
            document.body.appendChild(confirmation);

            setTimeout(() => {
                confirmation.remove();
            }, 2500);
        }

        function formatQuizQuestions(data) {
            if (data.rawContent) {
                return `<div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 2px solid #fca5a5;">
                    <p style="color: #991b1b; font-weight: 600; margin-bottom: 10px;">⚠️ Unable to parse structured data</p>
                    <pre style="background: white; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.85em;">${data.rawContent}</pre>
                </div>`;
            }

            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #92400e; margin-bottom: 10px;">${data.quizTitle || 'Quiz'}</h3>
                    <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.9em; color: #78350f;">
                        <span><strong>Total Points:</strong> ${data.totalPoints || 'N/A'}</span>
                        <span><strong>Time:</strong> ${data.estimatedTime || 'N/A'}</span>
                    </div>
                </div>
            `;

            if (data.questions && data.questions.length > 0) {
                data.questions.forEach((q, index) => {
                    html += `
                        <div style="background: #fefce8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4 style="color: #92400e; margin: 0;">Question ${index + 1} (${q.type})</h4>
                                <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${q.points} pts</span>
                            </div>
                            <p style="color: #1f2937; margin-bottom: 10px; line-height: 1.6;"><strong>${q.question}</strong></p>
                    `;

                    if (q.type === 'multiple-choice') {
                        html += `<div style="margin-left: 15px; margin-bottom: 10px;">`;
                        q.options.forEach(option => {
                            const isCorrect = option.startsWith(q.correctAnswer);
                            html += `<div style="padding: 6px; ${isCorrect ? 'background: #d1fae5; border-radius: 4px; font-weight: 600;' : ''}">${option}</div>`;
                        });
                        html += `</div>`;
                        if (q.explanation) {
                            html += `<div style="background: #e0f2fe; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.9em;">
                                <strong style="color: #0369a1;">Explanation:</strong> ${q.explanation}
                            </div>`;
                        }
                    } else if (q.type === 'short-answer') {
                        if (q.sampleAnswer) {
                            html += `<div style="margin-top: 10px;"><strong style="color: #059669;">Sample Answer:</strong> ${q.sampleAnswer}</div>`;
                        }
                        if (q.keyPoints) {
                            html += `<div style="margin-top: 10px;"><strong>Key Points to Look For:</strong><ul style="margin: 5px 0 0 20px;">`;
                            q.keyPoints.forEach(point => {
                                html += `<li style="color: #374151;">${point}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                    } else if (q.type === 'essay') {
                        if (q.promptGuidance) {
                            html += `<div style="margin-top: 10px;"><strong>Guidance:</strong> ${q.promptGuidance}</div>`;
                        }
                        if (q.requiredLength) {
                            html += `<div style="margin-top: 5px;"><strong>Required Length:</strong> ${q.requiredLength}</div>`;
                        }
                    } else if (q.type === 'drawing-diagram') {
                        if (q.diagramType) {
                            html += `<div style="margin-top: 10px;"><strong>Type:</strong> ${q.diagramType}</div>`;
                        }
                        if (q.requiredElements) {
                            html += `<div style="margin-top: 10px;"><strong>Required Elements:</strong><ul style="margin: 5px 0 0 20px;">`;
                            q.requiredElements.forEach(el => {
                                html += `<li style="color: #374151;">${el}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                    } else if (q.type === 'external-activity') {
                        if (q.activityType) {
                            html += `<div style="margin-top: 10px;"><strong>Activity Type:</strong> ${q.activityType}</div>`;
                        }
                        if (q.instructions) {
                            html += `<div style="margin-top: 10px;"><strong>Instructions:</strong> ${q.instructions}</div>`;
                        }
                        if (q.submissionFormat) {
                            html += `<div style="margin-top: 10px;"><strong>Submission Format:</strong> ${q.submissionFormat}</div>`;
                        }
                    }

                    html += `</div>`;
                });
            }

            return html;
        }

        function formatGradingRubric(data) {
            if (data.rawContent) {
                return `<div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 2px solid #fca5a5;">
                    <p style="color: #991b1b; font-weight: 600; margin-bottom: 10px;">⚠️ Unable to parse structured data</p>
                    <pre style="background: white; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.85em;">${data.rawContent}</pre>
                </div>`;
            }

            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #92400e; margin-bottom: 10px;">${data.rubricTitle || 'Grading Rubric'}</h3>
                    <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.9em; color: #78350f;">
                        <span><strong>Assessment Type:</strong> ${data.assessmentType || 'N/A'}</span>
                        <span><strong>Total Points:</strong> ${data.totalPoints || 'N/A'}</span>
                    </div>
                </div>
            `;

            if (data.criteria && data.criteria.length > 0) {
                data.criteria.forEach((criterion, index) => {
                    html += `
                        <div style="background: #fefce8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #92400e; margin: 0;">${criterion.category}</h4>
                                <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${criterion.weight}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    `;

                    if (criterion.levels) {
                        criterion.levels.forEach(level => {
                            const levelColors = {
                                'Exemplary': '#10b981',
                                'Proficient': '#3b82f6',
                                'Developing': '#f59e0b',
                                'Beginning': '#ef4444'
                            };
                            const color = levelColors[level.level] || '#6b7280';
                            html += `
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid ${color};">
                                    <div style="font-weight: 600; color: ${color}; margin-bottom: 5px;">${level.level}</div>
                                    <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 8px;">${level.points}</div>
                                    <div style="font-size: 0.9em; color: #374151; line-height: 1.4;">${level.description}</div>
                                </div>
                            `;
                        });
                    }

                    html += `</div></div>`;
                });
            }

            if (data.gradingGuidelines && data.gradingGuidelines.length > 0) {
                html += `
                    <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="color: #0369a1; margin-bottom: 10px;">Grading Guidelines</h4>
                        <ul style="margin: 0 0 0 20px; color: #374151;">
                `;
                data.gradingGuidelines.forEach(guideline => {
                    html += `<li style="margin-bottom: 5px;">${guideline}</li>`;
                });
                html += `</ul></div>`;
            }

            if (data.feedbackPrompts) {
                html += `<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="color: #059669; margin-bottom: 10px;">Feedback Prompts</h4>
                `;
                if (data.feedbackPrompts.strengths) {
                    html += `<div style="margin-bottom: 10px;"><strong>Strengths:</strong><ul style="margin: 5px 0 0 20px; color: #374151;">`;
                    data.feedbackPrompts.strengths.forEach(s => html += `<li>${s}</li>`);
                    html += `</ul></div>`;
                }
                if (data.feedbackPrompts.improvements) {
                    html += `<div style="margin-bottom: 10px;"><strong>Areas for Improvement:</strong><ul style="margin: 5px 0 0 20px; color: #374151;">`;
                    data.feedbackPrompts.improvements.forEach(i => html += `<li>${i}</li>`);
                    html += `</ul></div>`;
                }
                if (data.feedbackPrompts.nextSteps) {
                    html += `<div><strong>Next Steps:</strong><ul style="margin: 5px 0 0 20px; color: #374151;">`;
                    data.feedbackPrompts.nextSteps.forEach(n => html += `<li>${n}</li>`);
                    html += `</ul></div>`;
                }
                html += `</div>`;
            }

            return html;
        }

        function formatInClassActivities(data) {
            if (data.rawContent) {
                return `<div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 2px solid #fca5a5;">
                    <p style="color: #991b1b; font-weight: 600; margin-bottom: 10px;">⚠️ Unable to parse structured data</p>
                    <pre style="background: white; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.85em;">${data.rawContent}</pre>
                </div>`;
            }

            let html = `<div style="margin-bottom: 20px;">
                <h3 style="color: #92400e; margin-bottom: 5px;">${data.lessonTitle || 'In-Class Activities'}</h3>
            </div>`;

            // Warm-up
            if (data.warmUp) {
                html += `
                    <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin-bottom: 8px;">🔥 Warm-Up (${data.warmUp.duration})</h4>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 5px;">${data.warmUp.title}</div>
                        <div style="color: #374151;">${data.warmUp.activity}</div>
                    </div>
                `;
            }

            // Main Activities
            if (data.activities && data.activities.length > 0) {
                data.activities.forEach((activity, index) => {
                    html += `
                        <div style="background: #fefce8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4 style="color: #92400e; margin: 0;">Activity ${index + 1}: ${activity.title}</h4>
                                <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${activity.duration}</span>
                            </div>
                            <div style="margin-bottom: 8px;"><strong>Type:</strong> <span style="text-transform: capitalize;">${activity.type}</span></div>
                            <div style="margin-bottom: 8px;"><strong>Objective:</strong> ${activity.objective}</div>
                            ${activity.materials && activity.materials.length > 0 ? `<div style="margin-bottom: 8px;"><strong>Materials:</strong> ${activity.materials.join(', ')}</div>` : ''}
                            ${activity.setup ? `<div style="margin-bottom: 8px;"><strong>Setup:</strong> ${activity.setup}</div>` : ''}
                            ${activity.procedure && activity.procedure.length > 0 ? `
                                <div style="margin: 10px 0;">
                                    <strong>Procedure:</strong>
                                    <ol style="margin: 5px 0 0 20px;">
                                        ${activity.procedure.map(step => `<li style="margin-bottom: 5px; color: #374151;">${step}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            ${activity.differentiation ? `
                                <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                    <strong style="color: #059669;">Differentiation:</strong>
                                    <div style="margin-top: 8px; font-size: 0.9em;">
                                        ${activity.differentiation.support ? `<div style="margin-bottom: 5px;"><strong>Support:</strong> ${activity.differentiation.support}</div>` : ''}
                                        ${activity.differentiation.extension ? `<div style="margin-bottom: 5px;"><strong>Extension:</strong> ${activity.differentiation.extension}</div>` : ''}
                                        ${activity.differentiation.ell ? `<div><strong>ELL:</strong> ${activity.differentiation.ell}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${activity.assessment ? `<div style="margin-top: 8px;"><strong>Assessment:</strong> ${activity.assessment}</div>` : ''}
                            ${activity.digitalTools && activity.digitalTools.length > 0 ? `<div style="margin-top: 8px;"><strong>Digital Tools:</strong> ${activity.digitalTools.join(', ')}</div>` : ''}
                        </div>
                    `;
                });
            }

            // Closure
            if (data.closure) {
                html += `
                    <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1;">
                        <h4 style="color: #4338ca; margin-bottom: 8px;">🎯 Closure (${data.closure.duration})</h4>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 5px;">${data.closure.title}</div>
                        <div style="color: #374151; margin-bottom: 8px;">${data.closure.activity}</div>
                        ${data.closure.exitTicket ? `<div style="background: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <strong style="color: #6366f1;">Exit Ticket:</strong> ${data.closure.exitTicket}
                        </div>` : ''}
                    </div>
                `;
            }

            return html;
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Helper function to map subject names to filter types
        function getSubjectType(subjectName) {
            const normalized = subjectName.toLowerCase();
            if (normalized.includes('math') || normalized.includes('algebra') || normalized.includes('geometry') || normalized.includes('calculus')) {
                return 'math';
            }
            if (normalized.includes('english') || normalized.includes('ela')) {
                return 'ela';
            }
            if (normalized.includes('science')) {
                return 'science';
            }
            if (normalized.includes('history')) {
                return 'history';
            }
            if (normalized.includes('civics')) {
                return 'civics';
            }
            if (normalized.includes('government')) {
                return 'government';
            }
            return 'other';
        }

        function changeMonth(delta) {
            console.log('changeMonth called with delta:', delta);
            console.log('Current view mode:', currentViewMode);
            console.log('Current date before change:', currentMonth.toLocaleDateString());

            // Navigate based on current view mode
            if (currentViewMode === 'week' || currentViewMode === 'assignments') {
                // For week views, navigate by weeks (7 days)
                currentMonth.setDate(currentMonth.getDate() + (delta * 7));
            } else if (currentViewMode === 'day') {
                // For day view, navigate by days
                currentMonth.setDate(currentMonth.getDate() + delta);
            } else {
                // For month/list/sequence/grading views, navigate by months
                currentMonth.setMonth(currentMonth.getMonth() + delta);
            }

            console.log('Current date after change:', currentMonth.toLocaleDateString());

            try {
                renderView();
            } catch (error) {
                console.error('Error in renderView during navigation:', error);
            }
        }

        // DAY VIEW - Show single day schedule
        function renderDayView() {
            const grid = document.getElementById('calendarGrid');
            // Override grid display for day view
            grid.style.display = 'block';
            grid.style.gridTemplateColumns = 'none';

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const day = currentMonth.getDate();
            const date = new Date(year, month, day);
            const dateStr = date.toISOString().split('T')[0];

            document.getElementById('currentMonth').textContent =
                date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const dayType = getABDay(dateStr);
            const isNoSchool = schoolCalendar.noSchoolDays.has(dateStr);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;

            let html = '<div style="padding: 20px; max-width: 1400px; margin: 0 auto;">';

            if (isNoSchool || isWeekend) {
                html += `<div style="text-align: center; padding: 60px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); color: white;">
                    <div style="font-size: 4em; margin-bottom: 15px;">${isNoSchool ? '🏖️' : '📅'}</div>
                    <div style="font-size: 1.8em; font-weight: 700;">${isNoSchool ? 'No School' : 'Weekend'}</div>
                    <div style="font-size: 1.1em; margin-top: 10px; opacity: 0.9;">Enjoy your day off!</div>
                </div>`;
            } else if (dayType) {
                const dayNum = getDayNumber(dateStr, dayType);

                // Day header
                html += `<div style="text-align: center; padding: 25px; margin-bottom: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.15);">
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.95em; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px;">School Day</div>
                    <div style="color: white; font-size: 2.2em; font-weight: 800; letter-spacing: 0.5px;">Day ${dayNum} - ${dayType}</div>
                </div>`;

                const periods = periodFilter === 'all' ? [1, 2, 3, 4] : [parseInt(periodFilter)];
                const grades = gradeFilter === 'all' ? [7, 9, 11] : [parseInt(gradeFilter)];

                // Period color mapping
                const periodColors = {
                    1: '#3B82F6',
                    2: '#10B981',
                    3: '#F59E0B',
                    4: '#EF4444'
                };

                html += '<div style="display: flex; flex-direction: column; gap: 24px;">';

                periods.forEach(period => {
                    const periodColor = periodColors[period];
                    const timeSlot = period === 1 ? '8:15-9:45' : period === 2 ? '9:51-11:21' : period === 3 ? '12:12-1:42' : '1:42-3:15';

                    // Period section header
                    html += `<div style="margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="background: ${periodColor}; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 1.1em;">
                                Period ${period}
                            </div>
                            <div style="color: #64748b; font-size: 0.95em; font-weight: 600;">
                                ${timeSlot}
                            </div>
                        </div>
                    </div>`;

                    let hasLessons = false;
                    grades.forEach(grade => {
                        const subj = periodStructure[dayType]?.[period]?.[grade];
                        if (subj) {
                            const subjectType = getSubjectType(subj.subject);
                            if (subjectFilter !== 'all' && subjectType !== subjectFilter) {
                                return;
                            }

                            // Student View Mode: Filter lessons by enrollment
                            if (!isStudentEnrolledInLesson(subj.key, period, dayType)) {
                                return; // Student not enrolled in this lesson
                            }

                            const dayKey = `${dayNum}.${dayType}`;
                            const lesson = window.curriculumData?.getLesson(subj.key, dayKey);

                            if (lesson) {
                                hasLessons = true;
                                const lessonCode = lesson.code || 'N/A';

                                html += `
                                    <div class="lesson-item ${subj.class}"
                                         style="background: white; border: 1px solid #e5e7eb; border-left: 4px solid ${periodColor}; border-radius: 8px; padding: 16px; margin: 0 0 12px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;"
                                         onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                                         onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'"
                                         onclick="openEditModal(event, '${dateStr}', '${dayType}', ${dayNum}, ${period}, ${grade})">
                                        <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 12px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="background: ${periodColor}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 700;">
                                                    P${period}
                                                </span>
                                                <span style="background: #f3f4f6; color: #1f2937; padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 700;">
                                                    Grade ${grade}
                                                </span>
                                            </div>
                                            <span style="color: #64748b; font-size: 14px; font-weight: 600;">
                                                ${lessonCode}
                                            </span>
                                        </div>
                                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: #1f2937;">
                                            ${subj.subject}
                                        </div>
                                        <div style="color: #64748b; font-size: 13px; line-height: 1.5;">
                                            ${lesson.title || 'Lesson ' + lessonCode}
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    });

                    if (!hasLessons) {
                        html += `<div style="background: white; border: 1px solid #e5e7eb; border-left: 4px solid ${periodColor}; border-radius: 8px; padding: 24px; text-align: center; color: #9ca3af; font-style: italic; margin-bottom: 12px;">
                            No lessons scheduled for this period
                        </div>`;
                    }
                });

                html += '</div>';
            }

            html += '</div>';
            grid.innerHTML = html;
        }

        // WEEK VIEW - Show week schedule
        function renderWeekView() {
            const grid = document.getElementById('calendarGrid');
            // Override grid display for week view to prevent column constraints
            grid.style.display = 'block';
            grid.style.gridTemplateColumns = 'none';

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const day = currentMonth.getDate();
            const currentDate = new Date(year, month, day);

            // Get start of week (Sunday)
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

            // Get end of week (Saturday)
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            document.getElementById('currentMonth').textContent =
                `Week of ${startOfWeek.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;

            // Period color mapping
            const periodColors = {
                1: '#3B82F6',
                2: '#10B981',
                3: '#F59E0B',
                4: '#EF4444'
            };

            let html = '<div style="display: block !important; width: 100%; padding: 20px; overflow-x: auto;">';
            html += '<div style="display: grid; grid-template-columns: repeat(5, minmax(220px, 1fr)); gap: 16px; min-width: 1200px;">';

            // Show Monday through Friday
            for (let i = 1; i <= 5; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayType = getABDay(dateStr);
                const isNoSchool = schoolCalendar.noSchoolDays.has(dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];

                html += `<div style="background: #f9fafb; border-radius: 12px; overflow: hidden; ${isToday ? 'border: 3px solid #667eea;' : 'border: 1px solid #e5e7eb;'}">`;

                // Day header
                html += `<div style="background: ${isToday ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#1f2937'}; padding: 16px; text-align: center; position: relative;">
                    ${isToday ? '<div style="position: absolute; top: 8px; right: 8px; background: #fbbf24; color: #78350f; padding: 3px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 700;">TODAY</div>' : ''}
                    <div style="color: white; font-size: 1.1em; font-weight: 700; margin-bottom: 4px;">
                        ${date.toLocaleDateString('en-US', { weekday: 'short' })}
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9em;">
                        ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </div>
                </div>`;

                html += '<div style="padding: 12px; min-height: 500px;">';

                if (isNoSchool) {
                    html += `<div style="text-align: center; padding: 40px 10px; color: #ef4444;">
                        <div style="font-size: 2.5em; margin-bottom: 8px;">🏖️</div>
                        <div style="font-weight: 600;">No School</div>
                    </div>`;
                } else if (dayType) {
                    const dayNum = getDayNumber(dateStr, dayType);

                    // Day type badge
                    html += `<div style="text-align: center; margin-bottom: 12px;">
                        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 5px 14px; border-radius: 20px; font-size: 0.8em; font-weight: 700; box-shadow: 0 2px 6px rgba(102,126,234,0.3);">
                            Day ${dayNum}-${dayType}
                        </span>
                    </div>`;

                    const periods = periodFilter === 'all' ? [1, 2, 3, 4] : [parseInt(periodFilter)];
                    const grades = gradeFilter === 'all' ? [7, 9, 11] : [parseInt(gradeFilter)];

                    let hasLessons = false;
                    periods.forEach(period => {
                        grades.forEach(grade => {
                            const subj = periodStructure[dayType]?.[period]?.[grade];
                            if (subj) {
                                const subjectType = getSubjectType(subj.subject);
                                if (subjectFilter !== 'all' && subjectType !== subjectFilter) {
                                    return;
                                }

                                // Student View Mode: Filter lessons by enrollment
                                if (!isStudentEnrolledInLesson(subj.key, period, dayType)) {
                                    return; // Student not enrolled in this lesson
                                }

                                const dayKey = `${dayNum}.${dayType}`;
                                const lesson = window.curriculumData?.getLesson(subj.key, dayKey);

                                if (lesson) {
                                    hasLessons = true;
                                    const lessonCode = lesson.code || 'N/A';
                                    const periodColor = periodColors[period];

                                    html += `
                                        <div class="lesson-item ${subj.class}"
                                             style="background: white; border: 1px solid #e5e7eb; border-left: 4px solid ${periodColor}; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; min-height: 80px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s ease;"
                                             onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                                             onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'"
                                             onclick="openEditModal(event, '${dateStr}', '${dayType}', ${dayNum}, ${period}, ${grade})">
                                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                                                <span style="background: ${periodColor}; color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.75em; font-weight: 700;">
                                                    P${period}
                                                </span>
                                                <span style="background: #f3f4f6; color: #1f2937; padding: 3px 8px; border-radius: 6px; font-size: 0.75em; font-weight: 700;">
                                                    Gr${grade}
                                                </span>
                                            </div>
                                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #1f2937; line-height: 1.3;">
                                                ${subj.subject}
                                            </div>
                                            <div style="font-size: 13px; color: #64748b; font-weight: 600;">
                                                ${lessonCode}
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                        });
                    });

                    if (!hasLessons) {
                        html += `<div style="text-align: center; padding: 30px 10px; color: #9ca3af; font-size: 0.85em; font-style: italic;">
                            No lessons scheduled
                        </div>`;
                    }
                } else {
                    html += `<div style="text-align: center; padding: 40px 10px; color: #9ca3af;">
                        <div style="font-size: 2em; margin-bottom: 8px;">📅</div>
                        <div style="font-size: 0.85em;">Weekend</div>
                    </div>`;
                }

                html += '</div></div>';
            }

            html += '</div></div>';
            grid.innerHTML = html;
        }

        // LIST VIEW - Show all lessons in list format
        function renderListView() {
            const grid = document.getElementById('calendarGrid');
            // Override grid display for list view
            grid.style.display = 'block';
            grid.style.gridTemplateColumns = 'none';

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('currentMonth').textContent =
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Collect all lessons for the month
            const lessons = [];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();

                if (dayOfWeek === 0 || dayOfWeek === 6) continue; // Skip weekends
                if (schoolCalendar.noSchoolDays.has(dateStr)) continue;

                const dayType = getABDay(dateStr);
                if (!dayType) continue;

                const dayNum = getDayNumber(dateStr, dayType);
                const periods = periodFilter === 'all' ? [1, 2, 3, 4] : [parseInt(periodFilter)];
                const grades = gradeFilter === 'all' ? [7, 9, 11] : [parseInt(gradeFilter)];

                periods.forEach(period => {
                    grades.forEach(grade => {
                        const subj = periodStructure[dayType]?.[period]?.[grade];
                        if (subj) {
                            const subjectType = getSubjectType(subj.subject);
                            if (subjectFilter !== 'all' && subjectType !== subjectFilter) {
                                return;
                            }

                            // Student View Mode: Filter lessons by enrollment
                            if (!isStudentEnrolledInLesson(subj.key, period, dayType)) {
                                return; // Student not enrolled in this lesson
                            }

                            const dayKey = `${dayNum}.${dayType}`;
                            const lesson = window.curriculumData?.getLesson(subj.key, dayKey);

                            if (lesson) {
                                lessons.push({
                                    date,
                                    dateStr,
                                    dayType,
                                    dayNum,
                                    period,
                                    grade,
                                    subj,
                                    lesson
                                });
                            }
                        }
                    });
                });
            }

            // Period color mapping
            const periodColors = {
                1: '#3B82F6',
                2: '#10B981',
                3: '#F59E0B',
                4: '#EF4444'
            };

            let html = '<div style="padding: 20px;">';
            html += '<div style="max-width: 1400px; margin: 0 auto;">';

            // Summary stats card
            if (lessons.length > 0) {
                const uniqueDays = new Set(lessons.map(l => l.dateStr)).size;
                const uniqueSubjects = new Set(lessons.map(l => l.subj.subject)).size;

                html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); color: white;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 2.5em; font-weight: 800; margin-bottom: 5px;">${lessons.length}</div>
                            <div style="font-size: 0.95em; opacity: 0.9; font-weight: 600;">Total Lessons</div>
                        </div>
                        <div>
                            <div style="font-size: 2.5em; font-weight: 800; margin-bottom: 5px;">${uniqueDays}</div>
                            <div style="font-size: 0.95em; opacity: 0.9; font-weight: 600;">School Days</div>
                        </div>
                        <div>
                            <div style="font-size: 2.5em; font-weight: 800; margin-bottom: 5px;">${uniqueSubjects}</div>
                            <div style="font-size: 0.95em; opacity: 0.9; font-weight: 600;">Subjects</div>
                        </div>
                    </div>
                </div>`;
            }

            if (lessons.length === 0) {
                html += `<div style="text-align: center; padding: 80px 40px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.3;">📚</div>
                    <div style="color: #64748b; font-size: 1.3em; font-weight: 600; margin-bottom: 10px;">No lessons found</div>
                    <div style="color: #9ca3af; font-size: 1em;">Try adjusting your filters to see more results</div>
                </div>`;
            } else {
                // Render lessons as simple chronological list
                html += '<div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">';

                lessons.forEach((item, index) => {
                    const lessonCode = item.lesson.code || 'N/A';
                    const periodColor = periodColors[item.period];
                    const isLast = index === lessons.length - 1;
                    const timeSlot = item.period === 1 ? '8:15-9:45' : item.period === 2 ? '9:51-11:21' : item.period === 3 ? '12:12-1:42' : '1:42-3:15';

                    html += `
                        <div class="lesson-item ${item.subj.class}"
                             style="background: white; border: 1px solid #e5e7eb; border-left: 4px solid ${periodColor}; border-radius: 8px; padding: 16px; margin: 0 0 12px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;"
                             onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'"
                             onclick="openEditModal(event, '${item.dateStr}', '${item.dayType}', ${item.dayNum}, ${item.period}, ${item.grade})">

                            <div style="display: grid; grid-template-columns: 160px 120px 100px minmax(300px, 1fr); gap: 16px; align-items: center;">

                                <!-- Date Column -->
                                <div>
                                    <div style="font-weight: 700; font-size: 14px; color: #1f2937; margin-bottom: 4px;">
                                        ${item.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                                    </div>
                                    <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 700;">
                                        Day ${item.dayNum}-${item.dayType}
                                    </div>
                                </div>

                                <!-- Period Badge -->
                                <div style="text-align: center;">
                                    <div style="background: ${periodColor}; color: white; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 0.95em;">
                                        Period ${item.period}
                                    </div>
                                    <div style="font-size: 0.7em; color: #9ca3af; margin-top: 4px; font-weight: 600;">
                                        ${timeSlot}
                                    </div>
                                </div>

                                <!-- Grade Badge -->
                                <div style="text-align: center;">
                                    <div style="background: #f3f4f6; color: #1f2937; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 0.95em;">
                                        Grade ${item.grade}
                                    </div>
                                </div>

                                <!-- Lesson Info -->
                                <div style="min-width: 0; overflow: hidden;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px; flex-wrap: wrap;">
                                        <div style="font-weight: 600; font-size: 16px; color: #1f2937; flex-shrink: 0;">${item.subj.subject}</div>
                                        <span style="color: #64748b; font-size: 14px; font-weight: 600; white-space: nowrap;">
                                            ${lessonCode}
                                        </span>
                                    </div>
                                    <div style="color: #64748b; font-size: 13px; line-height: 1.4;">
                                        ${item.lesson.title || 'Lesson ' + lessonCode}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            html += '</div></div>';
            grid.innerHTML = html;
        }

        // Get Florida CPALMS course URL for a subject
        function getCPALMSUrl(subjectKey) {
            const cpalmsMap = {
                // 7th Grade
                '7th_math': 'https://www.cpalms.org/PreviewCourse/Preview/23071',  // Pre-Algebra
                '7th_science': 'https://www.cpalms.org/search/Standard',  // Life Science (general search)
                '7th_ela': 'https://www.cpalms.org/search/Standard',  // ELA 7 (general search)
                '7th_civics': 'https://www.cpalms.org/public/search/Standard',  // Civics & Government

                // 9th Grade
                '9th_math': 'https://www.cpalms.org/PreviewCourse/Preview/23375',  // Geometry
                '9th_ela': 'https://www.cpalms.org/PreviewCourse/Preview/23457',  // English I
                '9th_world_history': 'https://www.cpalms.org/PreviewCourse/Preview/22644',  // World History

                // 11th Grade
                '11th_math': 'https://www.cpalms.org/PreviewCourse/Preview/15',  // PreCalculus Honors
                '11th_ela': 'https://www.cpalms.org/PreviewCourse/Preview/1676',  // ELA III
                '11th_us_gvmnt': 'https://www.cpalms.org/PreviewCourse/Preview/633',  // US Government
                '11th_economics': 'https://www.cpalms.org/PreviewCourse/Preview/4430'  // Economics
            };

            return cpalmsMap[subjectKey] || null;
        }

        // Render Sequence View - Shows curriculum progression with past/present/future indicators
        function renderSequenceView() {
            const grid = document.getElementById('calendarGrid');
            grid.style.display = 'block';
            grid.style.gridTemplateColumns = 'none';

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('currentMonth').textContent =
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Collect all lessons for the month
            const lessons = [];
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();

                if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                if (schoolCalendar.noSchoolDays.has(dateStr)) continue;

                const dayType = getABDay(dateStr);
                if (!dayType) continue;

                const dayNum = getDayNumber(dateStr, dayType);
                const periods = periodFilter === 'all' ? [1, 2, 3, 4] : [parseInt(periodFilter)];
                const grades = gradeFilter === 'all' ? [7, 9, 11] : [parseInt(gradeFilter)];

                periods.forEach(period => {
                    grades.forEach(grade => {
                        const subj = periodStructure[dayType]?.[period]?.[grade];
                        if (subj) {
                            const subjectType = getSubjectType(subj.subject);
                            if (subjectFilter !== 'all' && subjectType !== subjectFilter) {
                                return;
                            }

                            if (!isStudentEnrolledInLesson(subj.key, period, dayType)) {
                                return;
                            }

                            const dayKey = `${dayNum}.${dayType}`;
                            const lesson = window.curriculumData?.getLesson(subj.key, dayKey);

                            if (lesson) {
                                // Determine lesson status
                                let status = 'upcoming';
                                const lessonDate = new Date(date);
                                lessonDate.setHours(0, 0, 0, 0);

                                if (lessonDate < today) {
                                    status = 'taught';
                                } else if (lessonDate.getTime() === today.getTime()) {
                                    status = 'today';
                                }

                                lessons.push({
                                    date,
                                    dateStr,
                                    dayType,
                                    dayNum,
                                    period,
                                    grade,
                                    subj,
                                    lesson,
                                    status
                                });
                            }
                        }
                    });
                });
            }

            // Group lessons by subject
            const subjectGroups = {};
            lessons.forEach(l => {
                const key = `${l.subj.key}_period${l.period}`;
                if (!subjectGroups[key]) {
                    subjectGroups[key] = {
                        subject: l.subj.subject,
                        subjectKey: l.subj.key,
                        period: l.period,
                        grade: l.grade,
                        lessons: []
                    };
                }
                subjectGroups[key].lessons.push(l);
            });

            // Sort lessons within each subject by date
            Object.values(subjectGroups).forEach(group => {
                group.lessons.sort((a, b) => a.date - b.date);
            });

            // Calculate overall progress
            const taughtCount = lessons.filter(l => l.status === 'taught').length;
            const totalCount = lessons.length;
            const progressPercent = totalCount > 0 ? Math.round((taughtCount / totalCount) * 100) : 0;

            let html = '<div style="padding: 20px;">';
            html += '<div style="max-width: 1400px; margin: 0 auto;">';

            // Progress Summary Card
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); color: white;">
                <h2 style="margin: 0 0 20px 0; font-size: 1.5em;">📚 Curriculum Sequence & Progress</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                    <div>
                        <div style="font-size: 2.5em; font-weight: 800; margin-bottom: 5px;">${taughtCount}</div>
                        <div style="font-size: 0.95em; opacity: 0.9; font-weight: 600;">Lessons Taught</div>
                    </div>
                    <div>
                        <div style="font-size: 2.5em; font-weight: 800; margin-bottom: 5px;">${totalCount - taughtCount}</div>
                        <div style="font-size: 0.95em; opacity: 0.9; font-weight: 600;">Lessons Remaining</div>
                    </div>
                    <div>
                        <div style="font-size: 2.5em; font-weight: 800; margin-bottom: 5px;">${progressPercent}%</div>
                        <div style="font-size: 0.95em; opacity: 0.9; font-weight: 600;">Progress</div>
                    </div>
                </div>
                <div style="margin-top: 20px; background: rgba(255,255,255,0.2); height: 12px; border-radius: 6px; overflow: hidden;">
                    <div style="width: ${progressPercent}%; height: 100%; background: #10b981; transition: width 0.5s;"></div>
                </div>
            </div>`;

            // Legend
            html += `<div style="display: flex; gap: 20px; margin-bottom: 24px; flex-wrap: wrap; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 24px; height: 24px; background: #e5e7eb; border-radius: 4px; display: flex; align-items: center; justify-content: center;">✓</div>
                    <span style="font-weight: 600; color: #6b7280;">Taught (Past)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #F59E0B 0%, #F97316 100%); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white;">📍</div>
                    <span style="font-weight: 600; color: #F59E0B;">Today</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white;">📅</div>
                    <span style="font-weight: 600; color: #667eea;">Upcoming</span>
                </div>
            </div>`;

            // Render each subject group
            const sortedGroups = Object.values(subjectGroups).sort((a, b) => {
                if (a.period !== b.period) return a.period - b.period;
                return a.subject.localeCompare(b.subject);
            });

            sortedGroups.forEach(group => {
                const groupTaught = group.lessons.filter(l => l.status === 'taught').length;
                const groupTotal = group.lessons.length;
                const groupPercent = groupTotal > 0 ? Math.round((groupTaught / groupTotal) * 100) : 0;

                html += `<div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;

                // Subject Header
                const cpalmsUrl = getCPALMSUrl(group.subjectKey);
                const cpalmsLink = cpalmsUrl ? ` <a href="${cpalmsUrl}" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: none; font-size: 0.85em; margin-left: 8px; white-space: nowrap;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'" title="View Florida CPALMS Course Standards">📋 FL Standards</a>` : '';
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
                    <div>
                        <h3 style="margin: 0; font-size: 1.3em; color: #1f2937;">Period ${group.period} - ${group.subject}${cpalmsLink}</h3>
                        <p style="margin: 4px 0 0 0; color: #6b7280;">Grade ${group.grade}</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #667eea;">${groupPercent}%</div>
                        <div style="font-size: 0.9em; color: #6b7280;">${groupTaught}/${groupTotal} lessons</div>
                    </div>
                </div>`;

                // Lessons Timeline
                html += '<div style="position: relative;">';

                group.lessons.forEach((l, index) => {
                    const isLast = index === group.lessons.length - 1;

                    // Status styling
                    let bgColor, borderColor, textColor, icon;
                    if (l.status === 'taught') {
                        bgColor = '#f9fafb';
                        borderColor = '#e5e7eb';
                        textColor = '#6b7280';
                        icon = '✓';
                    } else if (l.status === 'today') {
                        bgColor = 'linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%)';
                        borderColor = '#F59E0B';
                        textColor = '#92400e';
                        icon = '📍';
                    } else {
                        bgColor = 'linear-gradient(135deg, #EDE9FE 0%, #DDD6FE 100%)';
                        borderColor = '#8B5CF6';
                        textColor = '#5B21B6';
                        icon = '📅';
                    }

                    html += `<div style="position: relative; padding-left: 40px; padding-bottom: ${isLast ? '0' : '24px'};">`;

                    // Timeline connector
                    if (!isLast) {
                        html += `<div style="position: absolute; left: 11px; top: 32px; bottom: 0; width: 2px; background: #e5e7eb;"></div>`;
                    }

                    // Timeline dot
                    html += `<div style="position: absolute; left: 0; top: 8px; width: 24px; height: 24px; background: ${typeof bgColor === 'string' && bgColor.startsWith('linear') ? bgColor : borderColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8em; font-weight: 700; z-index: 1;">${icon}</div>`;

                    // Lesson card
                    html += `<div onclick="openDayModal('${l.dateStr}', '${l.dayType}', ${l.dayNum})" style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">`;

                    // Lesson info
                    const dateFormatted = l.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 700; color: ${textColor}; font-size: 1.1em;">${l.lesson.title || 'Lesson ' + l.lesson.code}</div>
                            <div style="font-size: 0.9em; color: ${textColor}; opacity: 0.8; margin-top: 4px;">Day ${l.dayNum}${l.dayType}</div>
                        </div>
                        <div style="text-align: right; color: ${textColor}; font-weight: 600;">
                            ${dateFormatted}
                        </div>
                    </div>`;

                    // Objectives
                    if (l.lesson.objectives && l.lesson.objectives.length > 0) {
                        const objectivesId = `objectives-${l.lesson.code.replace(/\./g, '-')}-${l.dateStr}`;
                        html += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid ${borderColor};">
                            <div style="font-weight: 600; color: ${textColor}; font-size: 0.9em; margin-bottom: 6px;">Learning Objectives:</div>
                            <ul id="${objectivesId}" style="margin: 0; padding-left: 20px; color: ${textColor}; font-size: 0.85em; line-height: 1.5;">`;
                        l.lesson.objectives.slice(0, 2).forEach(obj => {
                            html += `<li>${obj}</li>`;
                        });
                        if (l.lesson.objectives.length > 2) {
                            html += `<li style="opacity: 0.7; cursor: pointer; color: #3b82f6; text-decoration: underline;" onclick="event.stopPropagation(); toggleObjectives('${objectivesId}', ${JSON.stringify(l.lesson.objectives).replace(/"/g, '&quot;')}, '${textColor}', '${l.dateStr}', '${l.dayType}', ${l.dayNum})" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"><em>+${l.lesson.objectives.length - 2} more objectives... (click to expand)</em></li>`;
                        }
                        html += `</ul></div>`;
                    }

                    html += `</div>`; // Close lesson card
                    html += `</div>`; // Close timeline item
                });

                html += '</div>'; // Close timeline
                html += '</div>'; // Close subject group
            });

            if (sortedGroups.length === 0) {
                html += `<div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                    <div style="font-size: 3em; margin-bottom: 16px;">📚</div>
                    <h3 style="margin: 0 0 8px 0;">No Lessons Found</h3>
                    <p>Try adjusting your filters to see lessons.</p>
                </div>`;
            }

            html += '</div></div>';
            grid.innerHTML = html;
        }

        async function renderAssignmentsView() {
            const grid = document.getElementById('calendarGrid');

            // Show loading state
            grid.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                    <div style="font-size: 3em; margin-bottom: 16px;">⏳</div>
                    <h3 style="margin: 0;">Loading Assignments...</h3>
                </div>
            `;

            try {
                // Fetch all assignments (both assigned and submitted)
                const { data: assignments, error } = await supabase
                    .from('student_assignments')
                    .select(`
                        *,
                        students:student_id (
                            first_name,
                            last_name,
                            email,
                            grade_level
                        )
                    `)
                    .order('due_date', { ascending: false });

                if (error) throw error;

                // Build assignment management interface
                let html = `
                    <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <div>
                                <h2 style="margin: 0; font-size: 2em; color: #1f2937;">📚 Assignment Management</h2>
                                <p style="margin: 8px 0 0 0; color: #6b7280;">Manage all student assignments</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="filterAssignments('all')" class="filter-btn" data-filter="all" style="padding: 10px 20px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    All (${assignments.length})
                                </button>
                                <button onclick="filterAssignments('assigned')" class="filter-btn" data-filter="assigned" style="padding: 10px 20px; border: 2px solid #e5e7eb; background: white; color: #374151; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Assigned (${assignments.filter(a => a.status === 'assigned').length})
                                </button>
                                <button onclick="filterAssignments('submitted')" class="filter-btn" data-filter="submitted" style="padding: 10px 20px; border: 2px solid #e5e7eb; background: white; color: #374151; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Submitted (${assignments.filter(a => a.status === 'submitted').length})
                                </button>
                                <button onclick="filterAssignments('graded')" class="filter-btn" data-filter="graded" style="padding: 10px 20px; border: 2px solid #e5e7eb; background: white; color: #374151; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Graded (${assignments.filter(a => a.status === 'graded').length})
                                </button>
                            </div>
                        </div>
                `;

                if (assignments && assignments.length > 0) {
                    html += '<div id="assignmentsContainer" style="display: grid; gap: 15px;">';

                    assignments.forEach(assignment => {
                        const student = assignment.students;
                        const statusColors = {
                            'assigned': '#6366f1',
                            'submitted': '#f59e0b',
                            'graded': '#10b981',
                            'overdue': '#ef4444'
                        };
                        const statusColor = statusColors[assignment.status] || '#6b7280';
                        const dueDate = new Date(assignment.due_date).toLocaleDateString();
                        const assignedDate = new Date(assignment.assigned_at).toLocaleDateString();

                        html += `
                            <div class="assignment-card" data-status="${assignment.status}" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.2s;">
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                            <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; text-transform: uppercase;">
                                                ${assignment.status}
                                            </span>
                                            <h3 style="margin: 0; font-size: 1.3em; color: #1f2937;">${assignment.assignment_title}</h3>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                                            <div style="color: #6b7280;">
                                                <strong>Student:</strong> ${student.first_name} ${student.last_name} (${student.email})
                                            </div>
                                            <div style="color: #6b7280;">
                                                <strong>Grade:</strong> ${student.grade_level}
                                            </div>
                                            <div style="color: #6b7280;">
                                                <strong>Subject:</strong> ${assignment.subject_key}
                                            </div>
                                            <div style="color: #6b7280;">
                                                <strong>Type:</strong> ${assignment.assignment_type || 'homework'}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 20px; color: #6b7280; font-size: 0.9em;">
                                            <div>📅 <strong>Assigned:</strong> ${assignedDate}</div>
                                            <div>⏰ <strong>Due:</strong> ${dueDate}</div>
                                            ${assignment.submitted_at ? `<div>✅ <strong>Submitted:</strong> ${new Date(assignment.submitted_at).toLocaleDateString()}</div>` : ''}
                                            ${assignment.points_possible ? `<div>🎯 <strong>Points:</strong> ${assignment.points_earned || 0}/${assignment.points_possible}</div>` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <button onclick="editAssignment('${assignment.id}')" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                            ✏️ Edit
                                        </button>
                                        <button onclick="deleteAssignment('${assignment.id}', '${assignment.assignment_title}')" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                            🗑️ Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                } else {
                    html += `
                        <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                            <div style="font-size: 3em; margin-bottom: 16px;">📚</div>
                            <h3 style="margin: 0 0 8px 0;">No Assignments Found</h3>
                            <p>Create your first assignment to get started.</p>
                        </div>
                    `;
                }

                html += '</div>';
                grid.innerHTML = html;

            } catch (error) {
                console.error('Error loading assignments:', error);
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #ef4444;">
                        <div style="font-size: 3em; margin-bottom: 16px;">⚠️</div>
                        <h3 style="margin: 0 0 8px 0;">Error Loading Assignments</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Filter assignments by status
        window.filterAssignments = function(status) {
            const cards = document.querySelectorAll('.assignment-card');
            const filterBtns = document.querySelectorAll('.filter-btn');

            // Update button styles
            filterBtns.forEach(btn => {
                if (btn.dataset.filter === status) {
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#667eea';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#374151';
                    btn.style.borderColor = '#e5e7eb';
                }
            });

            // Filter cards
            cards.forEach(card => {
                if (status === 'all' || card.dataset.status === status) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        };

        // Edit assignment
        window.editAssignment = async function(assignmentId) {
            try {
                // Fetch assignment details
                const { data: assignment, error } = await supabase
                    .from('student_assignments')
                    .select(`
                        *,
                        students:student_id (
                            first_name,
                            last_name,
                            email
                        )
                    `)
                    .eq('id', assignmentId)
                    .single();

                if (error) throw error;

                const modal = document.getElementById('editModal');
                const modalBody = document.getElementById('editModalBody');

                // Format dates for input fields
                const dueDate = new Date(assignment.due_date).toISOString().split('T')[0];

                modalBody.innerHTML = `
                    <h2 style="margin: 0 0 20px 0;">✏️ Edit Assignment</h2>
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Student:</strong> ${assignment.students.first_name} ${assignment.students.last_name} (${assignment.students.email})
                    </div>
                    <form id="editAssignmentForm" style="display: grid; gap: 20px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Assignment Title:</label>
                            <input type="text" id="editTitle" value="${assignment.assignment_title}" required
                                   style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Due Date:</label>
                            <input type="date" id="editDueDate" value="${dueDate}" required
                                   style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Points Possible:</label>
                            <input type="number" id="editPoints" value="${assignment.points_possible || 100}" min="0" required
                                   style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Assignment Type:</label>
                            <select id="editType" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                <option value="homework" ${assignment.assignment_type === 'homework' ? 'selected' : ''}>Homework</option>
                                <option value="quiz" ${assignment.assignment_type === 'quiz' ? 'selected' : ''}>Quiz</option>
                                <option value="test" ${assignment.assignment_type === 'test' ? 'selected' : ''}>Test</option>
                                <option value="project" ${assignment.assignment_type === 'project' ? 'selected' : ''}>Project</option>
                                <option value="essay" ${assignment.assignment_type === 'essay' ? 'selected' : ''}>Essay</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                            <button type="button" onclick="closeEditModal()" class="btn-save secondary" style="background: #6c757d;">Cancel</button>
                            <button type="submit" class="btn-save">💾 Save Changes</button>
                        </div>
                    </form>
                `;

                modal.classList.add('active');

                // Handle form submission
                document.getElementById('editAssignmentForm').onsubmit = async (e) => {
                    e.preventDefault();

                    try {
                        const { error: updateError } = await supabase
                            .from('student_assignments')
                            .update({
                                assignment_title: document.getElementById('editTitle').value,
                                due_date: document.getElementById('editDueDate').value,
                                points_possible: parseInt(document.getElementById('editPoints').value),
                                assignment_type: document.getElementById('editType').value,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', assignmentId);

                        if (updateError) throw updateError;

                        alert('✅ Assignment updated successfully!');
                        closeEditModal();
                        renderAssignmentsView();
                    } catch (error) {
                        alert('❌ Error updating assignment: ' + error.message);
                    }
                };

            } catch (error) {
                alert('❌ Error loading assignment: ' + error.message);
            }
        };

        // Delete assignment
        window.deleteAssignment = async function(assignmentId, assignmentTitle) {
            const confirmed = confirm(
                `⚠️ Delete Assignment?\n\n` +
                `Are you sure you want to delete "${assignmentTitle}"?\n\n` +
                `This action cannot be undone.`
            );

            if (!confirmed) return;

            try {
                const { error } = await supabase
                    .from('student_assignments')
                    .delete()
                    .eq('id', assignmentId);

                if (error) throw error;

                alert('✅ Assignment deleted successfully!');
                renderAssignmentsView();
            } catch (error) {
                alert('❌ Error deleting assignment: ' + error.message);
            }
        };

        window.toggleObjectives = function(objectivesId, allObjectives, textColor, dateStr, dayType, dayNum) {
            const ul = document.getElementById(objectivesId);
            if (!ul) return;

            // Clear current content
            ul.innerHTML = '';

            // Show all objectives
            allObjectives.forEach(obj => {
                ul.innerHTML += `<li>${obj}</li>`;
            });

            // Add "View Full Lesson" link
            ul.innerHTML += `<li style="margin-top: 8px; list-style: none; margin-left: -20px;">
                <a href="javascript:void(0)"
                   onclick="event.stopPropagation(); openDayModal('${dateStr}', '${dayType}', ${dayNum})"
                   style="color: #3b82f6; text-decoration: underline; cursor: pointer; font-weight: 600; font-size: 0.95em;"
                   onmouseover="this.style.color='#2563eb'"
                   onmouseout="this.style.color='#3b82f6'">
                   📖 View Full Lesson Details
                </a>
            </li>`;
        };

        function logout() {
            window.location.href = 'index.html';
        }

        // Teacher tool functions (placeholders)
        function openCreateAssignment() {
            alert('📝 Create Assignment feature - Coming soon!\nThis will allow you to create new assignments for your classes.');
        }

        function openGradeSubmissions() {
            alert('✅ Grade Submissions feature - Coming soon!\nThis will show all pending student submissions for grading.');
        }

        function openAttendance() {
            const modal = document.getElementById('editModal');
            const modalBody = document.getElementById('editModalBody');

            // Get today's date as default
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];

            let html = `
                <h2>📋 Attendance Management</h2>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #495057;">
                                📅 Select Date:
                            </label>
                            <input type="date" id="attendanceDate" value="${dateStr}"
                                   onchange="updateAttendanceView()"
                                   style="width: 100%; padding: 8px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 1em;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #495057;">
                                ⏰ Select Period:
                            </label>
                            <select id="attendancePeriod" onchange="updateAttendanceView()"
                                    style="width: 100%; padding: 8px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 1em;">
                                <option value="all">All Periods</option>
                                <option value="1">Period 1 (8:15-9:45)</option>
                                <option value="2">Period 2 (9:51-11:21)</option>
                                <option value="3">Period 3 (12:12-1:42)</option>
                                <option value="4">Period 4 (1:42-3:15)</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn-save" onclick="viewAttendanceHistory()"
                                    style="background: #6c757d; white-space: nowrap;">
                                📊 View History
                            </button>
                        </div>
                    </div>
                </div>
                <div id="attendanceDisplay" style="min-height: 200px;">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">
                        Select a date and period to view/take attendance
                    </p>
                </div>
                <div id="attendanceActions" style="margin-top: 30px; text-align: center; display: none;">
                    <button class="btn-save" onclick="saveAttendance()">💾 Save Attendance</button>
                    <button class="btn-save secondary" onclick="closeEditModal()" style="background: #6c757d; margin-left: 10px;">Cancel</button>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.add('active');

            // Auto-load current period attendance
            updateAttendanceView();
        }

        async function updateAttendanceView() {
            const dateInput = document.getElementById('attendanceDate');
            const periodSelect = document.getElementById('attendancePeriod');
            const displayDiv = document.getElementById('attendanceDisplay');
            const actionsDiv = document.getElementById('attendanceActions');

            if (!dateInput || !periodSelect) return;

            const dateStr = dateInput.value;
            const selectedPeriod = periodSelect.value;
            const dayType = getABDay(dateStr);

            if (!dayType) {
                displayDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                        <p style="font-size: 2em; margin-bottom: 10px;">🏖️</p>
                        <p style="color: #856404; font-weight: 600;">No school on this date</p>
                        <p style="color: #856404; margin-top: 10px;">Please select a school day to take attendance.</p>
                    </div>
                `;
                actionsDiv.style.display = 'none';
                return;
            }

            const date = new Date(dateStr + 'T12:00:00');
            const dayNum = getDayNumber(dateStr, dayType);
            const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <h3 style="margin: 0; font-size: 1.1em;">${dateFormatted}</h3>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">Day ${dayNum} - ${dayType} Day</p>
                </div>
            `;

            const periods = selectedPeriod === 'all' ? [1, 2, 3, 4] : [parseInt(selectedPeriod)];
            let totalStudents = 0;

            for (const period of periods) {
                const subjectsByGrade = {
                    7: periodStructure[dayType]?.[period]?.[7],
                    9: periodStructure[dayType]?.[period]?.[9],
                    11: periodStructure[dayType]?.[period]?.[11]
                };

                let hasStudents = false;
                let periodHtml = `
                    <div class="attendance-period" style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #495057; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-bottom: 15px;">
                            📚 Period ${period}
                        </h3>
                `;

                for (const [grade, subj] of Object.entries(subjectsByGrade)) {
                    if (subj) {
                        const students = getStudentsByPeriod(period, dayType, subj.key);
                        if (students && students.length > 0) {
                            hasStudents = true;
                            totalStudents += students.length;

                            // Load saved attendance if exists
                            const savedAttendance = await loadSavedAttendance(dateStr, period);

                            periodHtml += `
                                <div class="attendance-class" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                    <h4 style="color: ${subj.color}; margin: 0 0 15px 0; font-size: 1.1em;">
                                        Grade ${grade}: ${subj.subject} <span style="color: #6c757d; font-weight: normal; font-size: 0.9em;">(${students.length} students)</span>
                                    </h4>
                                    <div class="student-list" style="display: grid; gap: 10px;">
                            `;

                            students.forEach(student => {
                                const savedData = savedAttendance[student.id] || { status: 'present', participation: 3, effort: 3 };
                                const savedStatus = savedData.status || 'present';
                                const savedParticipation = savedData.participation !== undefined ? savedData.participation : 3;
                                const savedEffort = savedData.effort !== undefined ? savedData.effort : 3;

                                periodHtml += `
                                    <div class="student-attendance-row" data-period="${period}" data-student-id="${student.id}" style="display: grid; grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr; gap: 15px; align-items: center; background: white; padding: 15px; border-radius: 6px; border: 2px solid #e9ecef;">
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                                            <input type="checkbox" class="attendance-check" data-student="${student.id}" ${savedStatus === 'present' ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                            <div style="display: flex; flex-direction: column;">
                                                <span style="font-weight: 600; color: #212529;">${student.firstName} ${student.lastName || ''}</span>
                                                <span style="color: #6c757d; font-size: 0.75em;">${student.email}</span>
                                            </div>
                                        </label>
                                        <select class="attendance-status" data-student="${student.id}" style="padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.9em;">
                                            <option value="present" ${savedStatus === 'present' ? 'selected' : ''}>✅ Present</option>
                                            <option value="absent" ${savedStatus === 'absent' ? 'selected' : ''}>❌ Absent</option>
                                            <option value="tardy" ${savedStatus === 'tardy' ? 'selected' : ''}>🕐 Tardy</option>
                                            <option value="excused" ${savedStatus === 'excused' ? 'selected' : ''}>📝 Excused</option>
                                        </select>
                                        <div class="grade-slider-container">
                                            <div class="grade-slider-label">
                                                <span>🎯 Participation</span>
                                                <span class="grade-value participation" id="participation-value-${student.id}">${savedParticipation}</span>
                                            </div>
                                            <input type="range" min="0" max="5" value="${savedParticipation}"
                                                   class="grade-slider participation"
                                                   data-student="${student.id}"
                                                   data-grade-type="participation"
                                                   oninput="updateGradeValue(this, 'participation-value-${student.id}')">
                                        </div>
                                        <div class="grade-slider-container">
                                            <div class="grade-slider-label">
                                                <span>💪 Effort</span>
                                                <span class="grade-value effort" id="effort-value-${student.id}">${savedEffort}</span>
                                            </div>
                                            <input type="range" min="0" max="5" value="${savedEffort}"
                                                   class="grade-slider effort"
                                                   data-student="${student.id}"
                                                   data-grade-type="effort"
                                                   oninput="updateGradeValue(this, 'effort-value-${student.id}')">
                                        </div>
                                    </div>
                                `;
                            });

                            periodHtml += `</div></div>`;
                        }
                    }
                }

                periodHtml += `</div>`;
                if (hasStudents) html += periodHtml;
            }

            if (totalStudents === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                        <p style="font-size: 2em; margin-bottom: 10px;">📭</p>
                        <p style="color: #6c757d; font-weight: 600;">No classes scheduled for this period</p>
                    </div>
                `;
                actionsDiv.style.display = 'none';
            } else {
                html += `
                    <div style="text-align: center; padding: 15px; background: #e7f5ff; border-radius: 8px; margin-top: 20px;">
                        <p style="color: #1971c2; font-weight: 600; margin: 0;">
                            Total Students: ${totalStudents}
                        </p>
                    </div>
                `;
                actionsDiv.style.display = 'block';
            }

            displayDiv.innerHTML = html;
        }

        async function loadSavedAttendance(date, period) {
            try {
                // Try to load from Supabase first
                const { data, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .eq('date', date)
                    .eq('period', period);

                if (!error && data && data.length > 0) {
                    const periodRecords = {};
                    data.forEach(record => {
                        periodRecords[record.student_id] = {
                            status: record.status || 'present',
                            participation: record.participation_grade !== undefined ? record.participation_grade : 3,
                            effort: record.effort_grade !== undefined ? record.effort_grade : 3
                        };
                    });
                    return periodRecords;
                }
            } catch (err) {
                console.error('Error loading from Supabase, falling back to localStorage:', err);
            }

            // Fallback to localStorage
            const attendanceData = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
            const records = attendanceData[date] || [];
            const periodRecords = {};

            records.forEach(record => {
                if (record.period == period) {
                    periodRecords[record.studentId] = {
                        status: record.status || 'present',
                        participation: record.participation !== undefined ? record.participation : 3,
                        effort: record.effort !== undefined ? record.effort : 3
                    };
                }
            });

            return periodRecords;
        }

        // Update grade value display when slider moves
        function updateGradeValue(slider, valueElementId) {
            const valueElement = document.getElementById(valueElementId);
            if (valueElement) {
                valueElement.textContent = slider.value;
            }
        }

        async function saveAttendance() {
            const currentDate = document.getElementById('attendanceDate').value;
            const currentUser = supabase.auth.getUser();
            const teacherEmail = currentUser?.data?.user?.email || 'unknown';

            const records = [];
            document.querySelectorAll('.student-attendance-row').forEach(row => {
                const checkbox = row.querySelector('.attendance-check');
                const select = row.querySelector('.attendance-status');
                const participationSlider = row.querySelector('.grade-slider.participation');
                const effortSlider = row.querySelector('.grade-slider.effort');

                const studentId = checkbox.dataset.student;
                const period = row.dataset.period;
                const status = select.value;
                const participation = parseInt(participationSlider.value);
                const effort = parseInt(effortSlider.value);

                records.push({
                    student_id: studentId,
                    date: currentDate,
                    period: parseInt(period),
                    status,
                    participation_grade: participation,
                    effort_grade: effort,
                    teacher_email: teacherEmail
                });
            });

            try {
                // Save to Supabase (upsert handles insert or update)
                const { data, error } = await supabase
                    .from('attendance')
                    .upsert(records, {
                        onConflict: 'student_id,date,period'
                    });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                console.log('✅ Attendance saved to Supabase:', records.length, 'records');

                // Also save to localStorage as backup
                const attendanceData = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
                if (!attendanceData[currentDate]) {
                    attendanceData[currentDate] = [];
                }

                records.forEach(newRecord => {
                    const existingIndex = attendanceData[currentDate].findIndex(
                        r => r.studentId === newRecord.student_id && r.period === newRecord.period
                    );

                    if (existingIndex >= 0) {
                        attendanceData[currentDate][existingIndex] = {
                            studentId: newRecord.student_id,
                            period: newRecord.period,
                            status: newRecord.status,
                            participation: newRecord.participation_grade,
                            effort: newRecord.effort_grade,
                            date: currentDate,
                            timestamp: new Date().toISOString()
                        };
                    } else {
                        attendanceData[currentDate].push({
                            studentId: newRecord.student_id,
                            period: newRecord.period,
                            status: newRecord.status,
                            participation: newRecord.participation_grade,
                            effort: newRecord.effort_grade,
                            date: currentDate,
                            timestamp: new Date().toISOString()
                        });
                    }
                });

                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceData));

                alert(`✅ Attendance saved for ${records.length} students on ${currentDate}!`);
                closeEditModal();
            } catch (err) {
                console.error('Failed to save attendance:', err);
                alert(`❌ Failed to save attendance: ${err.message}. Please try again.`);
            }
        }

        // Toggle attendance section in lesson edit modal
        function toggleAttendanceForLesson(dateStr, period, subjectKey) {
            const cleanSubjectKey = subjectKey.replace(/[^a-z0-9]/gi, '');
            const studentList = document.getElementById(`student-list-${period}-${cleanSubjectKey}`);
            const attendanceSection = document.getElementById(`attendance-section-${period}-${cleanSubjectKey}`);

            if (studentList && attendanceSection) {
                const isVisible = attendanceSection.style.display !== 'none';
                studentList.style.display = isVisible ? 'block' : 'none';
                attendanceSection.style.display = isVisible ? 'none' : 'block';
            }
        }

        // Save attendance from lesson edit modal
        async function saveLessonAttendance(dateStr, period) {
            const currentUser = await supabase.auth.getUser();
            const teacherEmail = currentUser?.data?.user?.email || 'unknown';

            const records = [];
            document.querySelectorAll('.student-attendance-row').forEach(row => {
                if (row.dataset.period == period) {
                    const checkbox = row.querySelector('.attendance-check');
                    const select = row.querySelector('.attendance-status');
                    const participationSlider = row.querySelector('.grade-slider.participation');
                    const effortSlider = row.querySelector('.grade-slider.effort');

                    const studentId = checkbox.dataset.student;
                    const status = select.value;
                    const participation = parseInt(participationSlider.value);
                    const effort = parseInt(effortSlider.value);

                    records.push({
                        student_id: studentId,
                        date: dateStr,
                        period: parseInt(period),
                        status,
                        participation_grade: participation,
                        effort_grade: effort,
                        teacher_email: teacherEmail
                    });
                }
            });

            try {
                // Save to Supabase (upsert handles insert or update)
                const { data, error } = await supabase
                    .from('attendance')
                    .upsert(records, {
                        onConflict: 'student_id,date,period'
                    });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                console.log('✅ Lesson attendance saved to Supabase:', records.length, 'records');

                // Also save to localStorage as backup
                const attendanceData = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
                if (!attendanceData[dateStr]) {
                    attendanceData[dateStr] = [];
                }

                records.forEach(newRecord => {
                    const existingIndex = attendanceData[dateStr].findIndex(
                        r => r.studentId === newRecord.student_id && r.period === newRecord.period
                    );

                    if (existingIndex >= 0) {
                        attendanceData[dateStr][existingIndex] = {
                            studentId: newRecord.student_id,
                            period: newRecord.period,
                            status: newRecord.status,
                            participation: newRecord.participation_grade,
                            effort: newRecord.effort_grade,
                            date: dateStr,
                            timestamp: new Date().toISOString()
                        };
                    } else {
                        attendanceData[dateStr].push({
                            studentId: newRecord.student_id,
                            period: newRecord.period,
                            status: newRecord.status,
                            participation: newRecord.participation_grade,
                            effort: newRecord.effort_grade,
                            date: dateStr,
                            timestamp: new Date().toISOString()
                        });
                    }
                });

                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceData));

                alert(`✅ Attendance saved for ${records.length} students!`);

                // Refresh the lesson view to show updated data
                location.reload();
            } catch (err) {
                console.error('Failed to save lesson attendance:', err);
                alert(`❌ Failed to save attendance: ${err.message}. Please try again.`);
            }
        }

        function viewAttendanceHistory() {
            const modal = document.getElementById('editModal');
            const modalBody = document.getElementById('editModalBody');

            const attendanceData = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
            const dates = Object.keys(attendanceData).sort().reverse();

            let html = `
                <h2>📊 Attendance History</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">View past attendance records and statistics</p>
            `;

            if (dates.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px; background: #f8f9fa; border-radius: 8px;">
                        <p style="font-size: 3em; margin-bottom: 15px;">📋</p>
                        <h3 style="color: #6c757d;">No Attendance Records Yet</h3>
                        <p style="color: #6c757d; margin-top: 10px;">Start taking attendance to see history here.</p>
                        <button class="btn-save" onclick="openAttendance()" style="margin-top: 20px;">
                            📋 Take Attendance Now
                        </button>
                    </div>
                `;
            } else {
                // Summary statistics
                let totalRecords = 0;
                let presentCount = 0;
                let absentCount = 0;
                let tardyCount = 0;
                let excusedCount = 0;

                dates.forEach(date => {
                    attendanceData[date].forEach(record => {
                        totalRecords++;
                        if (record.status === 'present') presentCount++;
                        else if (record.status === 'absent') absentCount++;
                        else if (record.status === 'tardy') tardyCount++;
                        else if (record.status === 'excused') excusedCount++;
                    });
                });

                const attendanceRate = totalRecords > 0 ? ((presentCount / totalRecords) * 100).toFixed(1) : 0;

                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 5px;">✅</div>
                            <div style="font-size: 2em; font-weight: bold;">${presentCount}</div>
                            <div style="opacity: 0.9; font-size: 0.9em;">Present</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 5px;">❌</div>
                            <div style="font-size: 2em; font-weight: bold;">${absentCount}</div>
                            <div style="opacity: 0.9; font-size: 0.9em;">Absent</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 5px;">🕐</div>
                            <div style="font-size: 2em; font-weight: bold;">${tardyCount}</div>
                            <div style="opacity: 0.9; font-size: 0.9em;">Tardy</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 5px;">📝</div>
                            <div style="font-size: 2em; font-weight: bold;">${excusedCount}</div>
                            <div style="opacity: 0.9; font-size: 0.9em;">Excused</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; grid-column: span 1;">
                            <div style="font-size: 2em; margin-bottom: 5px;">📈</div>
                            <div style="font-size: 2em; font-weight: bold;">${attendanceRate}%</div>
                            <div style="opacity: 0.9; font-size: 0.9em;">Attendance Rate</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #495057;">📅 Records by Date</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                `;

                dates.forEach(dateStr => {
                    const records = attendanceData[dateStr];
                    const date = new Date(dateStr + 'T12:00:00');
                    const dayType = getABDay(dateStr);
                    const dayNum = dayType ? getDayNumber(dateStr, dayType) : '?';
                    const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                    // Count by status
                    const statusCounts = { present: 0, absent: 0, tardy: 0, excused: 0 };
                    records.forEach(r => statusCounts[r.status]++);

                    html += `
                        <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h4 style="margin: 0; color: #212529;">${dateFormatted}</h4>
                                    <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9em;">Day ${dayNum} - ${dayType} Day • ${records.length} records</p>
                                </div>
                                <button class="btn-save" onclick="viewDateAttendance('${dateStr}')"
                                        style="background: #0ea5e9; padding: 8px 15px; font-size: 0.9em;">
                                    👁️ View Details
                                </button>
                            </div>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <span style="color: #10b981; font-weight: 600;">✅ ${statusCounts.present}</span>
                                <span style="color: #ef4444; font-weight: 600;">❌ ${statusCounts.absent}</span>
                                <span style="color: #f59e0b; font-weight: 600;">🕐 ${statusCounts.tardy}</span>
                                <span style="color: #8b5cf6; font-weight: 600;">📝 ${statusCounts.excused}</span>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            html += `
                <div style="margin-top: 30px; text-align: center; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <button class="btn-save" onclick="openAttendance()" style="margin-right: 10px;">
                        📋 Take Attendance
                    </button>
                    <button class="btn-save secondary" onclick="closeEditModal()" style="background: #6c757d;">
                        Close
                    </button>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        function viewDateAttendance(dateStr) {
            const modal = document.getElementById('editModal');
            const modalBody = document.getElementById('editModalBody');

            const attendanceData = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
            const records = attendanceData[dateStr] || [];

            const date = new Date(dateStr + 'T12:00:00');
            const dayType = getABDay(dateStr);
            const dayNum = getDayNumber(dateStr, dayType);
            const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                    <div>
                        <h2>📋 Attendance Details</h2>
                        <h3 style="color: #6c757d; margin-top: 5px;">${dateFormatted}</h3>
                        <p style="color: #6c757d;">Day ${dayNum} - ${dayType} Day</p>
                    </div>
                    <button class="btn-save" onclick="viewAttendanceHistory()" style="background: #6c757d;">
                        ← Back to History
                    </button>
                </div>
            `;

            // Group by period
            const periodGroups = {};
            records.forEach(record => {
                if (!periodGroups[record.period]) {
                    periodGroups[record.period] = [];
                }
                periodGroups[record.period].push(record);
            });

            Object.keys(periodGroups).sort().forEach(period => {
                const periodRecords = periodGroups[period];

                html += `
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #495057; margin-bottom: 15px;">📚 Period ${period}</h3>
                        <div style="display: grid; gap: 10px;">
                `;

                periodRecords.forEach(record => {
                    const student = getStudentInfo(record.studentId);
                    if (!student) return;

                    const statusColors = {
                        present: '#10b981',
                        absent: '#ef4444',
                        tardy: '#f59e0b',
                        excused: '#8b5cf6'
                    };

                    const statusIcons = {
                        present: '✅',
                        absent: '❌',
                        tardy: '🕐',
                        excused: '📝'
                    };

                    const statusLabels = {
                        present: 'Present',
                        absent: 'Absent',
                        tardy: 'Tardy',
                        excused: 'Excused'
                    };

                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid ${statusColors[record.status]};">
                            <div>
                                <span style="font-weight: 600; color: #212529;">${student.firstName}</span>
                                <span style="color: #6c757d; font-size: 0.9em; margin-left: 10px;">Grade ${student.grade}</span>
                            </div>
                            <span style="color: ${statusColors[record.status]}; font-weight: 600;">
                                ${statusIcons[record.status]} ${statusLabels[record.status]}
                            </span>
                        </div>
                    `;
                });

                html += `</div></div>`;
            });

            html += `
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn-save secondary" onclick="viewAttendanceHistory()" style="background: #6c757d;">
                        ← Back to History
                    </button>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        // New function to open attendance for any day
        function openDayAttendance(dateStr) {
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const dayType = getABDay(dateStr);
            const isNoSchool = schoolCalendar.noSchoolDays.has(dateStr);

            if (isNoSchool || isWeekend || !dayType) {
                alert('📋 No school on this day - attendance not available.');
                return;
            }

            const modal = document.getElementById('editModal');
            const modalBody = document.getElementById('editModalBody');

            const dayNum = getDayNumber(dateStr, dayType);
            const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Load existing attendance data
            const attendanceData = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
            const existingRecords = attendanceData[dateStr] || [];

            let html = `
                <h2>📋 Take Attendance - ${dateFormatted}</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Day ${dayNum} - ${dayType} Day</p>
                <input type="hidden" id="attendanceDate" value="${dateStr}">

                <!-- Filters -->
                <div class="attendance-filters">
                    <div class="filter-group">
                        <label>Filter by Period:</label>
                        <button class="filter-btn active" onclick="filterAttendancePeriod('all')">All</button>
                        <button class="filter-btn" onclick="filterAttendancePeriod('1')">P1</button>
                        <button class="filter-btn" onclick="filterAttendancePeriod('2')">P2</button>
                        <button class="filter-btn" onclick="filterAttendancePeriod('3')">P3</button>
                        <button class="filter-btn" onclick="filterAttendancePeriod('4')">P4</button>
                    </div>
                    <div class="filter-group">
                        <label>Filter by Status:</label>
                        <button class="filter-btn active" onclick="filterAttendanceStatus('all')">All</button>
                        <button class="filter-btn" onclick="filterAttendanceStatus('present')">✅ Present</button>
                        <button class="filter-btn" onclick="filterAttendanceStatus('absent')">❌ Absent</button>
                        <button class="filter-btn" onclick="filterAttendanceStatus('tardy')">🕐 Tardy</button>
                    </div>
                </div>

                <div id="attendanceSummary"></div>
                <div id="attendanceContent">
            `;

            const periods = [1, 2, 3, 4];
            let totalStudents = 0;
            let presentCount = 0;
            let absentCount = 0;
            let tardyCount = 0;

            periods.forEach(period => {
                const subjectsByGrade = {
                    7: periodStructure[dayType]?.[period]?.[7],
                    9: periodStructure[dayType]?.[period]?.[9],
                    11: periodStructure[dayType]?.[period]?.[11]
                };

                let hasStudents = false;
                let periodHtml = `<div class="attendance-period" data-period="${period}"><h3>Period ${period}</h3>`;

                Object.entries(subjectsByGrade).forEach(([grade, subj]) => {
                    if (subj) {
                        const students = getStudentsByPeriod(period, dayType, subj.key);
                        if (students && students.length > 0) {
                            hasStudents = true;
                            periodHtml += `
                                <div class="attendance-class" style="margin-bottom: 20px;">
                                    <h4 style="color: ${subj.color};">Grade ${grade}: ${subj.subject} (${students.length} students)</h4>
                                    <div class="student-list">
                            `;

                            students.forEach(student => {
                                totalStudents++;

                                // Check if there's existing attendance
                                const existingRecord = existingRecords.find(
                                    r => r.studentId === student.id && r.period === String(period)
                                );
                                const savedStatus = existingRecord ? existingRecord.status : 'present';

                                if (savedStatus === 'present') presentCount++;
                                else if (savedStatus === 'absent') absentCount++;
                                else if (savedStatus === 'tardy') tardyCount++;

                                periodHtml += `
                                    <div class="student-attendance-row" data-period="${period}" data-status="${savedStatus}">
                                        <label>
                                            <input type="checkbox" class="attendance-check" data-student="${student.id}" ${savedStatus === 'present' ? 'checked' : ''}>
                                            <span>${student.firstName} ${student.lastName || ''}</span>
                                        </label>
                                        <select class="attendance-status" data-student="${student.id}">
                                            <option value="present" ${savedStatus === 'present' ? 'selected' : ''}>✅ Present</option>
                                            <option value="absent" ${savedStatus === 'absent' ? 'selected' : ''}>❌ Absent</option>
                                            <option value="tardy" ${savedStatus === 'tardy' ? 'selected' : ''}>🕐 Tardy</option>
                                            <option value="excused" ${savedStatus === 'excused' ? 'selected' : ''}>📝 Excused</option>
                                        </select>
                                    </div>
                                `;
                            });

                            periodHtml += `</div></div>`;
                        }
                    }
                });

                periodHtml += `</div>`;
                if (hasStudents) html += periodHtml;
            });

            html += `
                </div>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn-save" onclick="saveAttendance()">💾 Save Attendance</button>
                    <button class="btn-save secondary" onclick="closeEditModal()" style="background: #6c757d; margin-left: 10px;">Cancel</button>
                </div>
            `;

            modalBody.innerHTML = html;

            // Add summary after rendering
            updateAttendanceSummary(totalStudents, presentCount, absentCount, tardyCount);

            modal.classList.add('active');
        }

        function updateAttendanceSummary(total, present, absent, tardy) {
            const summaryDiv = document.getElementById('attendanceSummary');
            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;

            summaryDiv.innerHTML = `
                <div class="attendance-summary">
                    <div class="summary-item">
                        <h4>${total}</h4>
                        <p>Total Students</p>
                    </div>
                    <div class="summary-item">
                        <h4>${present}</h4>
                        <p>Present</p>
                    </div>
                    <div class="summary-item">
                        <h4>${absent}</h4>
                        <p>Absent</p>
                    </div>
                    <div class="summary-item">
                        <h4>${tardy}</h4>
                        <p>Tardy</p>
                    </div>
                    <div class="summary-item">
                        <h4>${percentage}%</h4>
                        <p>Attendance Rate</p>
                    </div>
                </div>
            `;
        }

        function filterAttendancePeriod(period) {
            // Update button states
            document.querySelectorAll('.attendance-filters .filter-btn').forEach(btn => {
                if (btn.textContent.includes('P') || btn.textContent === 'All') {
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');

            // Show/hide periods
            document.querySelectorAll('.attendance-period').forEach(periodDiv => {
                if (period === 'all' || periodDiv.dataset.period === period) {
                    periodDiv.style.display = 'block';
                } else {
                    periodDiv.style.display = 'none';
                }
            });
        }

        function filterAttendanceStatus(status) {
            // Update button states
            document.querySelectorAll('.attendance-filters .filter-btn').forEach(btn => {
                if (btn.textContent.includes('✅') || btn.textContent.includes('❌') || btn.textContent.includes('🕐') || (btn.textContent === 'All' && btn.parentElement.querySelector('label').textContent.includes('Status'))) {
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');

            // Show/hide students based on status
            document.querySelectorAll('.student-attendance-row').forEach(row => {
                const rowStatus = row.dataset.status || 'present';
                if (status === 'all' || rowStatus === status) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });

            // Update status when select changes
            document.querySelectorAll('.attendance-status').forEach(select => {
                select.addEventListener('change', function() {
                    const row = this.closest('.student-attendance-row');
                    row.dataset.status = this.value;
                });
            });
        }

        function openAnnouncements() {
            alert('📢 Announcements feature - Coming soon!\nPost announcements to your classes or school-wide.');
        }

        function openRoster() {
            const modal = document.getElementById('editModal');
            const modalBody = document.getElementById('editModalBody');

            let html = `
                <h2>👥 Class Roster - All Students</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">Total Students: ${Object.keys(studentRoster.students).length}</p>
            `;

            const periods = [1, 2, 3, 4];
            const dayTypes = ['A', 'B'];

            const subjectColors = {
                'ela': '#8B5CF6',
                'math': '#10B981',
                'science': '#F59E0B',
                'history': '#EF4444',
                'world_history': '#EF4444',
                'civics': '#3B82F6',
                'us_gvmnt': '#3B82F6'
            };

            periods.forEach(period => {
                html += `<div class="roster-period"><h3>📚 Period ${period}</h3>`;

                dayTypes.forEach(dayType => {
                    html += `<div class="roster-day-type"><h4>${dayType} Days</h4>`;

                    const periodKey = `period${period}`;
                    const periodData = studentRoster[periodKey]?.[dayType];
                    let hasStudents = false;

                    if (periodData && Object.keys(periodData).length > 0) {
                        Object.entries(periodData).forEach(([subjectKey, studentIds]) => {
                            if (studentIds && studentIds.length > 0) {
                                hasStudents = true;
                                const students = studentIds.map(id => studentRoster.students[id]).filter(s => s);

                                // Get subject display name
                                const subjectParts = subjectKey.split('_');
                                const grade = subjectParts[0];
                                const subjectType = subjectParts.slice(1).join('_');

                                const subjectNames = {
                                    'ela': 'English Language Arts',
                                    'math': 'Math',
                                    'science': 'Life Science',
                                    'world_history': 'World History',
                                    'civics': 'Civics',
                                    'us_gvmnt': 'U.S. Government'
                                };

                                const subjectColor = subjectColors[subjectType] || '#6c757d';
                                const subjectName = subjectNames[subjectType] || subjectKey;

                                html += `
                                    <div class="roster-class" style="margin-bottom: 15px;">
                                        <h5 style="color: ${subjectColor};">Grade ${grade}: ${subjectName} (${students.length} students)</h5>
                                        <ul style="margin: 5px 0; padding-left: 20px;">
                                `;

                                students.forEach(student => {
                                    html += `<li>${student.firstName} (Grade ${student.grade}) - ${student.email}</li>`;
                                });

                                html += `</ul></div>`;
                            }
                        });
                    }

                    if (!hasStudents) {
                        html += `<p style="color: #6c757d; font-style: italic;">No students scheduled</p>`;
                    }

                    html += `</div>`;
                });

                html += `</div>`;
            });

            html += `
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn-save secondary" onclick="closeEditModal()">Close</button>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        function openReports() {
            alert('📊 Reports feature - Coming soon!\nView grade reports, attendance stats, and analytics.');
        }

        // ======================================
        // DRAG AND DROP FUNCTIONALITY
        // ======================================

        let draggedElement = null;
        let draggedData = null;

        function handleDragStart(event) {
            draggedElement = event.currentTarget;
            draggedData = {
                subjectKey: draggedElement.dataset.subjectKey,
                dayKey: draggedElement.dataset.dayKey,
                date: draggedElement.dataset.date,
                period: draggedElement.dataset.period,
                grade: draggedElement.dataset.grade,
                lessonCode: draggedElement.dataset.lessonCode
            };

            // Visual feedback
            draggedElement.style.opacity = '0.4';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', draggedElement.innerHTML);

            console.log('Dragging lesson:', draggedData);
        }

        function handleDragEnd(event) {
            if (draggedElement) {
                draggedElement.style.opacity = '1';
            }

            // Remove all drop zone highlights
            document.querySelectorAll('.calendar-day.drag-over').forEach(cell => {
                cell.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            event.preventDefault(); // Necessary to allow drop
            event.dataTransfer.dropEffect = 'move';

            const cell = event.currentTarget;
            if (!cell.classList.contains('drag-over')) {
                cell.classList.add('drag-over');
            }

            return false;
        }

        function handleDragLeave(event) {
            const cell = event.currentTarget;
            cell.classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.stopPropagation();
            event.preventDefault();

            const dropCell = event.currentTarget;
            dropCell.classList.remove('drag-over');

            if (!draggedData) {
                console.error('No dragged data available');
                return;
            }

            const targetDate = dropCell.dataset.date;
            const targetDayType = dropCell.dataset.dayType;
            const targetDayNum = dropCell.dataset.dayNum;

            if (!targetDate || !targetDayType || !targetDayNum) {
                alert('⚠️ Cannot drop lesson here - not a valid school day');
                return;
            }

            // Prevent dropping on the same day
            if (targetDate === draggedData.date) {
                console.log('Dropped on the same day - no action needed');
                return;
            }

            const confirmMessage = `📚 Move Lesson?\n\n` +
                `Lesson: ${draggedData.lessonCode}\n` +
                `Subject: ${draggedData.subjectKey}\n` +
                `Period: ${draggedData.period}\n` +
                `Grade: ${draggedData.grade}\n\n` +
                `FROM: ${new Date(draggedData.date).toLocaleDateString()}\n` +
                `TO: ${new Date(targetDate).toLocaleDateString()} (Day ${targetDayNum} - ${targetDayType})\n\n` +
                `This will update the curriculum data.\nContinue?`;

            if (confirm(confirmMessage)) {
                moveLessonToNewDay(draggedData, targetDate, targetDayType, targetDayNum);
            }

            draggedElement = null;
            draggedData = null;
        }

        // Student View Mode functions
        let studentViewMode = null; // Stores student data when in student view

        async function toggleViewAsStudent() {
            // Fetch students from Supabase
            const { data: students, error } = await supabase
                .from('centner_students')
                .select('*')
                .eq('is_active', true)
                .order('grade_level', { ascending: true })
                .order('last_name', { ascending: true });

            if (error || !students || students.length === 0) {
                alert('❌ No students found in database');
                return;
            }

            // Create student selection HTML
            const studentsHTML = students.map(s => {
                const fullName = `${s.first_name || ''} ${s.last_name || ''}`.trim() || s.email;
                return `<div style="padding: 12px; margin: 8px 0; background: #f8fafc; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='#6366f1'; this.style.background='#eef2ff'"
                            onmouseout="this.style.borderColor='transparent'; this.style.background='#f8fafc'"
                            onclick="selectStudent(${s.id})">
                        <div style="font-weight: 600; color: #1e293b;">${fullName}</div>
                        <div style="font-size: 0.85em; color: #64748b;">${s.grade_level} • ${s.email}</div>
                    </div>`;
            }).join('');

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'studentSelectModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 10000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px);';

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.35);">
                    <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 24px 30px; color: white; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.4em; font-weight: 700;">👁️ Select Student</h3>
                            <p style="margin: 8px 0 0 0; opacity: 0.95; font-size: 0.95em;">Choose a student to view their calendar</p>
                        </div>
                        <button onclick="this.closest('#studentSelectModal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; font-size: 1.6em; width: 44px; height: 44px; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
                    </div>
                    <div style="padding: 30px; overflow-y: auto; max-height: calc(80vh - 140px);">
                        ${studentsHTML}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Store students data for selection
            window.tempStudentsList = students;
        }

        async function selectStudent(studentId) {
            const student = window.tempStudentsList.find(s => s.id === studentId);
            if (!student) return;

            // Fetch student subjects
            const { data: subjectsData, error } = await supabase
                .from('student_subjects')
                .select('*')
                .eq('student_id', studentId);

            if (error) {
                alert('❌ Error loading student subjects');
                return;
            }

            // Subject name to key mapping
            const getSubjectKey = (subjectName) => {
                const mapping = {
                    '7th Life Science': '7th_science',
                    '7th Pre-Algebra': '7th_math',
                    '7th English Language Arts': '7th_ela',
                    '7th Civics/History': '7th_civics',
                    '9th English Language Arts': '9th_ela',
                    '9th World History': '9th_world_history',
                    '9th Geometry': '9th_math',
                    '11th Pre-Calculus': '11th_math',
                    '11th American Literature': '11th_ela',
                    '11th U.S. Government': '11th_us_gvmnt'
                };
                return mapping[subjectName] || null;
            };

            // Helper to get subject keys for a specific period and track
            const getSubjectsForPeriodTrack = (period, track) => {
                if (!subjectsData) return [];
                return subjectsData
                    .filter(s => s.period_number === period && s.track === track)
                    .map(s => getSubjectKey(s.subject_name))
                    .filter(key => key !== null);
            };

            // Set student view mode with subject enrollments
            studentViewMode = {
                student_id: student.id,
                full_name: `${student.first_name || ''} ${student.last_name || ''}`.trim() || student.email,
                email: student.email,
                grade_level: student.grade_level?.replace('th', ''),
                period_1_a_day: getSubjectsForPeriodTrack(1, 'A'),
                period_1_b_day: getSubjectsForPeriodTrack(1, 'B'),
                period_2_a_day: getSubjectsForPeriodTrack(2, 'A'),
                period_2_b_day: getSubjectsForPeriodTrack(2, 'B'),
                period_3_a_day: getSubjectsForPeriodTrack(3, 'A'),
                period_3_b_day: getSubjectsForPeriodTrack(3, 'B'),
                period_4_a_day: getSubjectsForPeriodTrack(4, 'A'),
                period_4_b_day: getSubjectsForPeriodTrack(4, 'B')
            };

            // Close modal
            document.getElementById('studentSelectModal')?.remove();

            // Show student view banner
            document.getElementById('studentViewBanner').style.display = 'flex';
            document.getElementById('studentViewName').textContent = studentViewMode.full_name;

            // Refresh view
            renderView();
        }

        function exitStudentView() {
            studentViewMode = null;
            document.getElementById('studentViewBanner').style.display = 'none';
            renderView();
        }

        function isStudentEnrolledInLesson(subjectKey, period, dayType) {
            if (!studentViewMode) return true; // Teacher view - show everything

            // Check if student has this subject in this period and day type
            const periodKey = `period_${period}_${dayType.toLowerCase()}_day`;
            const subjects = studentViewMode[periodKey] || [];

            return subjects.includes(subjectKey);
        }

        // Lesson schedule override functions (database-backed)
        let lessonOverrides = []; // Cache of overrides from database

        async function loadLessonOverrides() {
            try {
                const { data, error } = await supabase
                    .from('lesson_schedule_overrides')
                    .select('*')
                    .eq('is_active', true);

                if (error) {
                    console.error('Error loading lesson overrides:', error);
                    return;
                }

                lessonOverrides = data || [];
                console.log(`📚 Loaded ${lessonOverrides.length} lesson override(s) from database`);
            } catch (error) {
                console.error('Failed to load lesson overrides:', error);
            }
        }

        function getLessonsForDay(subjectKey, dayKey, period, grade, date) {
            // Get original curriculum lesson
            const curriculumMap = window.curriculumMap || window.curriculumData?.curriculumMap;
            const subject = curriculumMap?.[subjectKey];
            const originalLesson = subject?.lessons?.[dayKey];

            const lessons = [];

            // Add original lesson if it exists and hasn't been moved away
            if (originalLesson) {
                // Check if this lesson was moved away from this day
                const movedAway = lessonOverrides.some(override =>
                    override.subject_key === subjectKey &&
                    override.lesson_code === originalLesson.code &&
                    override.original_day_key === dayKey &&
                    override.scheduled_date !== date
                );

                if (!movedAway) {
                    lessons.push({
                        ...originalLesson,
                        isOriginal: true
                    });
                }
            }

            // Add any overrides scheduled for this day
            const overridesForDay = lessonOverrides.filter(override =>
                override.subject_key === subjectKey &&
                override.scheduled_date === date &&
                override.period_number === period &&
                override.grade_level === grade.toString()
            );

            overridesForDay.forEach(override => {
                // Get lesson details from curriculum
                const lessonData = findLessonByCode(subjectKey, override.lesson_code);
                if (lessonData) {
                    lessons.push({
                        ...lessonData,
                        isOverride: true,
                        overrideId: override.id
                    });
                }
            });

            return lessons;
        }

        function findLessonByCode(subjectKey, lessonCode) {
            const curriculumMap = window.curriculumMap || window.curriculumData?.curriculumMap;
            const subject = curriculumMap?.[subjectKey];
            if (!subject?.lessons) return null;

            // Search all day keys for this lesson code
            for (const [dayKey, lesson] of Object.entries(subject.lessons)) {
                if (lesson.code === lessonCode) {
                    return lesson;
                }
            }
            return null;
        }

        async function saveLessonToDate(lessonData, targetDate, targetDayType, targetDayNum, teacherEmail = 'teacher@centneracademy.com') {
            try {
                const override = {
                    subject_key: lessonData.subjectKey,
                    lesson_code: lessonData.lessonCode,
                    original_day_key: lessonData.dayKey,
                    scheduled_date: targetDate,
                    day_type: targetDayType,
                    day_number: targetDayNum,
                    grade_level: lessonData.grade.toString(),
                    period_number: lessonData.period,
                    is_active: true,
                    created_by: teacherEmail
                };

                const { data, error } = await supabase
                    .from('lesson_schedule_overrides')
                    .insert([override])
                    .select();

                if (error) throw error;

                console.log('✅ Saved lesson override to database:', data);

                // Add to local cache
                if (data && data.length > 0) {
                    lessonOverrides.push(data[0]);
                }

                return { success: true, data };
            } catch (error) {
                console.error('Error saving lesson override:', error);
                return { success: false, error };
            }
        }

        async function clearLessonOverrides() {
            if (!confirm('🔄 Reset all lesson schedule changes?\n\nThis will remove all teacher modifications and restore the original curriculum.')) {
                return;
            }

            try {
                // Soft delete all overrides
                const { error } = await supabase
                    .from('lesson_schedule_overrides')
                    .update({ is_active: false })
                    .eq('is_active', true);

                if (error) throw error;

                lessonOverrides = [];
                alert('✅ All lesson schedule changes have been reset!');
                location.reload();
            } catch (error) {
                console.error('Error clearing overrides:', error);
                alert('❌ Failed to reset lesson schedules');
            }
        }

        // Migrate enhancement data when lesson is moved to a new date
        function migrateEnhancementData(oldKey, newKey) {
            const oldData = lessonEnhancements[oldKey];

            if (oldData) {
                // Copy all enhancement data to the new key
                lessonEnhancements[newKey] = {
                    notes: oldData.notes || '',
                    videos: oldData.videos || [],
                    docs: oldData.docs || [],
                    links: oldData.links || [],
                    aiContent: oldData.aiContent || {},
                    lastModified: new Date().toISOString()
                };

                // Save to localStorage
                localStorage.setItem('lessonEnhancements', JSON.stringify(lessonEnhancements));

                console.log(`✓ Migrated enhancement data from ${oldKey} to ${newKey}`);
                return true;
            }

            return false;
        }

        async function moveLessonToNewDay(lessonData, targetDate, targetDayType, targetDayNum) {
            // Prevent dropping on the same day
            if (targetDate === lessonData.date) {
                console.log('Dropped on the same day - no action needed');
                return;
            }

            const confirmMessage = `📚 Add Lesson to New Day?\n\n` +
                `Lesson: ${lessonData.lessonCode}\n` +
                `Subject: ${lessonData.subjectKey}\n` +
                `Period: ${lessonData.period}\n` +
                `Grade: ${lessonData.grade}\n\n` +
                `Adding to: ${new Date(targetDate).toLocaleDateString()} (Day ${targetDayNum} - ${targetDayType})\n\n` +
                `Note: This will ADD the lesson to the new day (not remove from original).\nContinue?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Calculate old and new enhancement keys
            const oldKey = `${lessonData.date}_${lessonData.subjectKey}_${lessonData.period}`;
            const newKey = `${targetDate}_${lessonData.subjectKey}_${lessonData.period}`;

            // Migrate enhancement data before saving
            const dataMigrated = migrateEnhancementData(oldKey, newKey);

            // Save to database
            const result = await saveLessonToDate(lessonData, targetDate, targetDayType, targetDayNum);

            if (result.success) {
                const migrationNote = dataMigrated ? '\n\n📝 All lesson notes, videos, docs, and AI content have been transferred to the new date.' : '';
                alert(`✅ Lesson Added!\n\n${lessonData.lessonCode} has been added to ${new Date(targetDate).toLocaleDateString()}\n\n💾 Saved to database - visible to all students${migrationNote}`);
                renderView();
            } else {
                alert(`❌ Failed to save lesson\n\nError: ${result.error?.message || 'Unknown error'}`);
            }
        }

        // Context menu for lesson options
        function showLessonContextMenu(event, lessonData) {
            event.preventDefault();
            event.stopPropagation();

            // Remove any existing context menu
            const existingMenu = document.getElementById('lessonContextMenu');
            if (existingMenu) existingMenu.remove();

            // Create context menu
            const menu = document.createElement('div');
            menu.id = 'lessonContextMenu';
            menu.style.cssText = `
                position: fixed;
                left: ${event.clientX}px;
                top: ${event.clientY}px;
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                padding: 8px;
                min-width: 200px;
            `;

            menu.innerHTML = `
                <div style="padding: 8px 12px; cursor: pointer; border-radius: 6px; transition: all 0.2s; font-weight: 500; color: #1f2937; display: flex; align-items: center; gap: 8px;"
                     onmouseover="this.style.background='#f3f4f6'"
                     onmouseout="this.style.background='transparent'"
                     onclick="stretchLesson(${JSON.stringify(lessonData).replace(/"/g, '&quot;')}); document.getElementById('lessonContextMenu').remove();">
                    <span>📅</span> Stretch Lesson Across Days
                </div>
                <div style="height: 1px; background: #e5e7eb; margin: 4px 0;"></div>
                <div style="padding: 8px 12px; cursor: pointer; border-radius: 6px; transition: all 0.2s; font-weight: 500; color: #dc2626; display: flex; align-items: center; gap: 8px;"
                     onmouseover="this.style.background='#fef2f2'"
                     onmouseout="this.style.background='transparent'"
                     onclick="removeLessonFromDay(${JSON.stringify(lessonData).replace(/"/g, '&quot;')}); document.getElementById('lessonContextMenu').remove();">
                    <span>🗑️</span> Remove From This Day
                </div>
            `;

            document.body.appendChild(menu);

            // Close menu when clicking outside
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 100);
        }

        async function removeLessonFromDay(lessonData) {
            if (!confirm(`Remove ${lessonData.lessonCode} from ${new Date(lessonData.date).toLocaleDateString()}?`)) {
                return;
            }

            try {
                // Find and deactivate the override
                const override = lessonOverrides.find(o =>
                    o.subject_key === lessonData.subjectKey &&
                    o.lesson_code === lessonData.lessonCode &&
                    o.scheduled_date === lessonData.date &&
                    o.period_number === lessonData.period
                );

                if (override) {
                    const { error } = await supabase
                        .from('lesson_schedule_overrides')
                        .update({ is_active: false })
                        .eq('id', override.id);

                    if (error) throw error;

                    // Remove from cache
                    lessonOverrides = lessonOverrides.filter(o => o.id !== override.id);
                    alert('✅ Lesson removed from this day');
                    renderView();
                } else {
                    alert('⚠️ Cannot remove original curriculum lessons.\n\nYou can only remove lessons that were added via drag-and-drop.');
                }
            } catch (error) {
                console.error('Error removing lesson:', error);
                alert('❌ Failed to remove lesson');
            }
        }

        // Function to stretch a lesson across multiple days
        async function stretchLesson(lessonData) {
            const daysInput = prompt('📅 Stretch Lesson Across Multiple Days\n\nHow many additional days should this lesson span?\n\nEnter a number (1-10):', '1');

            if (!daysInput) return;

            const daysToAdd = parseInt(daysInput);
            if (isNaN(daysToAdd) || daysToAdd < 1 || daysToAdd > 10) {
                alert('❌ Please enter a valid number between 1 and 10');
                return;
            }

            if (!confirm(`Stretch ${lessonData.lessonCode} across ${daysToAdd} additional day(s)?`)) {
                return;
            }

            try {
                let addedCount = 0;
                let currentDate = new Date(lessonData.date);

                for (let i = 0; i < daysToAdd; i++) {
                    // Move to next school day
                    do {
                        currentDate.setDate(currentDate.getDate() + 1);
                    } while (currentDate.getDay() === 0 || currentDate.getDay() === 6); // Skip weekends

                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayType = getABDay(dateStr);
                    if (!dayType) continue;

                    const dayNum = getDayNumber(dateStr, dayType);

                    const result = await saveLessonToDate(lessonData, dateStr, dayType, dayNum);
                    if (result.success) addedCount++;
                }

                alert(`✅ Lesson Stretched!\n\n${lessonData.lessonCode} added to ${addedCount} additional day(s)\n\n💾 Saved to database`);
                renderView();
            } catch (error) {
                console.error('Error stretching lesson:', error);
                alert('❌ Failed to stretch lesson');
            }
        }

        // ========================================
        // CHAT WITH AI ASSISTANT FUNCTIONS
        // ========================================

        let currentChatEnhancementKey = null;
        let chatHistory = [];

        function openLessonChat(enhancementKey) {
            currentChatEnhancementKey = enhancementKey;
            chatHistory = [];

            // Get lesson context - ensure it's properly set
            if (!window.currentEditingLesson) {
                alert('❌ Unable to open chat - lesson context not found. Please try reopening the lesson editor.');
                return;
            }

            const { lesson, subject: subjectName, grade } = window.currentEditingLesson;

            // Store chat-specific context so it persists across messages
            window.currentChatContext = {
                lesson: lesson,
                subject: subjectName,
                grade: grade,
                enhancementKey: enhancementKey
            };
            const enhancementContext = {
                notes: document.getElementById(`notes_${enhancementKey}`)?.value || '',
                videos: document.getElementById(`videos_${enhancementKey}`)?.value.split('\n').filter(v => v.trim()) || [],
                docs: document.getElementById(`docs_${enhancementKey}`)?.value.split('\n').filter(d => d.trim()) || [],
                links: document.getElementById(`links_${enhancementKey}`)?.value.split('\n').filter(l => l.trim()) || []
            };

            // Build context HTML
            const buildContextHTML = () => {
                let html = `<div style="padding: 20px; overflow-y: auto;">`;
                html += `<h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 1.1em; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">📚 Lesson Context</h3>`;

                html += `<div style="margin-bottom: 15px;">`;
                html += `<div style="color: #64748b; font-size: 0.85em; margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Title</div>`;
                html += `<div style="color: #1e293b; font-size: 0.95em; background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">${lesson.title || lesson.code || 'Untitled'}</div>`;
                html += `</div>`;

                html += `<div style="margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">`;
                html += `<div>`;
                html += `<div style="color: #64748b; font-size: 0.85em; margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Subject</div>`;
                html += `<div style="color: #1e293b; font-size: 0.95em; background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">${subjectName || 'N/A'}</div>`;
                html += `</div>`;
                html += `<div>`;
                html += `<div style="color: #64748b; font-size: 0.85em; margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Grade</div>`;
                html += `<div style="color: #1e293b; font-size: 0.95em; background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">${grade || 'N/A'}</div>`;
                html += `</div>`;
                html += `</div>`;

                if (lesson.objectives && lesson.objectives.length > 0) {
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="color: #64748b; font-size: 0.85em; margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Objectives</div>`;
                    html += `<div style="background: #f8f9fa; padding: 10px 12px; border-radius: 6px; font-size: 0.9em; color: #475569;">`;
                    lesson.objectives.forEach(obj => {
                        html += `<div style="margin-bottom: 4px;">• ${obj}</div>`;
                    });
                    html += `</div></div>`;
                }

                if (lesson.standards) {
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="color: #64748b; font-size: 0.85em; margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Standards</div>`;
                    html += `<div style="color: #1e293b; font-size: 0.9em; background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">${lesson.standards}</div>`;
                    html += `</div>`;
                }

                if (lesson.materials) {
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="color: #64748b; font-size: 0.85em; margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Materials</div>`;
                    html += `<div style="color: #1e293b; font-size: 0.9em; background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">${lesson.materials}</div>`;
                    html += `</div>`;
                }

                if (enhancementContext.notes) {
                    const noteId = 'currentNotes_' + Date.now();
                    const shouldTruncate = enhancementContext.notes.length > 300;
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="color: #64748b; font-size: 0.85em; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center;">
                        <span>Current Notes</span>
                        ${shouldTruncate ? `<button id="${noteId}_btn" onclick="toggleNotes('${noteId}')" style="background: #8b5cf6; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 0.75em; cursor: pointer; font-weight: 600;">Expand</button>` : ''}
                    </div>`;
                    html += `<div id="${noteId}" style="color: #1e293b; font-size: 0.9em; background: #fef3c7; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #f59e0b; max-height: 150px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6;" data-full-text="${encodeURIComponent(enhancementContext.notes)}" data-expanded="false">${enhancementContext.notes.substring(0, 300)}${shouldTruncate ? '...' : ''}</div>`;
                    html += `</div>`;
                }

                if (enhancementContext.videos.length > 0) {
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="color: #64748b; font-size: 0.85em; margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Video Resources (${enhancementContext.videos.length})</div>`;
                    html += `<div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; font-size: 0.85em; color: #475569; max-height: 100px; overflow-y: auto;">`;
                    enhancementContext.videos.slice(0, 3).forEach(v => {
                        html += `<div style="margin-bottom: 3px;">🎥 ${v.substring(0, 40)}...</div>`;
                    });
                    if (enhancementContext.videos.length > 3) {
                        html += `<div style="color: #8b5cf6; font-weight: 600;">+${enhancementContext.videos.length - 3} more</div>`;
                    }
                    html += `</div></div>`;
                }

                html += `</div>`;
                return html;
            };

            // Create chat modal with two columns
            const modal = document.createElement('div');
            modal.id = 'chatModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                z-index: 10003;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.2s ease-out;
                backdrop-filter: blur(4px);
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; width: 95%; max-width: 1400px; height: 90vh; display: flex; box-shadow: 0 25px 80px rgba(0,0,0,0.4); animation: slideUp 0.3s ease-out; overflow: hidden;">
                    <!-- Left Column: Lesson Context -->
                    <div style="width: 35%; background: #ffffff; border-right: 2px solid #e5e7eb; display: flex; flex-direction: column;">
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; padding: 15px 20px;">
                            <h3 style="margin: 0; font-size: 1.1em;">📝 Editing Lesson</h3>
                        </div>
                        <div id="lessonContextPanel">
                            ${buildContextHTML()}
                        </div>
                    </div>

                    <!-- Right Column: Chat -->
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <!-- Chat Header -->
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0; font-size: 1.3em;">💬 AI Assistant</h2>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; opacity: 0.9;">Ask questions, refine content, get suggestions</p>
                            </div>
                            <button onclick="closeLessonChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.3em; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                ×
                            </button>
                        </div>

                        <!-- Chat Messages Area -->
                        <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                            <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                                <div style="font-size: 3em; margin-bottom: 15px;">🤖</div>
                                <p style="font-size: 1.1em; margin-bottom: 10px;">Hi! I'm your AI lesson assistant.</p>
                                <p style="font-size: 0.95em;">Ask me to help refine your lesson, add activities, create assessments, or anything else!</p>
                                <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                    <button onclick="sendQuickPrompt('Make this lesson more engaging for students')" style="background: white; border: 2px solid #e5e7eb; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='#e5e7eb'">
                                        ✨ Make it more engaging
                                    </button>
                                    <button onclick="sendQuickPrompt('Add more real-world examples')" style="background: white; border: 2px solid #e5e7eb; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='#e5e7eb'">
                                        🌍 Add real-world examples
                                    </button>
                                    <button onclick="sendQuickPrompt('Suggest hands-on activities')" style="background: white; border: 2px solid #e5e7eb; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='#e5e7eb'">
                                        🎯 Suggest activities
                                    </button>
                                    <button onclick="sendQuickPrompt('How can I differentiate this lesson?')" style="background: white; border: 2px solid #e5e7eb; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='#e5e7eb'">
                                        🎓 Differentiation ideas
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Input Area with File Upload & Links -->
                        <div style="padding: 20px; background: white; border-top: 2px solid #e5e7eb;">
                            <!-- Attachments Display -->
                            <div id="chatAttachments" style="display: none; margin-bottom: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-weight: 600; color: #64748b; font-size: 0.85em; margin-bottom: 8px;">📎 ATTACHMENTS</div>
                                <div id="attachmentsList" style="display: flex; flex-direction: column; gap: 8px;"></div>
                            </div>

                            <!-- Attachment Controls -->
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <button onclick="document.getElementById('fileUploadInput').click()" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'">
                                    📄 Upload File
                                </button>
                                <button onclick="toggleLinkInput()" style="background: white; border: 2px solid #0ea5e9; color: #0369a1; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#0369a1'">
                                    🔗 Add Link
                                </button>
                                <button onclick="toggleStudentSubmissions()" style="background: white; border: 2px solid #10b981; color: #047857; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#10b981'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#047857'">
                                    👥 Student Work
                                </button>
                            </div>

                            <!-- Hidden File Input -->
                            <input type="file" id="fileUploadInput" multiple accept=".pdf,.doc,.docx,.txt,.csv,.json,.png,.jpg,.jpeg" style="display: none;" onchange="handleFileUpload(event)">

                            <!-- Link Input Area (Hidden by default) -->
                            <div id="linkInputArea" style="display: none; margin-bottom: 12px; padding: 12px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                                <div style="font-weight: 600; color: #0369a1; font-size: 0.85em; margin-bottom: 8px;">Add Resource Link</div>
                                <div style="display: flex; gap: 8px;">
                                    <input type="url" id="linkUrlInput" placeholder="https://example.com/resource" style="flex: 1; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9em;">
                                    <input type="text" id="linkLabelInput" placeholder="Link label (optional)" style="width: 200px; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9em;">
                                    <button onclick="addLink()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Add
                                    </button>
                                    <button onclick="toggleLinkInput()" style="background: #e5e7eb; color: #64748b; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Cancel
                                    </button>
                                </div>
                            </div>

                            <!-- Student Submissions Panel (Hidden by default) -->
                            <div id="studentSubmissionsPanel" style="display: none; margin-bottom: 12px; padding: 16px; background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                                <div style="font-weight: 700; color: #047857; font-size: 1em; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>📚 Student Submissions</span>
                                    <button onclick="toggleStudentSubmissions()" style="background: transparent; border: none; color: #64748b; cursor: pointer; font-size: 1.2em;">✕</button>
                                </div>
                                <div id="studentSubmissionsList">
                                    <p style="color: #64748b; font-size: 0.9em; text-align: center; padding: 20px;">
                                        No student submissions yet. Students will submit their work through the student portal.
                                    </p>
                                </div>
                            </div>

                            <!-- Main Message Input -->
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="chatInput" placeholder="Type your message..." style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; transition: all 0.2s;" onfocus="this.style.borderColor='#8b5cf6'" onblur="this.style.borderColor='#e5e7eb'" onkeypress="if(event.key === 'Enter') sendChatMessage()">
                                <button onclick="sendChatMessage()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)'">
                                    Send →
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('chatInput').focus();
        }

        function closeLessonChat() {
            const modal = document.getElementById('chatModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => document.body.removeChild(modal), 200);
            }
            currentChatEnhancementKey = null;
            chatHistory = [];
        }

        function toggleNotes(noteId) {
            const notesDiv = document.getElementById(noteId);
            const btn = document.getElementById(noteId + '_btn');
            const isExpanded = notesDiv.getAttribute('data-expanded') === 'true';

            if (isExpanded) {
                // Collapse - show truncated
                const fullText = decodeURIComponent(notesDiv.getAttribute('data-full-text'));
                notesDiv.textContent = fullText.substring(0, 300) + '...';
                notesDiv.style.maxHeight = '150px';
                btn.textContent = 'Expand';
                notesDiv.setAttribute('data-expanded', 'false');
            } else {
                // Expand - show full content
                const fullText = decodeURIComponent(notesDiv.getAttribute('data-full-text'));
                notesDiv.textContent = fullText;
                notesDiv.style.maxHeight = 'none';
                btn.textContent = 'Collapse';
                notesDiv.setAttribute('data-expanded', 'true');
            }
        }

        function sendQuickPrompt(message) {
            document.getElementById('chatInput').value = message;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Clear input
            input.value = '';

            // Add user message to chat
            addChatMessage('user', message);

            // Add to history
            chatHistory.push({
                role: 'user',
                content: message
            });

            // Show loading indicator
            const loadingId = addChatMessage('assistant', '...');

            try {
                // Get lesson context from chat-specific storage
                if (!window.currentChatContext) {
                    console.error('❌ Chat context not initialized');
                    throw new Error('Chat context not initialized');
                }

                const { lesson, subject: subjectName, grade } = window.currentChatContext;

                // Debug logging
                console.log('📤 Sending chat message with context:', {
                    hasLesson: !!lesson,
                    hasSubject: !!subjectName,
                    hasGrade: !!grade,
                    lessonKeys: lesson ? Object.keys(lesson) : 'N/A'
                });

                if (!lesson) {
                    console.error('❌ Lesson object is missing from chat context');
                    throw new Error('Lesson data not available');
                }

                // Gather enhancement context
                const enhancementContext = {
                    notes: document.getElementById(`notes_${currentChatEnhancementKey}`)?.value || '',
                    videos: document.getElementById(`videos_${currentChatEnhancementKey}`)?.value.split('\n').filter(v => v.trim()) || [],
                    docs: document.getElementById(`docs_${currentChatEnhancementKey}`)?.value.split('\n').filter(d => d.trim()) || [],
                    links: document.getElementById(`links_${currentChatEnhancementKey}`)?.value.split('\n').filter(l => l.trim()) || []
                };

                // Call chat serverless function
                const response = await fetch('/.netlify/functions/chat-with-lesson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lesson: {
                            title: lesson.title || lesson.code || 'Untitled Lesson',
                            code: lesson.code || '',
                            objectives: lesson.objectives || [],
                            subject: subjectName,
                            grade: grade,
                            standards: lesson.standards || '',
                            materials: lesson.materials || '',
                            activities: lesson.activities || [],
                            assessment: lesson.assessment || '',
                            notes: enhancementContext.notes || '',
                            videoUrls: enhancementContext.videos || [],
                            documentUrls: enhancementContext.docs || [],
                            additionalLinks: enhancementContext.links || []
                        },
                        chatHistory: chatHistory,
                        attachments: {
                            files: chatAttachments.files || [],
                            links: chatAttachments.links || [],
                            studentWork: chatAttachments.studentWork || []
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('❌ Chat API error:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorData: errorData
                    });
                    throw new Error(errorData.error || errorData.debug || `Chat service error (${response.status})`);
                }

                const data = await response.json();

                // Remove loading indicator
                removeChatMessage(loadingId);

                // Add assistant response
                addChatMessage('assistant', data.response, true);

                // Add to history
                chatHistory.push({
                    role: 'assistant',
                    content: data.response
                });

            } catch (error) {
                console.error('Chat error:', error);
                removeChatMessage(loadingId);
                addChatMessage('assistant', '❌ Sorry, I encountered an error. Please try again.');
            }
        }

        function addChatMessage(role, content, canApply = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now();

            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.cssText = `
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
                align-items: ${role === 'user' ? 'flex-end' : 'flex-start'};
                animation: slideIn 0.2s ease-out;
            `;

            const bubble = document.createElement('div');
            bubble.style.cssText = `
                max-width: 75%;
                padding: 12px 16px;
                border-radius: ${role === 'user' ? '16px 16px 4px 16px' : '16px 16px 16px 4px'};
                background: ${role === 'user' ? 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)' : 'white'};
                color: ${role === 'user' ? 'white' : '#1e293b'};
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                line-height: 1.6;
                word-wrap: break-word;
            `;

            if (content === '...') {
                bubble.innerHTML = `
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <div class="typing-dot" style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%; animation: typingDot 1.4s infinite;"></div>
                        <div class="typing-dot" style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%; animation: typingDot 1.4s infinite 0.2s;"></div>
                        <div class="typing-dot" style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%; animation: typingDot 1.4s infinite 0.4s;"></div>
                    </div>
                `;
            } else {
                // For assistant messages, render markdown
                if (role === 'assistant') {
                    const textId = messageId + '_text';
                    // Use marked.js to parse markdown
                    const renderedHtml = marked.parse(content);
                    bubble.innerHTML = `<div id="${textId}" class="chat-markdown" data-markdown="${escapeHtml(content)}">${renderedHtml}</div>`;
                } else {
                    // User messages stay as plain text
                    bubble.textContent = content;
                }
            }

            messageDiv.appendChild(bubble);

            // Add Edit and Apply buttons for assistant messages
            if (canApply && role === 'assistant') {
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = 'margin-top: 8px; display: flex; gap: 8px;';

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.textContent = '✏️ Edit';
                editBtn.style.cssText = `
                    background: #6366f1;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 0.9em;
                    transition: all 0.2s;
                    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
                `;

                let isEditing = false;
                const textId = messageId + '_text';

                editBtn.onclick = function() {
                    const textDiv = document.getElementById(textId);
                    if (!isEditing) {
                        // Enter edit mode - convert to textarea with original markdown
                        const currentMarkdown = textDiv.getAttribute('data-markdown') || textDiv.textContent;
                        const textarea = document.createElement('textarea');
                        textarea.id = textId + '_textarea';
                        textarea.value = currentMarkdown;
                        textarea.style.cssText = `
                            width: 100%;
                            min-height: 150px;
                            padding: 8px;
                            border: 2px solid #6366f1;
                            border-radius: 8px;
                            font-family: inherit;
                            font-size: 0.95em;
                            line-height: 1.6;
                            resize: vertical;
                            background: #f8f9fa;
                            color: #1e293b;
                        `;
                        textDiv.replaceWith(textarea);
                        textarea.focus();
                        editBtn.textContent = '💾 Save';
                        editBtn.style.background = '#10b981';
                        isEditing = true;
                    } else {
                        // Exit edit mode - convert back to div with rendered markdown
                        const textarea = document.getElementById(textId + '_textarea');
                        const updatedMarkdown = textarea.value;
                        const newDiv = document.createElement('div');
                        newDiv.id = textId;
                        newDiv.className = 'chat-markdown';
                        newDiv.setAttribute('data-markdown', updatedMarkdown);
                        newDiv.innerHTML = marked.parse(updatedMarkdown);
                        textarea.replaceWith(newDiv);
                        editBtn.textContent = '✏️ Edit';
                        editBtn.style.background = '#6366f1';
                        isEditing = false;
                    }
                };

                editBtn.onmouseover = function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = isEditing ? '0 4px 12px rgba(16, 185, 129, 0.4)' : '0 4px 12px rgba(99, 102, 241, 0.4)';
                };
                editBtn.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = isEditing ? '0 2px 8px rgba(16, 185, 129, 0.3)' : '0 2px 8px rgba(99, 102, 241, 0.3)';
                };

                // Apply button
                const applyBtn = document.createElement('button');
                applyBtn.textContent = '📋 Apply to Lesson Notes';
                applyBtn.style.cssText = `
                    background: #10b981;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 0.9em;
                    transition: all 0.2s;
                    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                `;
                applyBtn.onmouseover = function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
                };
                applyBtn.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.3)';
                };
                applyBtn.onclick = function() {
                    // Get current content (whether in edit mode or not)
                    let contentToApply;
                    const textareaElement = document.getElementById(textId + '_textarea');
                    if (textareaElement) {
                        // In edit mode
                        contentToApply = textareaElement.value;
                    } else {
                        // Not in edit mode - get markdown from data attribute
                        const textElement = document.getElementById(textId);
                        contentToApply = textElement.getAttribute('data-markdown') || textElement.textContent;
                    }
                    applyChatToLesson(contentToApply);
                };

                buttonContainer.appendChild(editBtn);
                buttonContainer.appendChild(applyBtn);
                messageDiv.appendChild(buttonContainer);
            }

            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return messageId;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function removeChatMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }

        function applyChatToLesson(content) {
            const notesField = document.getElementById(`notes_${currentChatEnhancementKey}`);
            if (!notesField) return;

            const separator = notesField.value.trim() ? '\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n' : '';
            const header = `✨ AI CHAT SUGGESTION\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n`;

            notesField.value = notesField.value + separator + header + content;

            // Update markdown preview
            updateMarkdownPreview(currentChatEnhancementKey);

            // Show success message
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10004; animation: slideIn 0.3s ease-out;';
            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">✅</span>
                    <span style="font-weight: 600;">Applied to lesson notes!</span>
                </div>
            `;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => document.body.removeChild(successDiv), 300);
            }, 2000);

            // Scroll to notes field
            notesField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ========================================
        // ASSIGN TO STUDENTS FUNCTIONALITY
        // ========================================

        // Global variable to store student roster
        let studentRoster = {
            students: {},
            period1: { A: {}, B: {} },
            period2: { A: {}, B: {} },
            period3: { A: {}, B: {} },
            period4: { A: {}, B: {} }
        };

        /**
         * Load all active students from Supabase
         */
        async function loadStudentRoster() {
            try {
                const { data: students, error } = await supabase
                    .from('centner_students')
                    .select('*')
                    .eq('is_active', true);

                if (error) {
                    console.error('Error loading student roster:', error);
                    return;
                }

                students.forEach(student => {
                    studentRoster.students[student.id] = {
                        id: student.id,
                        firstName: student.first_name,
                        lastName: student.last_name,
                        email: student.email,
                        grade: student.grade_level
                    };
                });

                console.log(`✅ Loaded ${students.length} students into roster`);
            } catch (error) {
                console.error('Failed to load student roster:', error);
            }
        }

        /**
         * Get students enrolled in a specific period and subject
         * @param {string} period - Period number (1, 2, 3, or 4)
         * @param {string} dayType - Day type ('A' or 'B' or 'R' for both)
         * @param {string} subjectKey - Subject key like '7th_civics' or '9th_math'
         * @returns {Array} Array of student objects
         */
        function getStudentsByPeriod(period, dayType, subjectKey) {
            // Extract grade level from subject key (e.g., '7th_civics' -> 7)
            const gradeMatch = subjectKey.match(/^(\d+)(th|rd|nd|st)_/);
            const targetGrade = gradeMatch ? parseInt(gradeMatch[1]) : null;

            if (!targetGrade || !studentRoster.students) {
                console.warn('No target grade found or roster not loaded');
                return Object.values(studentRoster.students || {});
            }

            // Filter students by grade level
            const enrolledStudents = Object.values(studentRoster.students)
                .filter(student => {
                    // Handle grade as either string or number
                    const studentGrade = typeof student.grade === 'string'
                        ? parseInt(student.grade.match(/\d+/)?.[0] || 0)
                        : parseInt(student.grade);

                    return studentGrade === targetGrade;
                });

            console.log(`Found ${enrolledStudents.length} students in grade ${targetGrade}`);
            return enrolledStudents;
        }

        // Global variable to store current assignment context
        let currentAssignmentContext = null;

        /**
         * Open the Assign to Students modal
         */
        async function openAssignModal(enhancementKey, lessonData, subjectInfo, period, grade, dateStr) {
            const modal = document.getElementById('assignModal');
            const modalBody = document.getElementById('assignModalBody');

            // Store context for later use
            currentAssignmentContext = {
                enhancementKey,
                lessonData,
                subjectInfo,
                period,
                grade,
                dateStr,
                lessonKey: enhancementKey
            };

            // Get enhancement data (quiz, if available)
            const enhancement = lessonEnhancements[enhancementKey] || {};

            // Get enrolled students for this period
            const enrolledStudents = getStudentsByPeriod(period, 'R', subjectInfo.key) || [];

            // Format date for display
            const date = new Date(dateStr + 'T12:00:00');
            const dateFormatted = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Build modal HTML
            const html = `
                <h2 style="color: #0ea5e9; margin-bottom: 10px; display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.3em;">📚</span> Assign to Students
                </h2>
                <h3 style="color: ${subjectInfo.color}; margin-top: 12px; font-size: 1.1em;">
                    ${dateFormatted} - Period ${period} - ${subjectInfo.subject}
                </h3>

                <div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin: 20px 0; border-left: 4px solid ${subjectInfo.color};">
                    <div style="font-weight: 600; color: #1e293b; font-size: 1.05em; margin-bottom: 4px;">
                        ${lessonData.title || lessonData.code || 'Lesson'}
                    </div>
                    <div style="color: #64748b; font-size: 0.9em;">
                        ${lessonData.code ? `Lesson Code: ${lessonData.code}` : ''}
                    </div>
                </div>

                <div class="form-group">
                    <label style="font-weight: 700; color: #1e293b; margin-bottom: 12px; display: block;">Assignment Type</label>
                    <div class="assignment-type-selector">
                        <div class="assignment-type-btn ${enhancement.quiz ? 'selected' : ''}" data-type="quiz" onclick="selectAssignmentType('quiz')" ${!enhancement.quiz ? 'style="opacity: 0.5; cursor: not-allowed;" title="No quiz available"' : ''}>
                            <span class="icon">📝</span><span>Quiz</span>
                        </div>
                        <div class="assignment-type-btn" data-type="homework" onclick="selectAssignmentType('homework')">
                            <span class="icon">📖</span><span>Homework</span>
                        </div>
                        <div class="assignment-type-btn" data-type="reading" onclick="selectAssignmentType('reading')">
                            <span class="icon">📄</span><span>Reading</span>
                        </div>
                        <div class="assignment-type-btn" data-type="video" onclick="selectAssignmentType('video')">
                            <span class="icon">🎬</span><span>Video</span>
                        </div>
                        <div class="assignment-type-btn" data-type="activity" onclick="selectAssignmentType('activity')">
                            <span class="icon">🎯</span><span>Activity</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="assignmentTitle" style="font-weight: 700; color: #1e293b;">Assignment Title</label>
                    <input type="text" id="assignmentTitle" placeholder="Enter assignment title..." value="${lessonData.title || lessonData.code || ''}" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>

                <div class="form-group">
                    <label for="assignmentInstructions" style="font-weight: 700; color: #1e293b;">Instructions</label>
                    <textarea id="assignmentInstructions" rows="4" placeholder="Enter instructions for students..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical;"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="assignmentDueDate" style="font-weight: 700; color: #1e293b;">Due Date</label>
                        <input type="date" id="assignmentDueDate" value="${dateStr}" min="${dateStr}" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    </div>
                    <div class="form-group">
                        <label for="assignmentDueTime" style="font-weight: 700; color: #1e293b;">Due Time</label>
                        <input type="time" id="assignmentDueTime" value="23:59" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="assignmentPoints" style="font-weight: 700; color: #1e293b;">Points Possible</label>
                    <input type="number" id="assignmentPoints" value="100" min="1" max="1000" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                </div>

                <div id="quizQuestionsSection" style="display: none;">
                    <div class="quiz-questions-preview">
                        <h4 style="color: #92400e; margin-bottom: 16px;">📋 Quiz Questions</h4>
                        <div id="quizQuestionsPreview"></div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 24px;">
                    <label style="font-weight: 700; color: #1e293b; margin-bottom: 12px; display: block;">Select Students (${enrolledStudents.length} enrolled)</label>
                    ${enrolledStudents.length > 0 ? `
                        <div class="select-all-students" onclick="toggleSelectAllStudents()">
                            <input type="checkbox" id="selectAllStudents">
                            <label for="selectAllStudents" style="font-weight: 600; color: #0369a1; margin: 0; cursor: pointer;">Select All Students</label>
                            <span id="selectedCount" style="margin-left: auto; color: #64748b; font-weight: 600;">0 selected</span>
                        </div>
                        <div class="student-checkbox-grid">
                            ${enrolledStudents.map(student => `
                                <label class="student-checkbox-item">
                                    <input type="checkbox" class="student-checkbox" data-student-id="${student.id}" onchange="updateSelectedCount()">
                                    <div class="student-info">
                                        <div class="student-name">${student.firstName} ${student.lastName || ''}</div>
                                        <div class="student-email">${student.email || 'No email'}</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="padding: 40px; text-align: center; background: #fef2f2; border: 2px solid #fecaca; border-radius: 12px;">
                            <div style="font-size: 3em; margin-bottom: 12px;">👥</div>
                            <div style="color: #991b1b; font-weight: 600;">No Students Enrolled</div>
                        </div>
                    `}
                </div>

                <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid #e2e8f0; display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn-save secondary" onclick="closeAssignModal()" style="background: #6c757d; padding: 12px 24px;">Cancel</button>
                    <button class="btn-save" onclick="submitAssignment()" ${enrolledStudents.length === 0 ? 'disabled style="opacity: 0.5;"' : ''} style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); padding: 12px 32px;">
                        📤 Assign to Students
                    </button>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.add('active');

            if (enhancement.quiz) {
                selectAssignmentType('quiz');
            }
        }

        function closeAssignModal() {
            document.getElementById('assignModal').classList.remove('active');
            currentAssignmentContext = null;
        }

        function selectAssignmentType(type) {
            document.querySelectorAll('.assignment-type-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedBtn = document.querySelector(`.assignment-type-btn[data-type="${type}"]`);
            if (selectedBtn && !selectedBtn.style.opacity) {
                selectedBtn.classList.add('selected');
                const quizSection = document.getElementById('quizQuestionsSection');
                if (type === 'quiz' && currentAssignmentContext) {
                    const enhancement = lessonEnhancements[currentAssignmentContext.enhancementKey] || {};
                    if (enhancement.quiz) {
                        quizSection.style.display = 'block';
                        displayQuizQuestions(enhancement.quiz, document.getElementById('quizQuestionsPreview'));
                    }
                } else {
                    quizSection.style.display = 'none';
                }
            }
        }

        function displayQuizQuestions(quizData, container) {
            try {
                let questions = [];
                if (typeof quizData === 'string') {
                    try {
                        questions = JSON.parse(quizData).questions || [];
                    } catch (e) {
                        questions = parseQuizText(quizData);
                    }
                } else if (quizData.questions) {
                    questions = quizData.questions;
                }
                if (questions.length === 0) {
                    container.innerHTML = '<p style="color: #64748b;">No questions available</p>';
                    return;
                }
                const html = questions.map((q, i) => `
                    <div class="quiz-question-item">
                        <div class="question-text">${i + 1}. ${q.question || q.text || 'Question'}</div>
                        ${q.options ? `<div class="answer-options">${q.options.map((opt, oi) => `
                            <div class="answer-option ${oi === q.correct || opt.isCorrect ? 'correct' : ''}">
                                ${String.fromCharCode(65 + oi)}. ${opt.text || opt}
                                ${oi === q.correct || opt.isCorrect ? ' ✓' : ''}
                            </div>
                        `).join('')}</div>` : ''}
                    </div>
                `).join('');
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<p style="color: #dc2626;">Error loading questions</p>';
            }
        }

        function parseQuizText(text) {
            const questions = [];
            text.split(/\d+\./).filter(b => b.trim()).forEach(block => {
                const lines = block.trim().split('\n').filter(l => l.trim());
                if (lines.length > 0) {
                    const q = { question: lines[0].trim(), options: [], correct: -1 };
                    lines.slice(1).forEach(line => {
                        const m = line.match(/^[A-D][.)]\s*(.+?)(\s*\(correct\))?$/i);
                        if (m) {
                            q.options.push(m[1].trim());
                            if (m[2]) q.correct = q.options.length - 1;
                        }
                    });
                    if (q.options.length > 0) questions.push(q);
                }
            });
            return questions;
        }

        function toggleSelectAllStudents() {
            const all = document.getElementById('selectAllStudents');
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = all.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.student-checkbox:checked');
            const count = document.getElementById('selectedCount');
            const all = document.getElementById('selectAllStudents');
            const total = document.querySelectorAll('.student-checkbox');
            if (count) count.textContent = `${selected.length} selected`;
            if (all) all.checked = selected.length === total.length && total.length > 0;
        }

        async function submitAssignment() {
            if (!currentAssignmentContext) return alert('Error: Assignment context not found');
            const selectedTypeBtn = document.querySelector('.assignment-type-btn.selected');
            if (!selectedTypeBtn) return alert('⚠️ Please select an assignment type');
            const assignmentType = selectedTypeBtn.getAttribute('data-type');
            const title = document.getElementById('assignmentTitle').value.trim();
            const instructions = document.getElementById('assignmentInstructions').value.trim();
            const dueDate = document.getElementById('assignmentDueDate').value;
            const dueTime = document.getElementById('assignmentDueTime').value;
            const pointsPossible = parseInt(document.getElementById('assignmentPoints').value);
            const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.getAttribute('data-student-id'));

            if (!title) return alert('⚠️ Please enter an assignment title');
            if (!dueDate) return alert('⚠️ Please select a due date');
            if (selectedStudents.length === 0) return alert('⚠️ Please select at least one student');

            const dueDateTimeISO = `${dueDate}T${dueTime}:00Z`;
            let quizData = null;
            if (assignmentType === 'quiz') {
                const enhancement = lessonEnhancements[currentAssignmentContext.enhancementKey] || {};
                if (enhancement.quiz) {
                    quizData = typeof enhancement.quiz === 'string' ? enhancement.quiz : JSON.stringify(enhancement.quiz);
                }
            }

            const payload = {
                lesson_key: currentAssignmentContext.lessonKey,
                assignment_type: assignmentType,
                title: title,
                description: currentAssignmentContext.lessonData.title || '',
                instructions: instructions || null,
                points_possible: pointsPossible,
                due_date: dueDateTimeISO,
                student_ids: selectedStudents,
                quiz_data: quizData,
                metadata: {
                    lesson_code: currentAssignmentContext.lessonData.code,
                    subject: currentAssignmentContext.subjectInfo.subject,
                    period: currentAssignmentContext.period,
                    grade: currentAssignmentContext.grade,
                    date: currentAssignmentContext.dateStr
                }
            };

            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div style="font-size: 1.4em; color: #667eea; font-weight: 700; margin-bottom: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        📤 Creating Assignments
                    </div>
                    <div style="font-size: 1.1em; color: #0369a1; font-weight: 600; margin-bottom: 8px;">
                        Assigning to ${selectedStudents.length} student${selectedStudents.length !== 1 ? 's' : ''}...
                    </div>
                    <div style="color: #64748b; font-size: 0.95em;">Setting up assignments and notifications...</div>
                </div>
            `;
            document.body.appendChild(loadingOverlay);

            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) throw new Error('Not authenticated');

                const response = await fetch('/.netlify/functions/assign-to-students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                document.body.removeChild(loadingOverlay);

                if (response.ok && result.success) {
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 32px 48px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 10001; text-align: center;';
                    successDiv.innerHTML = `
                        <div style="font-size: 4em; margin-bottom: 16px;">✅</div>
                        <div style="font-size: 1.4em; font-weight: 700; margin-bottom: 12px;">Assignment Created!</div>
                        <div style="font-size: 1.1em;">Successfully assigned to ${result.assignments_created} student${result.assignments_created !== 1 ? 's' : ''}</div>
                    `;
                    document.body.appendChild(successDiv);
                    setTimeout(() => {
                        document.body.removeChild(successDiv);
                        closeAssignModal();
                    }, 2500);
                } else {
                    alert(`❌ Error: ${result.error || result.message || 'Unknown error'}`);
                }
            } catch (error) {
                document.body.removeChild(loadingOverlay);
                alert(`❌ Error: ${error.message}`);
            }
        }

        // ========================================
        // GRADING DASHBOARD FUNCTIONS
        // ========================================

        let currentSubmissions = [];
        let currentGradingSubmission = null;

        // Load all submissions with filters
        async function loadSubmissions() {
            const loader = document.getElementById('gradingLoader');
            const submissionsList = document.getElementById('submissionsList');

            loader.style.display = 'flex';

            try {
                // Get filter values
                const status = document.getElementById('gradingStatusFilter').value;
                const gradeLevel = document.getElementById('gradingGradeLevelFilter')?.value || 'all';
                const subject = document.getElementById('gradingSubjectFilter').value;
                const type = document.getElementById('gradingTypeFilter').value;
                const sort = document.getElementById('gradingSortFilter').value;

                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }

                // Build query
                let query = supabase
                    .from('student_assignments')
                    .select(`
                        *,
                        students:student_id (
                            first_name,
                            last_name,
                            email,
                            grade_level
                        )
                    `);

                // Apply filters
                if (status !== 'all') {
                    query = query.eq('status', status);
                }
                if (subject !== 'all') {
                    query = query.eq('subject_key', subject);
                }
                if (type !== 'all') {
                    query = query.eq('assignment_type', type);
                }

                // Apply sorting
                const sortColumn = sort === 'student_name' ? 'student_id' : sort;
                query = query.order(sortColumn, { ascending: true });

                const { data, error } = await query;

                if (error) throw error;

                let filteredData = data || [];

                // Apply grade-level filter client-side (since it's on the joined student table)
                if (gradeLevel !== 'all') {
                    filteredData = filteredData.filter(submission => {
                        return submission.students?.grade_level === gradeLevel;
                    });
                }

                currentSubmissions = filteredData;

                // Update stats
                updateGradingStats(currentSubmissions);

                // Render submissions
                renderSubmissions(currentSubmissions);

            } catch (error) {
                console.error('Error loading submissions:', error);
                submissionsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <div class="empty-state-title">Error Loading Submissions</div>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                loader.style.display = 'none';
            }
        }

        // Update statistics display
        function updateGradingStats(submissions) {
            const pending = submissions.filter(s => s.status === 'submitted').length;
            const graded = submissions.filter(s => s.status === 'graded').length;
            const late = submissions.filter(s => {
                if (!s.submitted_at || !s.due_date) return false;
                return new Date(s.submitted_at) > new Date(s.due_date);
            }).length;

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('gradedCount').textContent = graded;
            document.getElementById('lateCount').textContent = late;
        }

        // Render submissions list - ORGANIZED BY STUDENT, THEN BY SUBJECT
        function renderSubmissions(submissions) {
            const container = document.getElementById('submissionsList');

            if (submissions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-title">No Submissions Found</div>
                        <p>There are no submissions matching your current filters.</p>
                    </div>
                `;
                return;
            }

            // GROUP BY STUDENT FIRST
            const studentGroups = {};

            submissions.forEach(submission => {
                const student = submission.students;
                const studentId = submission.student_id;
                const studentName = student ? `${student.first_name} ${student.last_name}` : 'Unknown Student';

                if (!studentGroups[studentId]) {
                    studentGroups[studentId] = {
                        name: studentName,
                        email: student?.email || '',
                        gradeLevel: student?.grade_level || '',
                        subjects: {},
                        totalSubmissions: 0,
                        pendingCount: 0,
                        gradedCount: 0
                    };
                }

                // GROUP BY SUBJECT WITHIN EACH STUDENT
                const subjectKey = submission.subject_key || 'No subject';
                if (!studentGroups[studentId].subjects[subjectKey]) {
                    studentGroups[studentId].subjects[subjectKey] = [];
                }

                studentGroups[studentId].subjects[subjectKey].push(submission);
                studentGroups[studentId].totalSubmissions++;

                if (submission.status === 'submitted') {
                    studentGroups[studentId].pendingCount++;
                } else if (submission.status === 'graded') {
                    studentGroups[studentId].gradedCount++;
                }
            });

            // RENDER STUDENT GROUPS
            let html = '';

            Object.keys(studentGroups).sort((a, b) => {
                const nameA = studentGroups[a].name;
                const nameB = studentGroups[b].name;
                return nameA.localeCompare(nameB);
            }).forEach(studentId => {
                const group = studentGroups[studentId];

                html += `
                    <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <!-- STUDENT HEADER -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.4em; font-weight: 700; color: #1f2937;">
                                    👤 ${group.name}
                                </h3>
                                <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 0.95em;">
                                    ${group.email} ${group.gradeLevel ? `• ${group.gradeLevel} Grade` : ''}
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2em; font-weight: 600; color: #ea580c; margin-bottom: 4px;">
                                    ${group.totalSubmissions} submission${group.totalSubmissions !== 1 ? 's' : ''}
                                </div>
                                <div style="font-size: 0.9em; color: #6b7280;">
                                    <span style="color: #f59e0b;">${group.pendingCount} pending</span> •
                                    <span style="color: #10b981;">${group.gradedCount} graded</span>
                                </div>
                            </div>
                        </div>

                        <!-- SUBJECTS FOR THIS STUDENT -->
                        ${Object.keys(group.subjects).sort().map(subjectKey => {
                            const subjectSubmissions = group.subjects[subjectKey];

                            return `
                                <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                    <div style="font-weight: 600; color: #374151; font-size: 1.1em; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                        📚 ${subjectKey} <span style="color: #6b7280; font-size: 0.85em;">(${subjectSubmissions.length} assignment${subjectSubmissions.length !== 1 ? 's' : ''})</span>
                                    </div>

                                    ${subjectSubmissions.map(submission => {
                                        const isLate = submission.submitted_at && submission.due_date &&
                                                       new Date(submission.submitted_at) > new Date(submission.due_date);
                                        const submittedDate = submission.submitted_at ?
                                            new Date(submission.submitted_at).toLocaleDateString() : 'Not submitted';
                                        const dueDate = submission.due_date ?
                                            new Date(submission.due_date).toLocaleDateString() : 'No due date';

                                        return `
                                            <div class="submission-card ${isLate ? 'late' : ''}"
                                                 onclick="openGradingModal('${submission.id}')"
                                                 style="margin-bottom: 12px; cursor: pointer; transition: all 0.2s;"
                                                 onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                                                 onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                                                <div class="submission-header">
                                                    <div>
                                                        <div class="submission-title">${submission.title || 'Untitled Assignment'}</div>
                                                    </div>
                                                    <div style="text-align: right;">
                                                        <span class="badge ${submission.assignment_type || 'homework'}">${submission.assignment_type || 'Homework'}</span>
                                                        <br>
                                                        <span class="badge ${submission.status}" style="margin-top: 8px; display: inline-block;">
                                                            ${submission.status}
                                                        </span>
                                                        ${isLate ? '<br><span class="badge late" style="margin-top: 8px; display: inline-block;">LATE</span>' : ''}
                                                    </div>
                                                </div>
                                                <div class="submission-meta">
                                                    <div class="meta-item">
                                                        <span class="meta-icon">📅</span>
                                                        <span>Due: ${dueDate}</span>
                                                    </div>
                                                    <div class="meta-item">
                                                        <span class="meta-icon">✅</span>
                                                        <span>Submitted: ${submittedDate}</span>
                                                    </div>
                                                    <div class="meta-item">
                                                        <span class="meta-icon">🎯</span>
                                                        <span>${submission.points_possible || 100} points possible</span>
                                                    </div>
                                                    ${submission.status === 'graded' ? `
                                                        <div class="meta-item">
                                                            <span class="meta-icon">📊</span>
                                                            <span>Grade: ${submission.points_earned || 0}/${submission.points_possible || 100}</span>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Open grading modal for a specific submission
        async function openGradingModal(submissionId) {
            const modal = document.getElementById('gradingModal');
            const modalContent = document.getElementById('gradingModalContent');

            modal.classList.add('active');

            // Show loading state
            modalContent.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading submission details...</p>
                </div>
            `;

            try {
                // Fetch full submission details
                const { data: submission, error } = await supabase
                    .from('student_assignments')
                    .select(`
                        *,
                        students:student_id (
                            first_name,
                            last_name,
                            email,
                            grade_level
                        )
                    `)
                    .eq('id', submissionId)
                    .single();

                if (error) throw error;

                currentGradingSubmission = submission;

                // Render grading interface
                renderGradingInterface(submission);

            } catch (error) {
                console.error('Error loading submission:', error);
                modalContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <div class="empty-state-title">Error Loading Submission</div>
                        <p>${error.message}</p>
                        <button onclick="closeGradingModal()" class="grade-btn" style="margin-top: 20px;">Close</button>
                    </div>
                `;
            }
        }

        // Render the grading interface in the modal
        function renderGradingInterface(submission) {
            const modalContent = document.getElementById('gradingModalContent');
            const student = submission.students;
            const studentName = student ? `${student.first_name} ${student.last_name}` : 'Unknown Student';
            const isQuiz = submission.assignment_type === 'quiz';
            const hasRubric = submission.rubric_data && Object.keys(submission.rubric_data).length > 0;

            // Parse submission content
            let submissionContent = submission.submission_content || {};
            if (typeof submissionContent === 'string') {
                try {
                    submissionContent = JSON.parse(submissionContent);
                } catch (e) {
                    submissionContent = { text: submissionContent };
                }
            }

            // Calculate auto-score for quiz
            let autoScore = null;
            if (isQuiz && submissionContent.answers) {
                const quizData = submission.quiz_data || {};
                let correct = 0;
                let total = Object.keys(submissionContent.answers).length;

                Object.entries(submissionContent.answers).forEach(([questionId, answer]) => {
                    const question = quizData.questions?.find(q => q.id === questionId);
                    if (question && answer === question.correct_answer) {
                        correct++;
                    }
                });

                autoScore = total > 0 ? ((correct / total) * (submission.points_possible || 100)).toFixed(2) : 0;
            }

            const initialPoints = submission.points_earned !== null ? submission.points_earned : (autoScore || (submission.points_possible || 100));

            modalContent.innerHTML = `
                <div class="grading-modal-header">
                    <div class="grading-modal-title">Grade Submission: ${submission.title || 'Untitled'}</div>
                    <div style="color: #64748b; font-size: 0.95em; margin-top: 8px;">
                        <strong>Student:</strong> ${studentName}
                        ${student?.grade_level ? `(${student.grade_level}th Grade)` : ''}
                        | <strong>Subject:</strong> ${submission.subject_key || 'N/A'}
                    </div>
                </div>

                <div class="grading-sections">
                    <!-- LEFT SECTION: Submission Content -->
                    <div class="grading-section">
                        <div class="section-title">
                            <span>📄</span> Submission
                        </div>

                        ${submission.instructions ? `
                            <div style="background: #fffbeb; border: 2px solid #fbbf24; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                <strong>Instructions:</strong><br>
                                ${submission.instructions}
                            </div>
                        ` : ''}

                        ${autoScore !== null ? `
                            <div class="auto-score-display">
                                <div class="auto-score-label">Auto-Calculated Score</div>
                                <div class="auto-score-value">${autoScore} / ${submission.points_possible || 100}</div>
                            </div>
                        ` : ''}

                        <div class="submission-content" id="submissionContent">
                            ${renderSubmissionContent(submission, submissionContent)}
                        </div>
                    </div>

                    <!-- RIGHT SECTION: Grading Tools -->
                    <div class="grading-section">
                        <div class="section-title">
                            <span>✍️</span> Grade & Feedback
                        </div>

                        <!-- Points Input -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                                Points Earned
                            </label>
                            <div class="points-input-group">
                                <div class="points-input">
                                    <input
                                        type="range"
                                        class="points-slider"
                                        id="pointsSlider"
                                        min="0"
                                        max="${submission.points_possible || 100}"
                                        value="${initialPoints}"
                                        step="0.5"
                                        oninput="updatePointsDisplay(this.value, ${submission.points_possible || 100})"
                                    />
                                </div>
                                <div class="points-display" id="pointsDisplay">
                                    ${initialPoints} / ${submission.points_possible || 100}
                                </div>
                            </div>
                            <div class="letter-grade" id="letterGrade">
                                ${calculateLetterGrade((initialPoints / (submission.points_possible || 100)) * 100)}
                            </div>
                            ${autoScore !== null && Math.abs(autoScore - initialPoints) > 0.1 ? `
                                <div class="override-notice">
                                    ⚠️ You are overriding the auto-calculated score
                                </div>
                            ` : ''}
                        </div>

                        ${hasRubric ? `
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                                    Rubric Scores
                                </label>
                                <div class="rubric-criteria" id="rubricCriteria">
                                    ${renderRubric(submission.rubric_data)}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Feedback -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                                Teacher Feedback
                            </label>
                            <textarea
                                class="feedback-textarea"
                                id="feedbackText"
                                placeholder="Provide constructive feedback for the student..."
                            >${submission.feedback || ''}</textarea>
                        </div>

                        <!-- Previous Feedback (if graded) -->
                        ${submission.status === 'graded' && submission.feedback ? `
                            <div style="background: #f0fdf4; border: 2px solid #10b981; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                <strong style="color: #059669;">Previous Feedback:</strong><br>
                                <div style="margin-top: 8px; color: #064e3b;">${submission.feedback}</div>
                            </div>
                        ` : ''}

                        <!-- Submit Button -->
                        <button
                            class="submit-grade-btn"
                            onclick="submitGrade('${submission.id}')"
                            id="submitGradeBtn"
                        >
                            ${submission.status === 'graded' ? '🔄 Update Grade' : '✅ Submit Grade'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Render submission content based on type
        function renderSubmissionContent(submission, content) {
            const type = submission.assignment_type;

            // Quiz submissions
            if (type === 'quiz' && content.answers) {
                const quizData = submission.quiz_data || {};
                const questions = quizData.questions || [];

                return questions.map((question, index) => {
                    const studentAnswer = content.answers[question.id];
                    const isCorrect = studentAnswer === question.correct_answer;

                    return `
                        <div class="quiz-question ${isCorrect ? 'correct' : 'incorrect'}">
                            <div class="question-text">
                                ${index + 1}. ${question.text}
                            </div>
                            <div class="answer-row">
                                <span style="font-weight: 600;">Student Answer:</span>
                                <span style="color: ${isCorrect ? '#059669' : '#dc2626'};">
                                    ${studentAnswer || 'No answer'} ${isCorrect ? '✅' : '❌'}
                                </span>
                            </div>
                            ${!isCorrect ? `
                                <div class="answer-row">
                                    <span style="font-weight: 600;">Correct Answer:</span>
                                    <span style="color: #059669;">${question.correct_answer} ✓</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            // File submissions
            if (content.files && content.files.length > 0) {
                return content.files.map(file => {
                    const fileIcon = getFileIcon(file.type || file.name);
                    const fileSize = formatFileSize(file.size);

                    return `
                        <a href="${file.url}" target="_blank" class="file-preview" style="text-decoration: none;">
                            <div class="file-icon">${fileIcon}</div>
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${fileSize}</div>
                            </div>
                            <span style="color: #ea580c; font-weight: 600;">View →</span>
                        </a>
                    `;
                }).join('');
            }

            // Text submissions
            if (content.text || typeof content === 'string') {
                const text = content.text || content;
                return `
                    <div style="white-space: pre-wrap; line-height: 1.8; color: #334155;">
                        ${text}
                    </div>
                `;
            }

            return `
                <div class="empty-state">
                    <div class="empty-state-icon">📄</div>
                    <p>No submission content available</p>
                </div>
            `;
        }

        // Render rubric criteria
        function renderRubric(rubricData) {
            if (!rubricData || typeof rubricData !== 'object') return '';

            return Object.entries(rubricData).map(([key, criterion]) => {
                const max = criterion.max || 10;
                const current = criterion.score || 0;

                return `
                    <div class="rubric-criterion">
                        <div class="criterion-header">
                            <span class="criterion-name">${criterion.name || key}</span>
                            <span class="criterion-score" id="rubric_${key}_display">${current}/${max}</span>
                        </div>
                        <input
                            type="range"
                            class="points-slider"
                            id="rubric_${key}"
                            min="0"
                            max="${max}"
                            value="${current}"
                            step="0.5"
                            oninput="updateRubricScore('${key}', this.value, ${max})"
                        />
                        ${criterion.description ? `
                            <div style="margin-top: 8px; font-size: 0.85em; color: #64748b;">
                                ${criterion.description}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update points display when slider changes
        function updatePointsDisplay(value, max) {
            document.getElementById('pointsDisplay').textContent = `${value} / ${max}`;
            const percentage = (value / max) * 100;
            document.getElementById('letterGrade').textContent = calculateLetterGrade(percentage);
        }

        // Update rubric score display
        function updateRubricScore(key, value, max) {
            document.getElementById(`rubric_${key}_display`).textContent = `${value}/${max}`;
        }

        // Calculate letter grade from percentage
        function calculateLetterGrade(percentage) {
            if (percentage >= 90) return 'A';
            if (percentage >= 80) return 'B';
            if (percentage >= 70) return 'C';
            if (percentage >= 60) return 'D';
            return 'F';
        }

        // Get file icon based on file type
        function getFileIcon(type) {
            const typeMap = {
                'pdf': '📄',
                'doc': '📝',
                'docx': '📝',
                'txt': '📋',
                'jpg': '🖼️',
                'jpeg': '🖼️',
                'png': '🖼️',
                'gif': '🖼️',
                'mp4': '🎥',
                'mp3': '🎵',
                'zip': '📦',
                'default': '📎'
            };

            const ext = type.toLowerCase().split('.').pop();
            return typeMap[ext] || typeMap['default'];
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Submit grade to database
        async function submitGrade(submissionId) {
            const submitBtn = document.getElementById('submitGradeBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Submitting...';

            try {
                const submission = currentGradingSubmission;
                const pointsEarned = parseFloat(document.getElementById('pointsSlider').value);
                const feedback = document.getElementById('feedbackText').value;

                // Collect rubric scores if present
                let rubricScores = {};
                if (submission.rubric_data) {
                    Object.keys(submission.rubric_data).forEach(key => {
                        const input = document.getElementById(`rubric_${key}`);
                        if (input) {
                            rubricScores[key] = {
                                score: parseFloat(input.value),
                                max: parseFloat(input.max)
                            };
                        }
                    });
                }

                // Get auth token
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    throw new Error('Not authenticated');
                }

                // Call serverless function to grade assignment
                const response = await fetch('/.netlify/functions/grade-assignment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        submission_id: submissionId,
                        points_earned: pointsEarned,
                        feedback: feedback,
                        rubric_scores: Object.keys(rubricScores).length > 0 ? rubricScores : null,
                        return_to_student: true
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to submit grade');
                }

                // Show success message
                showSuccessMessage(`Grade submitted successfully! ${result.letter_grade} (${result.percentage}%)`);

                // Close modal and refresh submissions
                closeGradingModal();
                loadSubmissions();

            } catch (error) {
                console.error('Error submitting grade:', error);
                alert(`Error: ${error.message}`);
                submitBtn.disabled = false;
                submitBtn.textContent = '✅ Submit Grade';
            }
        }

        // Show success message
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                font-weight: 600;
                font-size: 1.1em;
            `;
            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.5em;">✅</span>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => document.body.removeChild(successDiv), 300);
            }, 3000);
        }

        // Close grading modal
        function closeGradingModal() {
            document.getElementById('gradingModal').classList.remove('active');
            currentGradingSubmission = null;
        }

        // Add event listeners to filter dropdowns
        document.addEventListener('DOMContentLoaded', () => {
            ['gradingStatusFilter', 'gradingSubjectFilter', 'gradingTypeFilter', 'gradingSortFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', loadSubmissions);
                }
            });
        });
    </script>
    <style>
        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
    </style>
</body>
</html>
